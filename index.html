<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Helper Quiz</title>
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Load Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- 3. Tailwind Dark Mode Config -->
    <script>
        tailwind.config = {
            darkMode: 'class', // Enable class-based dark mode
        }
    </script>
    
    <!-- 4. Custom Styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Custom transition for screens */
        .screen {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }

        .screen.hidden {
            opacity: 0;
            transform: scale(0.98);
            pointer-events: none; /* Prevent interaction when hidden */
            display: none; /* Use display none to remove from layout */
        }
        
        /* Custom styles for answer buttons */
        .option-btn.correct {
            @apply bg-green-100 border-green-500 text-green-800 font-semibold dark:bg-green-900/50 dark:border-green-700 dark:text-green-300;
        }
        .option-btn.incorrect {
            @apply bg-red-100 border-red-500 text-red-800 font-semibold dark:bg-red-900/50 dark:border-red-700 dark:text-red-300;
        }

        /* Style for the progress bar transition */
        #progress-bar-inner {
            transition: width 0.5s ease-out;
        }

        /* A subtle animation for elements fading in */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        /* Custom styles for admin list items */
        #admin-subject-list li, #question-edit-list li {
            @apply p-3 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-md flex justify-between items-center;
        }
        
        /* Table styles */
        #history-table th, #history-table td {
            @apply p-3 text-left;
        }
        #history-table th {
            @apply bg-slate-100 dark:bg-slate-700;
        }
        #history-table tr {
            @apply border-b border-slate-200 dark:border-slate-700;
        }
        #history-table tr:last-child {
            @apply border-b-0;
        }
        
        /* Scrollbar styles for dark mode */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; /* slate-100 */
        }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8; /* slate-400 */
            border-radius: 4px;
        }
        html.dark ::-webkit-scrollbar-track {
            background: #1e293b; /* slate-800 */
        }
        html.dark ::-webkit-scrollbar-thumb {
            background: #475569; /* slate-600 */
        }

        /* Hidden file input */
        .hidden-file-input {
            width: 0.1px;
            height: 0.1px;
            opacity: 0;
            overflow: hidden;
            position: absolute;
            z-index: -1;
        }
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 min-h-screen flex items-center justify-center p-4 transition-colors duration-300">

    <!-- Main Container Card -->
    <div class="w-full max-w-3xl bg-white dark:bg-slate-800 rounded-xl shadow-xl p-6 sm:p-10 relative">

        <!-- Dark Mode Toggle Button -->
        <button id="theme-toggle-btn" class="absolute top-4 right-4 p-2 rounded-full text-slate-500 hover:bg-slate-100 dark:text-slate-400 dark:hover:bg-slate-700 transition-colors">
            <!-- Sun Icon (visible in light mode) -->
            <svg id="theme-icon-light" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
            <!-- Moon Icon (visible in dark mode) -->
            <svg id="theme-icon-dark" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
        </button>

        <!-- ===== SCREEN 1: Start Screen ===== -->
        <div id="start-screen" class="screen text-slate-800 dark:text-slate-200">
            <h1 class="text-3xl font-extrabold text-center mb-2">Study Helper Quiz</h1>
            <p class="text-center text-slate-500 dark:text-slate-400 mb-8">Select your topic and start practicing!</p>

            <!-- Subject Cards Container -->
            <div class="mb-6">
                <h2 class="text-xl font-semibold mb-4">Your Subjects</h2>
                <div id="subject-cards-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-60 overflow-y-auto pr-2">
                    <!-- Subject cards will be populated by JavaScript -->
                    <!-- Example Card Structure:
                    <div class="p-4 bg-slate-50 dark:bg-slate-700 rounded-lg shadow-sm border border-slate-200 dark:border-slate-600">
                        <h3 class="font-bold text-lg text-indigo-600 dark:text-indigo-400">Subject Name</h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mb-3">10 questions</p>
                        <div class="flex gap-2">
                            <button class="flex-1 bg-indigo-600 text-white py-2 px-3 text-sm rounded-md font-semibold hover:bg-indigo-700">Start Quiz</button>
                            <button class="bg-red-500 text-white p-2 text-sm rounded-md font-semibold hover:bg-red-600">Del</button>
                        </div>
                    </div>
                    -->
                </div>
                <p id="no-subjects-msg" class="text-slate-500 dark:text-slate-400 hidden">No subjects found. Go to "Manage Question Bank" to add one!</p>
            </div>
            
            <!-- Quiz Settings -->
            <div class="space-y-6 bg-slate-50 dark:bg-slate-700/50 p-4 rounded-lg border dark:border-slate-700">
                <h2 class="text-xl font-semibold mb-2">Quiz Settings</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Number of Questions Selection -->
                    <div>
                        <label for="question-count-select" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Number of Questions</label>
                        <select id="question-count-select" class="w-full p-3 border border-slate-300 dark:border-slate-600 dark:bg-slate-700 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="5">5 Questions</option>
                            <option value="10">10 Questions</option>
                            <option value="all">All Questions</option>
                        </select>
                    </div>
                    
                    <!-- Time per Question Selection -->
                    <div>
                        <label for="time-limit-select" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Time per Question</label>
                        <select id="time-limit-select" class="w-full p-3 border border-slate-300 dark:border-slate-600 dark:bg-slate-700 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="unlimited">Unlimited</option>
                            <option value="10">10 Seconds</option>
                            <option value="20" selected>20 Seconds</option>
                            <option value="30">30 Seconds</option>
                        </select>
                    </div>
                </div>
                <div class="flex items-center">
                    <input id="show-timer-toggle" type="checkbox" class="h-4 w-4 text-indigo-600 border-slate-300 dark:border-slate-600 rounded focus:ring-indigo-500">
                    <label for="show-timer-toggle" class="ml-2 block text-sm text-slate-700 dark:text-slate-300">Show Timer During Quiz</label>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="grid grid-cols-2 gap-4 mt-6">
                <button id="manage-bank-btn" class="w-full bg-slate-600 text-white py-3 px-6 rounded-lg font-semibold shadow-md hover:bg-slate-700 transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-slate-300">
                    Manage Question Bank
                </button>
                <button id="view-history-btn" class="w-full bg-indigo-600 text-white py-3 px-6 rounded-lg font-semibold shadow-md hover:bg-indigo-700 transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-indigo-300">
                    ðŸ“Š Quiz History
                </button>
            </div>
            
            <!-- Last Score Display -->
            <div class="text-center mt-8">
                <p class="text-slate-500 dark:text-slate-400">Your last score: <span id="last-score" class="font-bold text-slate-700 dark:text-slate-300">N/A</span></p>
            </div>
        </div>

        <!-- ===== SCREEN 2: Quiz Screen ===== -->
        <div id="quiz-screen" class="screen hidden text-slate-800 dark:text-slate-200">
            <!-- Header: Timer & Score -->
            <div class="flex justify-between items-center mb-4">
                <div id="timer" class="text-lg font-bold text-indigo-600 dark:text-indigo-400">Time: 00:00</div>
                <div id="score" class="text-lg font-bold text-green-600 dark:text-green-400">Score: 0</div>
            </div>

            <!-- Progress Bar -->
            <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2.5 mb-6">
                <div id="progress-bar-inner" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div>
            </div>

            <!-- Question Container -->
            <div id="question-container" class="mb-6">
                <h2 id="question-text" class="text-2xl font-semibold mb-6 min-h-[70px]">
                    <!-- Question text goes here -->
                </h2>
                <div id="options-container" class="space-y-3">
                    <!-- Option buttons go here -->
                </div>
            </div>

            <!-- Feedback Message -->
            <p id="feedback-message" class="text-center font-medium min-h-[2em] mb-4"></p>

            <!-- Next Button -->
            <button id="next-btn" class="w-full bg-slate-700 text-white py-3 px-6 rounded-lg font-semibold text-lg shadow-md hover:bg-slate-800 transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-slate-300 hidden">
                Next Question
            </button>
        </div>

        <!-- ===== SCREEN 3: Results Screen ===== -->
        <div id="results-screen" class="screen hidden text-slate-800 dark:text-slate-200">
            <h1 class="text-3xl font-bold text-center mb-4">Quiz Complete!</h1>
            
            <div class="bg-slate-100 dark:bg-slate-700 rounded-lg p-6 text-center mb-6">
                <p class="text-lg text-slate-600 dark:text-slate-300">Your final score is:</p>
                <h2 id="final-score" class="text-5xl font-bold text-indigo-600 dark:text-indigo-400 my-2">0 / 0</h2>
                <p id="percentage" class="text-2xl font-semibold text-green-600 dark:text-green-400">0%</p>
            </div>

            <!-- Performance Insights -->
            <div id="performance-insights" class="mb-6">
                <h3 class="text-xl font-semibold mb-3">Performance Insights</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-center">
                    <div class="bg-slate-50 dark:bg-slate-700 p-3 rounded-lg">
                        <p class="text-sm text-slate-500 dark:text-slate-400">Fastest Answer</p>
                        <p id="fastest-answer" class="text-lg font-semibold">N/A</p>
                    </div>
                    <div class="bg-slate-50 dark:bg-slate-700 p-3 rounded-lg">
                        <p class="text-sm text-slate-500 dark:text-slate-400">Weekly Accuracy</p>
                        <p id="weekly-accuracy" class="text-lg font-semibold">N/A</p>
                    </div>
                    <div class="bg-slate-50 dark:bg-slate-700 p-3 rounded-lg">
                        <p class="text-sm text-slate-500 dark:text-slate-400">Strongest Subject</p>
                        <p id="strongest-subject" class="text-lg font-semibold">N/A</p>
                    </div>
                </div>
            </div>

            <!-- Show Correct Answers Section -->
            <div id="results-summary-container" class="mb-6">
                <h3 class="text-xl font-semibold mb-3">Review Your Answers:</h3>
                <div id="results-summary" class="space-y-4 max-h-60 overflow-y-auto pr-2">
                    <!-- Results summary goes here -->
                </div>
            </div>

            <!-- Restart Button -->
            <button id="restart-btn" class="w-full bg-indigo-600 text-white py-3 px-6 rounded-lg font-semibold text-lg shadow-md hover:bg-indigo-700 transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-indigo-300">
                Practice Again
            </button>
        </div>

        <!-- ===== SCREEN 4: Admin Panel Screen ===== -->
        <div id="admin-screen" class="screen hidden text-slate-800 dark:text-slate-200">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-extrabold">Question Bank</h1>
                <button id="admin-back-btn" class="bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-200 py-2 px-4 rounded-lg font-semibold hover:bg-slate-300 dark:hover:bg-slate-600 transition-all">
                    Back to Quiz
                </button>
            </div>

            <!-- Admin Feedback / Confirmation Area -->
            <div id="admin-feedback" class="text-center font-medium min-h-[2em] mb-4 p-3 rounded-lg"></div>

            <!-- All sections are now in a single column -->
            <div class="space-y-8">
                
                <!-- Section 1: Manage Subjects -->
                <div class="bg-slate-50 dark:bg-slate-700/50 p-5 rounded-lg border dark:border-slate-700">
                    <h3 class="text-xl font-semibold mb-4 text-slate-700 dark:text-slate-300">Manage Subjects</h3>
                    
                    <!-- Add Subject -->
                    <div class="mb-4">
                        <label for="new-subject-name" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Add New Subject</label>
                        <div class="flex gap-2">
                            <input type="text" id="new-subject-name" placeholder="Enter new subject name" class="w-full p-2 border border-slate-300 dark:border-slate-600 dark:bg-slate-700 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <button id="add-subject-btn" class="bg-indigo-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-indigo-700">Add</button>
                        </div>
                    </div>

                    <!-- View/Edit Subjects -->
                    <div>
                        <h4 class="text-lg font-semibold mb-2 text-slate-700 dark:text-slate-300">All Subjects</h4>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mb-3">Click a subject's name to view its questions. Click [Edit] to rename.</p>
                        <ul id="admin-subject-list" class="space-y-2 max-h-48 overflow-y-auto pr-2">
                            <!-- Subject list will be populated by JavaScript -->
                        </ul>
                    </div>
                </div>

                <!-- Section 2: Edit Questions Panel (Hidden by default) -->
                <div id="edit-questions-panel" class="bg-slate-50 dark:bg-slate-700/50 p-5 rounded-lg border dark:border-slate-700 hidden">
                    <h3 id="edit-questions-title" class="text-xl font-semibold mb-4 text-slate-700 dark:text-slate-300">Edit Questions</h3>
                    <ul id="question-edit-list" class="space-y-2 max-h-60 overflow-y-auto pr-2">
                        <!-- Question list will be populated by JavaScript -->
                    </ul>
                </div>

                <!-- Section 3: Add / Edit Question Form -->
                <div class="bg-slate-50 dark:bg-slate-700/50 p-5 rounded-lg border dark:border-slate-700 space-y-4">
                    <h3 id="question-form-title" class="text-xl font-semibold text-slate-700 dark:text-slate-300">Add New Question</h3>
                    
                    <input type="hidden" id="editing-question-index" value="-1">

                    <div>
                        <label for="admin-subject-select" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Select Subject</label>
                        <select id="admin-subject-select" class="w-full p-2 border border-slate-300 dark:border-slate-600 dark:bg-slate-700 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <!-- Options will be populated by JavaScript -->
                        </select>
                    </div>

                    <div>
                        <label for="admin-question-text" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Question</label>
                        <textarea id="admin-question-text" rows="2" placeholder="What is...?" class="w-full p-2 border border-slate-300 dark:border-slate-600 dark:bg-slate-700 rounded-lg focus:ring-2 focus:ring-indigo-500"></textarea>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label for="admin-option-1" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Option 1 (Correct Answer)</label>
                            <input type="text" id="admin-option-1" placeholder="The Correct Answer" class="w-full p-2 border border-slate-300 dark:border-slate-600 dark:bg-slate-700 rounded-lg focus:ring-2 focus:ring-green-500">
                        </div>
                        <div>
                            <label for="admin-option-2" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Option 2</label>
                            <input type="text" id="admin-option-2" placeholder="Wrong Answer 1" class="w-full p-2 border border-slate-300 dark:border-slate-600 dark:bg-slate-700 rounded-lg">
                        </div>
                        <div>
                            <label for="admin-option-3" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Option 3</label>
                            <input type="text" id="admin-option-3" placeholder="Wrong Answer 2" class="w-full p-2 border border-slate-300 dark:border-slate-600 dark:bg-slate-700 rounded-lg">
                        </div>
                        <div>
                            <label for="admin-option-4" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Option 4</label>
                            <input type="text" id="admin-option-4" placeholder="Wrong Answer 3" class="w-full p-2 border border-slate-300 dark:border-slate-600 dark:bg-slate-700 rounded-lg">
                        </div>
                    </div>
                    <p class="text-xs text-slate-500 dark:text-slate-400 -mt-2">Note: For simplicity, **Option 1** is always the correct answer when adding/editing.</p>


                    <div class="flex gap-3">
                        <button id="save-question-btn" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold shadow-md hover:bg-green-700">
                            Save Question
                        </button>
                        <button id="cancel-edit-btn" class="w-full bg-slate-200 dark:bg-slate-600 text-slate-800 dark:text-slate-200 py-3 rounded-lg font-semibold hover:bg-slate-300 dark:hover:bg-slate-500 hidden">
                            Cancel Edit
                        </button>
                    </div>
                </div>

                <!-- Section 4: Import/Export Section -->
                <div class="mt-8 border-t dark:border-slate-700 pt-6">
                    <h3 class="text-xl font-semibold text-slate-700 dark:text-slate-300 mb-4">Import / Export Data</h3>
                    
                    <!-- File Inputs -->
                    <input type="file" id="import-subject-file" class="hidden-file-input" accept=".json">
                    <input type="file" id="import-backup-file" class="hidden-file-input" accept=".json">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Import -->
                        <div class="flex flex-col space-y-3">
                            <label id="import-subject-file-btn" for="import-subject-file" class="w-full text-center bg-orange-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-orange-600 cursor-pointer">Import Subject (.json)</label>
                            <label id="import-backup-file-btn" for="import-backup-file" class="w-full text-center bg-orange-700 text-white py-2 px-4 rounded-lg font-semibold hover:bg-orange-800 cursor-pointer">Import Full Backup (.json)</label>
                        </div>
                        <!-- Export -->
                        <div class="flex flex-col space-y-3">
                            <button id="export-subject-btn" class="w-full bg-indigo-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-indigo-600">Export Selected Subject</button>
                            <button id="export-backup-btn" class="w-full bg-indigo-700 text-white py-2 px-4 rounded-lg font-semibold hover:bg-indigo-800">Export Full Backup</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ===== SCREEN 5: History Screen ===== -->
        <div id="history-screen" class="screen hidden text-slate-800 dark:text-slate-200">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-extrabold">Quiz History</h1>
                <button id="history-back-btn" class="bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-200 py-2 px-4 rounded-lg font-semibold hover:bg-slate-300 dark:hover:bg-slate-600 transition-all">
                    Back to Home
                </button>
            </div>
            
            <div class="flex justify-between items-center mb-4">
                <div class="flex gap-2">
                    <label for="sort-history-by" class="text-sm font-medium">Sort by:</label>
                    <select id="sort-history-by" class="text-sm p-1 border border-slate-300 dark:border-slate-600 dark:bg-slate-700 rounded-md">
                        <option value="date_desc">Date (Newest)</option>
                        <option value="date_asc">Date (Oldest)</option>
                        <option value="score_desc">Score (Highest)</option>
                        <option value="score_asc">Score (Lowest)</option>
                    </select>
                </div>
                <button id="clear-history-btn" class="bg-red-600 text-white py-1 px-3 rounded-lg font-semibold text-sm hover:bg-red-700">
                    Clear All History
                </button>
            </div>
            
            <!-- History Table -->
            <div id="history-table-container" class="w-full max-h-96 overflow-y-auto rounded-lg border dark:border-slate-700">
                <table id="history-table" class="w-full">
                    <thead class="sticky top-0">
                        <tr>
                            <th class="w-2/5">Subject</th>
                            <th class="w-1/5">Score</th>
                            <th class="w-2/5">Date</th>
                        </tr>
                    </thead>
                    <tbody id="history-table-body">
                        <!-- History rows will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            <p id="no-history-msg" class="text-center text-slate-500 dark:text-slate-400 mt-6 hidden">No quiz history found. Complete a quiz to see your results!</p>
        </div>

    </div>

    <!-- ===== JavaScript ===== -->
    <script type="module">
        // --- 1. LOCAL STORAGE KEYS ---
        const DB_KEY = 'quizDataBank';
        const HISTORY_KEY = 'quizHistory';
        const SETTINGS_KEY = 'quizSettings';
        const THEME_KEY = 'theme';

        // --- 2. DOM Element References ---
        const allScreens = document.querySelectorAll('.screen');
        const startScreen = document.getElementById('start-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const resultsScreen = document.getElementById('results-screen');
        const adminScreen = document.getElementById('admin-screen');
        const historyScreen = document.getElementById('history-screen');

        // Theme
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const themeIconLight = document.getElementById('theme-icon-light');
        const themeIconDark = document.getElementById('theme-icon-dark');

        // Start Screen
        const subjectCardsContainer = document.getElementById('subject-cards-container');
        const noSubjectsMsg = document.getElementById('no-subjects-msg');
        const questionCountSelect = document.getElementById('question-count-select');
        const timeLimitSelect = document.getElementById('time-limit-select');
        const showTimerToggle = document.getElementById('show-timer-toggle');
        const manageBankBtn = document.getElementById('manage-bank-btn');
        const viewHistoryBtn = document.getElementById('view-history-btn');
        const lastScoreDisplay = document.getElementById('last-score');

        // Quiz Screen
        const timerDisplay = document.getElementById('timer');
        const scoreDisplay = document.getElementById('score');
        const progressBarInner = document.getElementById('progress-bar-inner');
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const feedbackMessage = document.getElementById('feedback-message');
        const nextBtn = document.getElementById('next-btn');

        // Results Screen
        const finalScore = document.getElementById('final-score');
        const percentageDisplay = document.getElementById('percentage');
        const resultsSummary = document.getElementById('results-summary');
        const restartBtn = document.getElementById('restart-btn');
        const fastestAnswer = document.getElementById('fastest-answer');
        const weeklyAccuracy = document.getElementById('weekly-accuracy');
        const strongestSubject = document.getElementById('strongest-subject');

        // Admin Screen
        const adminBackBtn = document.getElementById('admin-back-btn');
        const adminFeedback = document.getElementById('admin-feedback');
        const newSubjectName = document.getElementById('new-subject-name');
        const addSubjectBtn = document.getElementById('add-subject-btn');
        const adminSubjectList = document.getElementById('admin-subject-list');
        const editQuestionsPanel = document.getElementById('edit-questions-panel');
        const editQuestionsTitle = document.getElementById('edit-questions-title');
        const questionEditList = document.getElementById('question-edit-list');
        const questionFormTitle = document.getElementById('question-form-title');
        const adminSubjectSelect = document.getElementById('admin-subject-select');
        const adminQuestionText = document.getElementById('admin-question-text');
        const adminOption1 = document.getElementById('admin-option-1');
        const adminOption2 = document.getElementById('admin-option-2');
        const adminOption3 = document.getElementById('admin-option-3');
        const adminOption4 = document.getElementById('admin-option-4');
        const saveQuestionBtn = document.getElementById('save-question-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const editingQuestionIndex = document.getElementById('editing-question-index');
        const importSubjectFileInput = document.getElementById('import-subject-file');
        const importBackupFileInput = document.getElementById('import-backup-file');
        const exportSubjectBtn = document.getElementById('export-subject-btn');
        const exportBackupBtn = document.getElementById('export-backup-btn');

        // History Screen
        const historyBackBtn = document.getElementById('history-back-btn');
        const sortHistoryBy = document.getElementById('sort-history-by');
        const clearHistoryBtn = document.getElementById('clear-history-btn');
        const historyTableBody = document.getElementById('history-table-body');
        const noHistoryMsg = document.getElementById('no-history-msg');

        // --- 3. State Variables ---
        let quizData;
        let quizHistory;
        let quizSettings;
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let currentSubjectName = '';
        let score = 0;
        let timerInterval;
        let timePerQuestion = 20; // in seconds
        let timeRemaining = 0;
        let timeElapsed = 0;
        let isTimerVisible = true;
        let questionStartTime = 0;
        let answerTimes = [];
        let userAnswers = [];

        // --- 4. Core Functions ---
        
        /**
         * Initializes the application
         */
        function init() {
            loadTheme();
            loadSettings();
            loadData();
            loadHistory();

            populateSubjectCards();
            updateLastScore();

            addEventListeners();
        }

        /**
         * Adds all application event listeners
         */
        function addEventListeners() {
            // Theme
            themeToggleBtn.addEventListener('click', toggleTheme);

            // Screen Navigation
            manageBankBtn.addEventListener('click', showAdminPanel);
            viewHistoryBtn.addEventListener('click', showHistoryPanel);
            adminBackBtn.addEventListener('click', () => showScreen(startScreen));
            historyBackBtn.addEventListener('click', () => showScreen(startScreen));
            restartBtn.addEventListener('click', restartQuiz);

            // Quiz Logic
            nextBtn.addEventListener('click', nextQuestion);
            
            // Settings
            questionCountSelect.addEventListener('change', saveSettings);
            timeLimitSelect.addEventListener('change', saveSettings);
            showTimerToggle.addEventListener('change', saveSettings);

            // History
            sortHistoryBy.addEventListener('change', populateHistoryTable);
            clearHistoryBtn.addEventListener('click', requestClearHistory);

            // Admin: Subject
            addSubjectBtn.addEventListener('click', addSubject);

            // Admin: Question
            saveQuestionBtn.addEventListener('click', saveQuestion);
            cancelEditBtn.addEventListener('click', clearQuestionForm);

            // Admin: Import/Export
            document.getElementById('import-subject-file-btn').addEventListener('click', () => importSubjectFileInput.click());
            document.getElementById('import-backup-file-btn').addEventListener('click', () => importBackupFileInput.click());
            importSubjectFileInput.addEventListener('change', importSubjectFile);
            importBackupFileInput.addEventListener('change', importBackupFile);
            exportSubjectBtn.addEventListener('click', exportSubjectFile);
            exportBackupBtn.addEventListener('click', exportBackupFile);

            // Dynamic Listeners (Event Delegation)
            addDynamicListeners();
        }

        /**
         * Adds event listeners for dynamically created buttons
         */
        function addDynamicListeners() {
            document.body.addEventListener('click', function(e) {
                // Home Screen Cards
                if (e.target.classList.contains('start-quiz-btn')) {
                    startQuiz(e.target.dataset.name);
                }
                if (e.target.classList.contains('delete-subject-home-btn')) {
                    requestDeleteSubject(e.target.dataset.name);
                }
                
                // Admin Subject List buttons
                if (e.target.classList.contains('edit-subject-btn')) {
                    editSubject(e.target.dataset.name, e.target.closest('li'));
                }
                if (e.target.classList.contains('save-subject-btn')) {
                    saveSubjectEdit(e.target.dataset.name, e.target.closest('li'));
                }
                if (e.target.classList.contains('cancel-subject-btn')) {
                    cancelSubjectEdit(e.target.closest('li'));
                }
                if (e.target.classList.contains('delete-subject-btn')) {
                    requestDeleteSubject(e.target.dataset.name);
                }
                if (e.target.classList.contains('view-subject-questions')) {
                    showQuestionsForSubject(e.target.dataset.name);
                }

                // Admin Question List buttons
                if (e.target.classList.contains('edit-q-btn')) {
                    editQuestion(e.target.dataset.subject, e.target.dataset.qIndex);
                }
                if (e.target.classList.contains('delete-q-btn')) {
                    requestDeleteQuestion(e.target.dataset.subject, e.target.dataset.qIndex);
                }

                // Confirmation buttons in adminFeedback
                if (e.target.id === 'confirm-delete-subject') {
                    deleteSubject(e.target.dataset.name);
                }
                if (e.target.id === 'confirm-delete-question') {
                    deleteQuestion(e.target.dataset.subject, e.target.dataset.qIndex);
                }
                if (e.target.id === 'confirm-clear-history') {
                    clearHistory();
                }
                if (e.target.id === 'confirm-import-subject') {
                    confirmImportSubject(e.target.dataset.subject, true);
                }
                if (e.target.id === 'confirm-import-backup') {
                    confirmImportBackup(true);
                }
                if (e.target.id === 'cancel-action') {
                    clearAdminFeedback();
                }
            });
        }
        
        // --- Screen Management ---
        
        /**
         * Hides all screens and shows the target screen
         */
        function showScreen(screenToShow) {
            allScreens.forEach(screen => {
                if (!screen.classList.contains('hidden')) {
                    // Add fade-out effects manually if needed, 
                    // but for simplicity, just hide.
                    screen.classList.add('hidden');
                }
            });
            
            // Refresh dynamic content when showing screen
            if (screenToShow === startScreen) {
                populateSubjectCards();
                updateLastScore();
            }
            if (screenToShow === adminScreen) {
                populateAdminControls();
                editQuestionsPanel.classList.add('hidden');
                clearQuestionForm();
            }
            if (screenToShow === historyScreen) {
                populateHistoryTable();
            }
            
            screenToShow.classList.remove('hidden');
            // Trigger fade-in animation
            screenToShow.style.animation = 'fadeIn 0.3s ease-out';
            // Remove animation after it plays
            setTimeout(() => screenToShow.style.animation = '', 300);
        }
        
        function showAdminPanel() { showScreen(adminScreen); }
        function showHistoryPanel() { showScreen(historyScreen); }

        // --- Theme Management ---
        
        function loadTheme() {
            if (localStorage.getItem(THEME_KEY) === 'dark' || 
               (!localStorage.getItem(THEME_KEY) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                setTheme('dark');
            } else {
                setTheme('light');
            }
        }
        
        function setTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                themeIconLight.classList.add('hidden');
                themeIconDark.classList.remove('hidden');
                localStorage.setItem(THEME_KEY, 'dark');
            } else {
                document.documentElement.classList.remove('dark');
                themeIconLight.classList.remove('hidden');
                themeIconDark.classList.add('hidden');
                localStorage.setItem(THEME_KEY, 'light');
            }
        }
        
        function toggleTheme() {
            const currentTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            setTheme(currentTheme === 'dark' ? 'light' : 'dark');
        }
        
        // --- Settings Management ---
        
        function loadSettings() {
            const savedSettings = JSON.parse(localStorage.getItem(SETTINGS_KEY)) || {};
            quizSettings = {
                count: savedSettings.count || '5',
                timeLimit: savedSettings.timeLimit || '20',
                showTimer: savedSettings.showTimer === false ? false : true // default to true
            };
            
            questionCountSelect.value = quizSettings.count;
            timeLimitSelect.value = quizSettings.timeLimit;
            showTimerToggle.checked = quizSettings.showTimer;
            
            saveSettings(); // Save to ensure it's in storage
        }
        
        function saveSettings() {
            quizSettings = {
                count: questionCountSelect.value,
                timeLimit: timeLimitSelect.value,
                showTimer: showTimerToggle.checked
            };
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(quizSettings));
        }
        
        // --- Data (Subjects/Questions) Management ---
        
        function loadData() {
            const savedData = localStorage.getItem(DB_KEY);
            if (savedData) {
                quizData = JSON.parse(savedData);
            } else {
                quizData = { "subjects": [] }; 
                saveData();
            }
        }

        function saveData() {
            localStorage.setItem(DB_KEY, JSON.stringify(quizData));
        }

        /**
         * Populates the subject cards on the home screen
         */
        function populateSubjectCards() {
            subjectCardsContainer.innerHTML = '';
            if (quizData.subjects.length === 0) {
                noSubjectsMsg.classList.remove('hidden');
                subjectCardsContainer.classList.add('hidden');
                return;
            }
            
            noSubjectsMsg.classList.add('hidden');
            subjectCardsContainer.classList.remove('hidden');
            
            quizData.subjects.forEach(subject => {
                const card = document.createElement('div');
                card.className = "p-4 bg-slate-50 dark:bg-slate-700/80 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 fade-in";
                card.innerHTML = `
                    <h3 class="font-bold text-lg text-indigo-600 dark:text-indigo-400 truncate">${subject.name}</h3>
                    <p class="text-sm text-slate-500 dark:text-slate-400 mb-3">${subject.questions.length} questions</p>
                    <div class="flex gap-2">
                        <button class="start-quiz-btn flex-1 bg-indigo-600 text-white py-2 px-3 text-sm rounded-md font-semibold hover:bg-indigo-700" data-name="${subject.name}">Start Quiz</button>
                        <button class="delete-subject-home-btn bg-red-500 text-white p-2 text-sm rounded-md font-semibold hover:bg-red-600" data-name="${subject.name}">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg>
                        </button>
                    </div>
                `;
                subjectCardsContainer.appendChild(card);
            });
        }
        
        /**
         * Populates the admin controls (subject list and dropdown)
         */
        function populateAdminControls() {
            adminSubjectList.innerHTML = '';
            adminSubjectSelect.innerHTML = '';

            if (quizData.subjects.length === 0) {
                adminSubjectList.innerHTML = '<li class="!bg-transparent !border-none text-slate-500 dark:text-slate-400">No subjects yet. Add one above.</li>';
                adminSubjectSelect.innerHTML = '<option disabled>Please add a subject first.</option>';
                saveQuestionBtn.disabled = true;
                saveQuestionBtn.classList.add('opacity-50', 'cursor-not-allowed');
                exportSubjectBtn.disabled = true;
                exportSubjectBtn.classList.add('opacity-50', 'cursor-not-allowed');
                return;
            }
            
            saveQuestionBtn.disabled = false;
            saveQuestionBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            exportSubjectBtn.disabled = false;
            exportSubjectBtn.classList.remove('opacity-50', 'cursor-not-allowed');

            quizData.subjects.forEach(subject => {
                // Add to admin list
                const li = document.createElement('li');
                li.innerHTML = `
                    <div class="flex-grow">
                        <span class="subject-name-display font-semibold text-indigo-700 dark:text-indigo-400 cursor-pointer view-subject-questions" data-name="${subject.name}">${subject.name}</span>
                        <span class="text-sm text-slate-500 dark:text-slate-400 ml-2">(${subject.questions.length}Q)</span>
                        <div class="subject-edit-form hidden mt-2 flex gap-2">
                            <input type="text" value="${subject.name}" class="w-full p-1 border border-slate-300 dark:border-slate-600 dark:bg-slate-700 rounded-md">
                            <button class="save-subject-btn text-sm bg-green-500 text-white px-2 py-1 rounded-md" data-name="${subject.name}">Save</button>
                            <button class="cancel-subject-btn text-sm bg-slate-200 text-slate-700 px-2 py-1 rounded-md">Cancel</button>
                        </div>
                    </div>
                    <div class="flex-shrink-0 space-x-2">
                        <button class="edit-subject-btn text-sm text-indigo-600 hover:text-indigo-800 dark:text-indigo-400 dark:hover:text-indigo-300 font-medium" data-name="${subject.name}">[Edit]</button>
                        <button class="delete-subject-btn text-sm text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 font-medium" data-name="${subject.name}">[Delete]</button>
                    </div>
                `;
                adminSubjectList.appendChild(li);

                // Add to admin dropdown
                const option = document.createElement('option');
                option.value = subject.name;
                option.textContent = subject.name;
                adminSubjectSelect.appendChild(option);
            });
        }
        
        // --- History Management ---
        
        function loadHistory() {
            quizHistory = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
        }
        
        function saveHistory() {
            localStorage.setItem(HISTORY_KEY, JSON.stringify(quizHistory));
        }

        function updateLastScore() {
            const lastScore = localStorage.getItem('lastQuizScore');
            if (lastScore) {
                lastScoreDisplay.textContent = lastScore;
            }
        }
        
        function populateHistoryTable() {
            historyTableBody.innerHTML = '';
            
            if (quizHistory.length === 0) {
                noHistoryMsg.classList.remove('hidden');
                historyTableBody.classList.add('hidden');
                return;
            }
            
            noHistoryMsg.classList.add('hidden');
            historyTableBody.classList.remove('hidden');

            const sortMethod = sortHistoryBy.value;
            const sortedHistory = [...quizHistory].sort((a, b) => {
                const scoreA = (a.score / a.totalQuestions) || 0;
                const scoreB = (b.score / b.totalQuestions) || 0;
                switch(sortMethod) {
                    case 'date_asc': return new Date(a.date) - new Date(b.date);
                    case 'score_desc': return scoreB - scoreA;
                    case 'score_asc': return scoreA - scoreB;
                    case 'date_desc':
                    default:
                        return new Date(b.date) - new Date(a.date);
                }
            });
            
            sortedHistory.forEach(entry => {
                const tr = document.createElement('tr');
                const date = new Date(entry.date).toLocaleString(undefined, { dateStyle: 'medium', timeStyle: 'short' });
                tr.innerHTML = `
                    <td class="font-medium">${entry.subjectName}</td>
                    <td>${entry.score} / ${entry.totalQuestions} (${((entry.score / entry.totalQuestions) * 100 || 0).toFixed(0)}%)</td>
                    <td class="text-sm text-slate-500 dark:text-slate-400">${date}</td>
                `;
                historyTableBody.appendChild(tr);
            });
        }
        
        function requestClearHistory() {
            showAdminFeedback(`Are you sure you want to delete <strong>ALL</strong> quiz history? This cannot be undone. <br>
                <button id="confirm-clear-history" class="bg-red-600 text-white py-1 px-3 rounded-md text-sm mt-2 mr-2">Yes, Delete History</button>
                <button id="cancel-action" class="bg-slate-200 dark:bg-slate-600 text-slate-800 dark:text-slate-200 py-1 px-3 rounded-md text-sm mt-2">Cancel</button>`, 
            "warning", historyScreen); // Show feedback on history screen
        }
        
        function clearHistory() {
            quizHistory = [];
            saveHistory();
            populateHistoryTable();
            clearAdminFeedback(historyScreen); // Clear feedback on history screen
        }

        // --- Admin Panel: Subject Functions ---
        
        function addSubject() {
            const name = newSubjectName.value.trim();
            if (!name) {
                showAdminFeedback("Subject name cannot be empty.", "error");
                return;
            }
            if (quizData.subjects.find(s => s.name.toLowerCase() === name.toLowerCase())) {
                showAdminFeedback("Subject with this name already exists.", "error");
                return;
            }

            quizData.subjects.push({ name: name, questions: [] });
            saveData();
            populateAdminControls();
            newSubjectName.value = '';
            showAdminFeedback(`Subject '${name}' added successfully.`, "success");
        }

        function editSubject(oldName, li) {
            li.querySelector('.subject-name-display').classList.add('hidden');
            li.querySelector('.subject-edit-form').classList.remove('hidden');
        }

        function cancelSubjectEdit(li) {
            li.querySelector('.subject-name-display').classList.remove('hidden');
            li.querySelector('.subject-edit-form').classList.add('hidden');
            const oldName = li.querySelector('.save-subject-btn').dataset.name;
            li.querySelector('input').value = oldName;
        }

        function saveSubjectEdit(oldName, li) {
            const newName = li.querySelector('input').value.trim();
            if (!newName) {
                showAdminFeedback("Subject name cannot be empty.", "error");
                return;
            }
            if (newName.toLowerCase() !== oldName.toLowerCase() && quizData.subjects.find(s => s.name.toLowerCase() === newName.toLowerCase())) {
                showAdminFeedback("Another subject with this name already exists.", "error");
                return;
            }

            const subject = quizData.subjects.find(s => s.name === oldName);
            if (subject) {
                subject.name = newName;
            }
            // Also update history
            quizHistory.forEach(entry => {
                if (entry.subjectName === oldName) {
                    entry.subjectName = newName;
                }
            });
            saveHistory();
            saveData();
            populateAdminControls();
            showAdminFeedback(`Subject renamed to '${newName}'.`, "success");
        }

        function requestDeleteSubject(subjectName) {
            showAdminFeedback(`Are you sure you want to delete "<strong>${subjectName}</strong>"? This will delete all its questions. <br>
                <button id="confirm-delete-subject" data-name="${subjectName}" class="bg-red-600 text-white py-1 px-3 rounded-md text-sm mt-2 mr-2">Yes, Delete</button>
                <button id="cancel-action" class="bg-slate-200 dark:bg-slate-600 text-slate-800 dark:text-slate-200 py-1 px-3 rounded-md text-sm mt-2">Cancel</button>`, 
            "warning");
        }

        function deleteSubject(subjectName) {
            quizData.subjects = quizData.subjects.filter(s => s.name !== subjectName);
            saveData();
            populateAdminControls();
            populateSubjectCards(); // Refresh home screen
            editQuestionsPanel.classList.add('hidden');
            clearAdminFeedback();
            showAdminFeedback(`Subject '${subjectName}' deleted.`, "success");
        }

        // --- Admin Panel: Question Functions ---

        function showQuestionsForSubject(subjectName) {
            editQuestionsPanel.classList.remove('hidden');
            editQuestionsTitle.textContent = `Questions for: ${subjectName}`;
            questionEditList.innerHTML = '';

            const subject = quizData.subjects.find(s => s.name === subjectName);
            if (!subject || subject.questions.length === 0) {
                questionEditList.innerHTML = '<li class="!bg-transparent !border-none text-slate-500 dark:text-slate-400">No questions in this subject yet.</li>';
                return;
            }

            subject.questions.forEach((q, index) => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span class="flex-grow truncate pr-4" title="${q.question}">${q.question}</span>
                    <div class="flex-shrink-0 space-x-2">
                        <button class="edit-q-btn text-sm text-indigo-600 hover:text-indigo-800 dark:text-indigo-400 dark:hover:text-indigo-300 font-medium" data-subject="${subjectName}" data-q-index="${index}">[Edit]</button>
                        <button class="delete-q-btn text-sm text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 font-medium" data-subject="${subjectName}" data-q-index="${index}">[Delete]</button>
                    </div>
                `;
                questionEditList.appendChild(li);
            });
        }

        function editQuestion(subjectName, qIndex) {
            const subject = quizData.subjects.find(s => s.name === subjectName);
            const question = subject.questions[qIndex];
            if (!question) return;

            questionFormTitle.textContent = "Edit Question";
            adminSubjectSelect.value = subjectName;
            adminQuestionText.value = question.question;
            
            const correctAnswer = question.answer;
            const wrongOptions = question.options.filter(opt => opt !== correctAnswer);
            
            adminOption1.value = correctAnswer;
            adminOption2.value = wrongOptions[0] || '';
            adminOption3.value = wrongOptions[1] || '';
            adminOption4.value = wrongOptions[2] || '';

            editingQuestionIndex.value = qIndex;
            saveQuestionBtn.textContent = "Update Question";
            cancelEditBtn.classList.remove('hidden');
            questionFormTitle.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function saveQuestion() {
            const subjectName = adminSubjectSelect.value;
            const questionText = adminQuestionText.value.trim();
            const correctAnswer = adminOption1.value.trim();
            const options = [
                correctAnswer,
                adminOption2.value.trim(),
                adminOption3.value.trim(),
                adminOption4.value.trim()
            ].filter(opt => opt); // Filter out empty strings
            const qIndex = parseInt(editingQuestionIndex.value);

            if (!subjectName) {
                showAdminFeedback("Please select a subject.", "error");
                return;
            }
            if (!questionText || options.length < 2) { // Must have at least a question and 2 options
                showAdminFeedback("Please fill in the question and at least 2 options (including correct answer).", "error");
                return;
            }

            const subject = quizData.subjects.find(s => s.name === subjectName);
            if (!subject) {
                showAdminFeedback("Selected subject not found.", "error");
                return;
            }
            
            // Pad options array to 4, as old code might expect it
            const finalOptions = [
                correctAnswer,
                adminOption2.value.trim() || 'Option A',
                adminOption3.value.trim() || 'Option B',
                adminOption4.value.trim() || 'Option C'
            ];

            const newQuestion = {
                question: questionText,
                options: finalOptions, // Save all 4
                answer: correctAnswer
            };

            if (qIndex > -1) {
                subject.questions[qIndex] = newQuestion;
                showAdminFeedback(`Question updated in '${subjectName}'.`, "success");
            } else {
                subject.questions.push(newQuestion);
                showAdminFeedback(`Question added to '${subjectName}'.`, "success");
            }

            saveData();
            populateAdminControls();
            
            if (!editQuestionsPanel.classList.contains('hidden') && editQuestionsTitle.textContent.includes(subjectName)) {
                showQuestionsForSubject(subjectName);
            }
            clearQuestionForm();
        }

        function clearQuestionForm() {
            questionFormTitle.textContent = "Add New Question";
            adminQuestionText.value = '';
            adminOption1.value = '';
            adminOption2.value = '';
            adminOption3.value = '';
            adminOption4.value = '';
            editingQuestionIndex.value = -1;
            saveQuestionBtn.textContent = "Save Question";
            cancelEditBtn.classList.add('hidden');
        }

        function requestDeleteQuestion(subjectName, qIndex) {
             const question = quizData.subjects.find(s => s.name === subjectName).questions[qIndex];
            showAdminFeedback(`Are you sure you want to delete this question: "<strong>${question.question.substring(0, 30)}...</strong>"? <br>
                <button id="confirm-delete-question" data-subject="${subjectName}" data-q-index="${qIndex}" class="bg-red-600 text-white py-1 px-3 rounded-md text-sm mt-2 mr-2">Yes, Delete</button>
                <button id="cancel-action" class="bg-slate-200 dark:bg-slate-600 text-slate-800 dark:text-slate-200 py-1 px-3 rounded-md text-sm mt-2">Cancel</button>`, 
            "warning");
        }

        function deleteQuestion(subjectName, qIndex) {
            const subject = quizData.subjects.find(s => s.name === subjectName);
            if (subject) {
                subject.questions.splice(qIndex, 1);
                saveData();
                populateAdminControls();
                showQuestionsForSubject(subjectName);
                clearAdminFeedback();
                showAdminFeedback(`Question deleted from '${subjectName}'.`, "success");
            }
        }

        // --- Admin Panel: Import/Export Functions ---

        function exportSubjectFile() {
            const subjectName = adminSubjectSelect.value;
            if (!subjectName) {
                showAdminFeedback("No subject selected to export.", "error");
                return;
            }
            const subject = quizData.subjects.find(s => s.name === subjectName);
            if (!subject) {
                showAdminFeedback("Selected subject not found.", "error");
                return;
            }
            
            const dataStr = JSON.stringify(subject, null, 2);
            downloadJSON(dataStr, `${subject.name.replace(/ /g, '_')}_quiz.json`);
            showAdminFeedback(`Exported subject '${subject.name}'.`, "success");
        }
        
        let subjectToImport = null;
        function importSubjectFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const subject = JSON.parse(e.target.result);
                    if (!subject || !subject.name || !Array.isArray(subject.questions)) {
                        throw new Error("Invalid subject file format.");
                    }
                    
                    subjectToImport = subject; // Store temporarily
                    const existing = quizData.subjects.find(s => s.name === subject.name);
                    
                    if (existing) {
                        showAdminFeedback(`Subject "<strong>${subject.name}</strong>" already exists. Do you want to overwrite it? <br>
                            <button id="confirm-import-subject" data-subject="${subject.name}" class="bg-orange-600 text-white py-1 px-3 rounded-md text-sm mt-2 mr-2">Yes, Overwrite</button>
                            <button id="cancel-action" class="bg-slate-200 dark:bg-slate-600 text-slate-800 dark:text-slate-200 py-1 px-3 rounded-md text-sm mt-2">Cancel</button>`, 
                        "warning");
                    } else {
                        confirmImportSubject(null, false); // No conflict, add directly
                    }
                } catch (error) {
                    showAdminFeedback(`Import failed: ${error.message}`, "error");
                }
            };
            reader.readAsText(file);
            event.target.value = null; // Clear input
        }

        function confirmImportSubject(subjectName, overwrite) {
            if (!subjectToImport) return;
            
            if (overwrite) {
                const index = quizData.subjects.findIndex(s => s.name === subjectName);
                quizData.subjects[index] = subjectToImport;
            } else {
                quizData.subjects.push(subjectToImport);
            }
            
            saveData();
            populateAdminControls();
            showAdminFeedback(`Subject '${subjectToImport.name}' imported successfully.`, "success");
            subjectToImport = null; // Clear temp
        }

        function exportBackupFile() {
            const backupData = {
                quizData: quizData,
                history: quizHistory,
                settings: quizSettings
            };
            const dataStr = JSON.stringify(backupData, null, 2);
            downloadJSON(dataStr, `study_helper_backup_${new Date().toISOString().split('T')[0]}.json`);
            showAdminFeedback("Full app backup exported.", "success");
        }
        
        let backupToImport = null;
        function importBackupFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!data.quizData || !data.history || !data.settings) {
                        throw new Error("Invalid backup file format.");
                    }
                    backupToImport = data; // Store temp
                    
                    showAdminFeedback(`Are you sure you want to restore from this backup? <strong>This will overwrite ALL current subjects, history, and settings.</strong> <br>
                        <button id="confirm-import-backup" class="bg-red-600 text-white py-1 px-3 rounded-md text-sm mt-2 mr-2">Yes, Overwrite Everything</button>
                        <button id="cancel-action" class="bg-slate-200 dark:bg-slate-600 text-slate-800 dark:text-slate-200 py-1 px-3 rounded-md text-sm mt-2">Cancel</button>`, 
                    "warning");
                    
                } catch (error) {
                    showAdminFeedback(`Import failed: ${error.message}`, "error");
                }
            };
            reader.readAsText(file);
            event.target.value = null; // Clear input
        }

        function confirmImportBackup(confirmed) {
            if (!confirmed || !backupToImport) {
                backupToImport = null;
                clearAdminFeedback();
                return;
            }
            
            // Restore data
            quizData = backupToImport.quizData;
            quizHistory = backupToImport.history;
            quizSettings = backupToImport.settings;
            
            // Save all data
            saveData();
            saveHistory();
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(quizSettings));
            
            backupToImport = null;
            showAdminFeedback("Backup restored successfully! Reloading app...", "success");
            
            // Reload the app to apply all new data
            setTimeout(() => {
                location.reload();
            }, 1500);
        }

        /**
         * Helper function to trigger JSON file download
         */
        function downloadJSON(jsonString, fileName) {
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // --- Feedback Functions ---
        
        function showAdminFeedback(message, type, screen = adminScreen) {
            const feedbackEl = (screen === adminScreen) ? adminFeedback : document.getElementById('admin-feedback-history'); // Assume history has one
            if (screen === historyScreen) {
                // Special case for history screen, use its feedback el
                // This requires adding an <div id="admin-feedback-history">...</div> to history screen
                // For now, let's just use the main admin one, but on the history screen
                // Re-using adminFeedback, but it's on a different screen...
                // Let's create a temp feedback on history screen if it doesn't exist
                let historyFeedback = document.getElementById('history-feedback');
                if (!historyFeedback) {
                    historyFeedback = document.createElement('div');
                    historyFeedback.id = 'history-feedback';
                    historyFeedback.className = 'text-center font-medium min-h-[2em] mb-4 p-3 rounded-lg';
                    clearHistoryBtn.before(historyFeedback);
                }
                feedbackEl = historyFeedback;
            }
            
            
            feedbackEl.innerHTML = message;
            feedbackEl.classList.remove('text-green-600', 'text-red-600', 'text-yellow-700', 'bg-red-100', 'bg-green-100', 'bg-yellow-100', 'dark:bg-red-900/50', 'dark:bg-green-900/50', 'dark:bg-yellow-900/50');
            
            if (type === "success") {
                feedbackEl.classList.add('text-green-600', 'bg-green-100', 'dark:bg-green-900/50');
            } else if (type === "error") {
                feedbackEl.classList.add('text-red-600', 'bg-red-100', 'dark:bg-red-900/50');
            } else if (type === "warning") {
                feedbackEl.classList.add('text-yellow-700', 'bg-yellow-100', 'dark:bg-yellow-900/50');
            }
        }
        
        function clearAdminFeedback(screen = adminScreen) {
            let feedbackEl = adminFeedback;
             if (screen === historyScreen) {
                 feedbackEl = document.getElementById('history-feedback');
             }
             if (feedbackEl) {
                 feedbackEl.innerHTML = '';
                 feedbackEl.className = 'text-center font-medium min-h-[2em] mb-4 p-3 rounded-lg';
             }
        }

        // --- Quiz Logic ---
        
        /**
         * Starts the quiz
         */
        function startQuiz(subjectName) {
            const subject = quizData.subjects.find(s => s.name === subjectName);
            if (!subject || subject.questions.length === 0) {
                alert("This subject has no questions. Add some in the 'Manage Question Bank' panel.");
                return;
            }

            // Get settings
            const questionCountValue = quizSettings.count;
            timePerQuestion = quizSettings.timeLimit;
            isTimerVisible = quizSettings.showTimer;

            currentSubjectName = subjectName;
            
            let allSubjectQuestions = [...subject.questions];
            shuffleArray(allSubjectQuestions);
            
            if (questionCountValue === 'all') {
                currentQuestions = allSubjectQuestions;
            } else {
                let count = parseInt(questionCountValue);
                currentQuestions = allSubjectQuestions.slice(0, Math.min(count, allSubjectQuestions.length));
            }
            
            if (currentQuestions.length === 0) {
                alert("This subject has no questions yet.");
                return;
            }

            // Reset state
            currentQuestionIndex = 0;
            score = 0;
            userAnswers = [];
            answerTimes = [];
            scoreDisplay.textContent = `Score: 0`;
            feedbackMessage.textContent = '';
            
            // Setup timer
            if (timePerQuestion === 'unlimited') {
                timeElapsed = 0;
            } else {
                timeRemaining = currentQuestions.length * parseInt(timePerQuestion);
            }
            startTimer();
            
            timerDisplay.classList.toggle('hidden', !isTimerVisible);

            showScreen(quizScreen);
            showQuestion();
            updateProgressBar();
        }

        /**
         * Displays the current question and options
         */
        function showQuestion() {
            optionsContainer.innerHTML = '';
            feedbackMessage.textContent = '';
            nextBtn.classList.add('hidden');

            const question = currentQuestions[currentQuestionIndex];
            questionText.textContent = question.question;

            // Use only valid options (filter out empty ones if any)
            const validOptions = question.options.filter(opt => opt && opt.trim() !== '');
            const shuffledOptions = [...validOptions];
            shuffleArray(shuffledOptions);
            
            shuffledOptions.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.classList.add('option-btn', 'w-full', 'text-left', 'p-4', 'rounded-lg', 'bg-slate-100', 'dark:bg-slate-700', 'hover:bg-slate-200', 'dark:hover:bg-slate-600', 'border', 'border-slate-200', 'dark:border-slate-600', 'transition-all', 'duration-200', 'fade-in');
                button.dataset.answer = option;
                button.addEventListener('click', handleOptionClick);
                optionsContainer.appendChild(button);
            });
            
            questionStartTime = Date.now(); // Start timer for this question
        }

        /**
         * Handles the click of an answer option
         */
        function handleOptionClick(event) {
            const timeTaken = (Date.now() - questionStartTime) / 1000; // in seconds
            answerTimes.push(timeTaken);
            
            const selectedButton = event.target;
            const selectedAnswer = selectedButton.dataset.answer;
            const correctAnswer = currentQuestions[currentQuestionIndex].answer;

            Array.from(optionsContainer.children).forEach(btn => {
                btn.disabled = true;
                if (btn.dataset.answer === correctAnswer) {
                    btn.classList.add('correct');
                }
            });

            if (selectedAnswer === correctAnswer) {
                score++;
                feedbackMessage.textContent = "Correct! Well done.";
                feedbackMessage.classList.add('text-green-600', 'dark:text-green-400');
                feedbackMessage.classList.remove('text-red-600', 'dark:text-red-400');
            } else {
                selectedButton.classList.add('incorrect');
                feedbackMessage.textContent = `Sorry, the correct answer was: ${correctAnswer}`;
                feedbackMessage.classList.add('text-red-600', 'dark:text-red-400');
                feedbackMessage.classList.remove('text-green-600', 'dark:text-green-400');
            }

            userAnswers.push({
                question: currentQuestions[currentQuestionIndex].question,
                chosen: selectedAnswer,
                correct: correctAnswer
            });

            scoreDisplay.textContent = `Score: ${score}`;
            nextBtn.classList.remove('hidden');
        }

        /**
         * Moves to the next question or ends the quiz
         */
        function nextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex < currentQuestions.length) {
                showQuestion();
                updateProgressBar();
            } else {
                endQuiz();
            }
        }

        /**
         * Ends the quiz and displays the results
         */
        function endQuiz() {
            clearInterval(timerInterval);

            const total = currentQuestions.length;
            const percent = total > 0 ? (score / total * 100) : 0;
            
            finalScore.textContent = `${score} / ${total}`;
            percentageDisplay.textContent = `${percent.toFixed(1)}%`;

            // Save score to localStorage
            const scoreString = `${score} / ${total}`;
            localStorage.setItem('lastQuizScore', scoreString);
            
            // Save to history
            const historyEntry = {
                id: Date.now(),
                subjectName: currentSubjectName,
                score: score,
                totalQuestions: total,
                date: new Date().toISOString()
            };
            quizHistory.push(historyEntry);
            saveHistory();

            // Show performance stats
            showPerformanceStats();
            
            // Show results summary
            showResultsSummary();
            
            showScreen(resultsScreen);
        }

        /**
         * Populates the performance insights on the results screen
         */
        function showPerformanceStats() {
            // 1. Fastest Answer
            if (answerTimes.length > 0) {
                const minTime = Math.min(...answerTimes);
                fastestAnswer.textContent = `${minTime.toFixed(1)}s`;
            } else {
                fastestAnswer.textContent = 'N/A';
            }
            
            // 2. Weekly Accuracy
            const oneWeekAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;
            const weeklyHistory = quizHistory.filter(entry => new Date(entry.date).getTime() >= oneWeekAgo);
            
            if (weeklyHistory.length > 0) {
                let totalScore = 0;
                let totalQs = 0;
                weeklyHistory.forEach(entry => {
                    totalScore += entry.score;
                    totalQs += entry.totalQuestions;
                });
                const weeklyAcc = totalQs > 0 ? (totalScore / totalQs * 100) : 0;
                weeklyAccuracy.textContent = `${weeklyAcc.toFixed(1)}%`;
            } else {
                weeklyAccuracy.textContent = 'N/A';
            }
            
            // 3. Strongest Subject
            if (quizHistory.length > 0) {
                const subjectStats = {}; // { subjectName: { score: 0, total: 0 } }
                quizHistory.forEach(entry => {
                    if (!subjectStats[entry.subjectName]) {
                        subjectStats[entry.subjectName] = { score: 0, total: 0 };
                    }
                    subjectStats[entry.subjectName].score += entry.score;
                    subjectStats[entry.subjectName].total += entry.totalQuestions;
                });
                
                let bestSubject = 'N/A';
                let bestAvg = -1;
                
                Object.keys(subjectStats).forEach(subjectName => {
                    const stats = subjectStats[subjectName];
                    const avg = stats.total > 0 ? (stats.score / stats.total) : 0;
                    if (avg > bestAvg) {
                        bestAvg = avg;
                        bestSubject = subjectName;
                    }
                });
                strongestSubject.textContent = bestSubject;
            } else {
                strongestSubject.textContent = 'N/A';
            }
        }

        /**
         * Populates the results summary section
         */
        function showResultsSummary() {
            resultsSummary.innerHTML = '';
            userAnswers.forEach((answer, index) => {
                const resultDiv = document.createElement('div');
                resultDiv.classList.add('p-3', 'bg-slate-50', 'dark:bg-slate-700', 'rounded-lg', 'border', 'border-slate-200', 'dark:border-slate-600');
                
                const isCorrect = answer.chosen === answer.correct;
                
                resultDiv.innerHTML = `
                    <p class="font-semibold text-slate-700 dark:text-slate-300 mb-1">Q${index + 1}: ${answer.question}</p>
                    <p class="text-sm ${isCorrect ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}">
                        Your answer: ${answer.chosen}
                    </p>
                    ${!isCorrect ? `<p class="text-sm text-green-600 dark:text-green-400">Correct answer: ${answer.correct}</p>` : ''}
                `;
                resultsSummary.appendChild(resultDiv);
            });
        }

        /**
         * Resets the quiz to go back to the start screen
         */
        function restartQuiz() {
            progressBarInner.style.width = '0%';
            updateLastScore();
            showScreen(startScreen);
        }

        /**
         * Starts and updates the timer
         */
        function startTimer() {
            clearInterval(timerInterval);
            
            if (timePerQuestion === 'unlimited') {
                // Count up
                timeElapsed = 0;
                timerDisplay.textContent = `Time: ${formatTime(timeElapsed)}`;
                timerInterval = setInterval(() => {
                    timeElapsed++;
                    timerDisplay.textContent = `Time: ${formatTime(timeElapsed)}`;
                }, 1000);
            } else {
                // Count down
                timeRemaining = currentQuestions.length * parseInt(timePerQuestion);
                timerDisplay.textContent = `Time: ${formatTime(timeRemaining)}`;
                timerInterval = setInterval(() => {
                    timeRemaining--;
                    timerDisplay.textContent = `Time: ${formatTime(timeRemaining)}`;
                    if (timeRemaining <= 0) {
                        clearInterval(timerInterval);
                        endQuiz();
                    }
                }, 1000);
            }
        }

        /**
         * Formats seconds into MM:SS format
         */
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        /**
         * Updates the visual progress bar
         */
        function updateProgressBar() {
            const progress = (currentQuestionIndex / currentQuestions.length) * 100;
            progressBarInner.style.width = `${progress}%`;
        }

        /**
         * Shuffles an array in place (Fisher-Yates shuffle)
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // --- 5. Initial Run ---
        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>


