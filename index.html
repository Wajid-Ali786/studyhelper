<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Helper Quiz</title>
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Load Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- 3. Tailwind Dark Mode Config -->
    <script>
        tailwind.config = {
            darkMode: 'class', // Enable class-based dark mode
        }
    </script>
    
    <!-- 4. Custom Styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* App hidden state (before login) */
        .app-hidden {
            display: none;
            opacity: 0;
        }

        /* Custom transition for screens */
        .screen {
            transition: opacity 0.3s ease-in-out;
        }

        .screen-hidden {
            opacity: 0;
            pointer-events: none;
            display: none;
        }
        
        /* Custom styles for answer buttons */
        .option-btn.correct {
            @apply bg-green-100 border-green-500 text-green-800 font-semibold dark:bg-green-900/50 dark:border-green-700 dark:text-green-300;
        }
        .option-btn.incorrect {
            @apply bg-red-100 border-red-500 text-red-800 font-semibold dark:bg-red-900/50 dark:border-red-700 dark:text-red-300;
        }

        /* Style for the progress bar transition */
        #progress-bar-inner {
            transition: width 0.5s ease-out;
        }

        /* A subtle animation for elements fading in */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        /* Custom styles for admin list items */
        #admin-subject-list li, #question-edit-list li {
            @apply p-3 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-md flex justify-between items-center;
        }
        
        /* Table styles */
        #history-table th, #history-table td {
            @apply p-3 text-left;
        }
        #history-table th {
            @apply bg-slate-100 dark:bg-slate-700;
        }
        #history-table tr {
            @apply border-b border-slate-200 dark:border-slate-700;
        }
        #history-table tr:last-child {
            @apply border-b-0;
        }
        
        /* Scrollbar styles for dark mode */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            @apply bg-slate-100;
        }
        ::-webkit-scrollbar-thumb {
            @apply bg-slate-400 rounded-lg;
        }
        html.dark ::-webkit-scrollbar-track {
            @apply bg-slate-800;
        }
        html.dark ::-webkit-scrollbar-thumb {
            @apply bg-slate-600;
        }

        /* Hidden file input */
        .hidden-file-input {
            width: 0.1px;
            height: 0.1px;
            opacity: 0;
            overflow: hidden;
            position: absolute;
            z-index: -1;
        }

        /* Custom input number styles */
        input[type=number] {
            @apply text-center p-2 border border-slate-300 dark:border-slate-600 dark:bg-slate-700 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500;
        }
        /* Hide number input arrows */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        /* Sidebar styles */
        #sidebar {
            transition: transform 0.3s ease-in-out, width 0.3s ease-in-out;
        }

        #main-content {
            transition: margin-left 0.3s ease-in-out;
        }
        
        /* Header */
        #header {
            transition: margin-left 0.3s ease-in-out;
        }

        /* Sidebar link base styles */
        .sidebar-link {
            @apply flex items-center p-3 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors duration-200;
        }
        /* Sidebar active link styles */
        .sidebar-link.active {
            @apply bg-indigo-100 dark:bg-indigo-800 text-indigo-700 dark:text-indigo-300 font-semibold;
        }
        
        /* Modal Base Styles */
        .modal-overlay {
            @apply fixed inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 transition-opacity duration-300 opacity-0 pointer-events-none;
        }
        .modal-overlay.open {
            @apply opacity-100 pointer-events-auto;
        }
        .modal-content {
            @apply bg-white dark:bg-slate-800 rounded-xl shadow-2xl p-6 sm:p-8 w-full max-w-md transition-all duration-300 transform scale-95 opacity-0;
        }
        .modal-overlay.open .modal-content {
            @apply scale-100 opacity-100;
        }
        
        /* Auth Modal Styles */
        #auth-overlay {
            @apply fixed inset-0 z-[60] bg-slate-100 dark:bg-slate-900 flex items-center justify-center p-4 transition-opacity duration-300;
        }
        #auth-overlay.hidden {
            @apply opacity-0 pointer-events-none;
        }
        .auth-tab {
            @apply p-3 px-4 font-medium text-slate-500 dark:text-slate-400 border-b-2 border-transparent hover:text-indigo-600;
        }
        .auth-tab.active {
            @apply text-indigo-600 dark:text-indigo-400 border-indigo-600 dark:border-indigo-400;
        }
        .auth-form {
            @apply space-y-4;
        }
        .auth-form.hidden {
            display: none;
        }
        .auth-input {
            @apply w-full p-3 border border-slate-300 dark:border-slate-600 dark:bg-slate-700 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500;
        }
        /* Auth loading spinner */
        #auth-loader {
            @apply absolute inset-0 bg-white/50 dark:bg-slate-800/50 flex items-center justify-center;
        }
        #auth-loader svg {
            @apply w-12 h-12 text-indigo-600 animate-spin;
        }
        .hidden {
            display: none;
        }

        /* Toast Notification */
        #toast-container {
            @apply fixed bottom-5 right-5 z-[100] flex flex-col gap-3;
        }
        .toast {
            @apply p-4 rounded-lg shadow-lg text-white font-semibold flex items-center gap-3 transition-all duration-300;
            animation: slideIn 0.3s ease-out;
        }
        .toast.success { @apply bg-green-600; }
        .toast.error { @apply bg-red-600; }
        .toast.warning { @apply bg-yellow-600; }
        
        .toast.fade-out {
            opacity: 0;
            transform: translateX(100%);
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* Custom Button Base Style */
        .btn {
            @apply py-2 px-4 rounded-lg font-semibold shadow-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-slate-900;
        }
        .btn-primary {
            @apply bg-indigo-600 text-white hover:bg-indigo-700 hover:shadow-lg focus:ring-indigo-500;
        }
        .btn-secondary {
            @apply bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-200 hover:bg-slate-300 dark:hover:bg-slate-600 hover:shadow-lg focus:ring-slate-500;
        }
        .btn-danger {
            @apply bg-red-600 text-white hover:bg-red-700 hover:shadow-lg focus:ring-red-500;
        }
        .btn-success {
            @apply bg-green-600 text-white hover:bg-green-700 hover:shadow-lg focus:ring-green-500;
        }
        .btn-warning {
            @apply bg-orange-500 text-white hover:bg-orange-600 hover:shadow-lg focus:ring-orange-500;
        }
        .btn:disabled {
            @apply opacity-50 cursor-not-allowed shadow-none;
        }

        /* Custom Icon Button */
        .icon-btn {
            @apply p-2 rounded-full text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors duration-200;
        }
    </style>
    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-slate-100 dark:bg-slate-900 min-h-screen text-slate-800 dark:text-slate-200 overflow-hidden">

    <!-- Toast Notification Container -->
    <div id="toast-container"></div>

    <!-- ===== AUTHENTICATION OVERLAY ===== -->
    <div id="auth-overlay">
        <div id="auth-modal" class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl p-6 sm:p-8 w-full max-w-md relative overflow-hidden">
            
            <h1 class="text-3xl font-extrabold text-center text-indigo-600 dark:text-indigo-400 mb-4">Study Helper</h1>
            
            <!-- Auth Tabs -->
            <div class="flex border-b dark:border-slate-700 mb-6">
                <button id="auth-tab-login" class="auth-tab active" data-form="login-form">Login</button>
                <button id="auth-tab-signup" class="auth-tab" data-form="signup-form">Sign Up</button>
            </div>

            <!-- Error Message Area -->
            <p id="auth-error" class="text-center text-red-500 dark:text-red-400 mb-4 h-5"></p>

            <!-- Login Form -->
            <form id="login-form" class="auth-form">
                <input id="login-email" type="email" placeholder="Email" class="auth-input" required>
                <input id="login-password" type="password" placeholder="Password" class="auth-input" required>
                <button type_submit" id="login-btn" class="btn btn-primary w-full py-3">Login</button>
                <a href="#" id="forgot-pass-link" class="text-sm text-indigo-600 dark:text-indigo-400 hover:underline text-center block">Forgot Password?</a>
            </form>

            <!-- Sign Up Form -->
            <form id="signup-form" class="auth-form hidden">
                <input id="signup-email" type="email" placeholder="Email" class="auth-input" required>
                <input id="signup-password" type="password" placeholder="Password (min. 6 characters)" class="auth-input" required>
                <button type="submit" id="signup-btn" class="btn btn-primary w-full py-3">Create Account</button>
            </form>

            <!-- Forgot Password Form -->
            <form id="forgot-form" class="auth-form hidden">
                <p class="text-sm text-slate-600 dark:text-slate-300 text-center">Enter your email and we'll send you a reset link.</p>
                <input id="forgot-email" type="email" placeholder="Email" class="auth-input" required>
                <button type="submit" id="forgot-btn" class="btn btn-primary w-full py-3">Send Reset Link</button>
                <a href="#" id="back-to-login-link" class="text-sm text-indigo-600 dark:text-indigo-400 hover:underline text-center block">Back to Login</a>
            </form>

            <!-- Divider -->
            <div class="flex items-center my-6">
                <span class="flex-grow border-t dark:border-slate-700"></span>
                <span class="mx-4 text-sm text-slate-500">OR</span>
                <span class="flex-grow border-t dark:border-slate-700"></span>
            </div>

            <!-- Google Sign-in -->
            <button id="google-signin-btn" class="btn btn-secondary w-full py-3 flex items-center justify-center gap-3">
                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"/><path fill="#FF3D00" d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"/><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.223 0-9.62-3.657-11.297-8.46l-6.522 5.025C9.505 39.556 16.227 44 24 44z"/><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.574l6.19 5.238C39.73 34.806 44 28.099 44 20c0-1.341-.138-2.65-.389-3.917z"/></svg>
                <span>Sign in with Google</span>
            </button>

            <!-- Auth Loader -->
            <div id="auth-loader" class="hidden">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
        </div>
    </div>
    
    <!-- Sidebar Overlay (for mobile) -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-30 md:hidden hidden app-hidden"></div>

    <!-- Sidebar -->
    <nav id="sidebar" class="fixed top-0 left-0 h-full w-64 bg-white dark:bg-slate-800 shadow-xl z-40 transform -translate-x-full md:translate-x-0 flex flex-col app-hidden">
        <!-- Logo/Header -->
        <div class="p-4 flex items-center justify-between border-b dark:border-slate-700 h-16">
            <h1 class="text-2xl font-extrabold text-indigo-600 dark:text-indigo-400">Study Helper</h1>
            <!-- Close button for mobile -->
            <button id="sidebar-close-btn" class="md:hidden p-1 text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-slate-200">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        
        <!-- Navigation Links -->
        <div class="flex-grow p-4 space-y-2 overflow-y-auto">
            <button class="sidebar-link w-full active" data-screen="home-screen">
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                <span>Home</span>
            </button>
            <button class="sidebar-link w-full" data-screen="admin-screen">
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                <span>Manage Bank</span>
            </button>
            <button class="sidebar-link w-full" data-screen="history-screen">
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                <span>Quiz History</span>
            </button>
            <button class="sidebar-link w-full" data-screen="data-screen">
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                <span>Settings & Data</span>
            </button>
        </div>
        
    </nav>

    <!-- Main Content -->
    <main id="main-content" class="flex-grow md:ml-64 h-screen flex flex-col app-hidden">
        <!-- Header Bar -->
        <header id="header" class="fixed top-0 left-0 md:left-64 right-0 bg-white/80 dark:bg-slate-800/80 backdrop-blur-md shadow-sm z-20 h-16 flex items-center justify-between px-4 md:px-8 app-hidden">
            <!-- Hamburger button for mobile -->
            <button id="hamburger-btn" class="md:hidden icon-btn">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
            </button>
            
            <!-- Screen Title (Dynamic) -->
            <h2 id="header-title" class="text-xl font-semibold ml-2 md:ml-0">Home</h2>
            
            <div class="flex items-center gap-2">
                <!-- User Display -->
                <span id="user-display" class="text-sm text-slate-600 dark:text-slate-300 hidden md:block"></span>
                
                <!-- Logout Button -->
                <button id="logout-btn" class="icon-btn" title="Logout">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                </button>
                
                <!-- Theme Toggle -->
                <button id="theme-toggle-btn" class="icon-btn">
                    <!-- Sun Icon -->
                    <svg id="theme-icon-light" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    <!-- Moon Icon -->
                    <svg id="theme-icon-dark" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                    <span id="theme-toggle-text" class="sr-only">Toggle Theme</span>
                </button>
            </div>
        </header>

        <!-- Content Area: All screens will be injected here -->
        <div class="flex-grow flex items-center justify-center p-4 md:p-8 overflow-y-auto pt-20">

            <!-- Main Container Card (was the whole app, now just the content card) -->
            <div class="w-full max-w-3xl bg-white dark:bg-slate-800 rounded-xl shadow-xl p-6 sm:p-10 relative my-8">

                <!-- ===== SCREEN 1: Home Screen ===== -->
                <div id="home-screen" class="screen">
                    <h1 class="text-3xl font-extrabold text-center mb-2">Study Helper Quiz</h1>
                    <p class="text-center text-slate-500 dark:text-slate-400 mb-8">Select your topic and start practicing!</p>

                    <!-- Get Started "Empty State" -->
                    <div id="get-started-container" class="text-center p-6 bg-slate-50 dark:bg-slate-700/50 rounded-lg hidden">
                        <h2 class="text-2xl font-semibold mb-3">Welcome to Study Helper!</h2>
                        <p class="text-slate-600 dark:text-slate-300 mb-6">You don't have any subjects yet. Create your first subject and add some questions to get started.</p>
                        <button id="get-started-btn" class="btn btn-primary py-3 px-6">
                            Add Your First Subject
                        </button>
                    </div>

                    <!-- Subject Cards Container -->
                    <div id="subject-cards-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-60 overflow-y-auto pr-2 mb-6">
                        <!-- Subject cards will be populated by JavaScript -->
                    </div>
                    
                    <!-- Quick Actions -->
                    <div id="quick-actions-container" class="grid grid-cols-1 gap-4 mb-6">
                        <button id="random-quiz-btn" class="btn btn-success py-3 px-6 text-lg">
                            ðŸš€ Random Quiz
                        </button>
                    </div>
                    
                    <!-- Quiz Settings -->
                    <div id="quiz-settings-container" class="space-y-6 bg-slate-50 dark:bg-slate-700/50 p-4 rounded-lg border dark:border-slate-700">
                        <h2 class="text-xl font-semibold mb-2">Quiz Settings</h2>
                        
                        <div id="quiz-settings-inputs" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Number of Questions Selection -->
                            <div>
                                <label for="question-count-select" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Number of Questions</label>
                                <select id="question-count-select" class="w-full p-3 border border-slate-300 dark:border-slate-600 dark:bg-slate-700 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="5">5 Questions</option>
                                    <option value="10">10 Questions</option>
                                    <option value="all">All Questions</option>
                                    <option value="custom_count">Custom...</option>
                                </select>
                                <input type="number" id="custom-question-count" class="w-full mt-2 hidden" min="1" placeholder="Enter count">
                            </div>
                            
                            <!-- Time per Question Selection -->
                            <div>
                                <label for="time-limit-select" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Time per Question</Sabel>
                                <select id="time-limit-select" class="w-full p-3 border border-slate-300 dark:border-slate-600 dark:bg-slate-700 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="unlimited">Unlimited</option>
                                    <option value="10">10 Seconds</option>
                                    <option value="20" selected>20 Seconds</option>
                                    <option value="30">30 Seconds</option>
                                    <option value="custom_time">Custom...</option>
                                </select>
                                <input type="number" id="custom-time-limit" class="w-full mt-2 hidden" min="1" placeholder="Enter seconds">
                            </div>
                        </div>
                        
                        <div class="flex items-center">
                            <input id="show-timer-toggle" type="checkbox" class="h-4 w-4 text-indigo-600 border-slate-300 dark:border-slate-600 rounded focus:ring-indigo-500">
                            <label for="show-timer-toggle" class="ml-2 block text-sm text-slate-700 dark:text-slate-300">Show Timer During Quiz</label>
                        </div>
                    </div>
                </div>

                <!-- ===== SCREEN 2: Quiz Screen ===== -->
                <div id="quiz-screen" class="screen screen-hidden">
                    <!-- Header: Timer & Score -->
                    <div class="flex justify-between items-center mb-4">
                        <div id="timer" class="text-lg font-bold text-indigo-600 dark:text-indigo-400">Time: 00:00</div>
                        <div id="score" class="text-lg font-bold text-green-600 dark:text-green-400">Score: 0</div>
                    </div>

                    <!-- Progress Bar -->
                    <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2.5 mb-6">
                        <div id="progress-bar-inner" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>

                    <!-- Question Container -->
                    <div id="question-container" class="mb-6">
                        <h2 id="question-text" class="text-2xl font-semibold mb-6 min-h-[70px]">
                            <!-- Question text goes here -->
                        </h2>
                        <div id="options-container" class="space-y-3">
                            <!-- Option buttons go here -->
                        </div>
                    </div>

                    <!-- Feedback Message -->
                    <p id="feedback-message" class="text-center font-medium min-h-[2em] mb-4"></p>

                    <!-- Next Button -->
                    <button id="next-btn" class="btn btn-secondary w-full py-3 text-lg hidden">
                        Next Question
                    </button>
                    <button id="quit-quiz-btn" class="btn btn-danger w-full py-2 text-sm mt-3">
                        Quit Quiz
                    </button>
                </div>

                <!-- ===== SCREEN 3: Results Screen ===== -->
                <div id="results-screen" class="screen screen-hidden">
                    <h1 class="text-3xl font-bold text-center mb-4">Quiz Complete!</h1>
                    
                    <div class="bg-slate-100 dark:bg-slate-700 rounded-lg p-6 text-center mb-6">
                        <p class="text-lg text-slate-600 dark:text-slate-300">Your final score is:</p>
                        <h2 id="final-score" class="text-5xl font-bold text-indigo-600 dark:text-indigo-400 my-2">0 / 0</h2>
                        <p id="percentage" class="text-2xl font-semibold text-green-600 dark:text-green-400">0%</p>
                    </div>

                    <!-- Performance Insights -->
                    <div id="performance-insights" class="mb-6">
                        <h3 class="text-xl font-semibold mb-3">Performance Insights</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-center">
                            <div class="bg-slate-50 dark:bg-slate-700 p-3 rounded-lg">
                                <p class="text-sm text-slate-500 dark:text-slate-400">Fastest Answer</p>
                                <p id="fastest-answer" class="text-lg font-semibold">N/A</p>
                            </div>
                            <div class="bg-slate-50 dark:bg-slate-700 p-3 rounded-lg">
                                <p class="text-sm text-slate-500 dark:text-slate-400">Weekly Accuracy</p>
                                <p id="weekly-accuracy" class="text-lg font-semibold">N/A</p>
                            </div>
                            <div class="bg-slate-50 dark:bg-slate-700 p-3 rounded-lg">
                                <p class="text-sm text-slate-500 dark:text-slate-400">Strongest Subject</p>
                                <p id="strongest-subject" class="text-lg font-semibold">N/A</p>
                            </div>
                        </div>
                    </div>

                    <!-- Show Correct Answers Section -->
                    <div id="results-summary-container" class="mb-6">
                        <h3 class="text-xl font-semibold mb-3">Review Your Answers:</h3>
                        <div id="results-summary" class="space-y-4 max-h-60 overflow-y-auto pr-2">
                            <!-- Results summary goes here -->
                        </div>
                    </div>

                    <!-- Restart Button -->
                    <button id="restart-btn" class="btn btn-primary w-full py-3 text-lg">
                        Back to Home
                    </button>
                </div>

                <!-- ===== SCREEN 4: Admin Panel Screen ===== -->
                <div id="admin-screen" class="screen screen-hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-3xl font-extrabold">Question Bank</h1>
                    </div>

                    <!-- All sections are now in a single column -->
                    <div class="space-y-8 max-h-[70vh] overflow-y-auto pr-2">
                        
                        <!-- Section 1: Manage Subjects -->
                        <div class="bg-slate-50 dark:bg-slate-700/50 p-5 rounded-lg border dark:border-slate-700">
                            <h3 class="text-xl font-semibold mb-4 text-slate-700 dark:text-slate-300">Manage Subjects</h3>
                            
                            <!-- Add Subject -->
                            <div class="mb-4">
                                <label for="new-subject-name" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Add New Subject</label>
                                <div class="flex gap-2">
                                    <input type="text" id="new-subject-name" placeholder="Enter new subject name" class="w-full p-2 border border-slate-300 dark:border-slate-600 dark:bg-slate-700 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <button id="add-subject-btn" class="btn btn-primary">Add</button>
                                </div>
                            </div>

                            <!-- View/Edit Subjects -->
                            <div>
                                <h4 class="text-lg font-semibold mb-2 text-slate-700 dark:text-slate-300">All Subjects</h4>
                                <p class="text-sm text-slate-500 dark:text-slate-400 mb-3">Click a subject's name to view its questions. Click [Edit] to rename.</p>
                                <ul id="admin-subject-list" class="space-y-2 max-h-48 overflow-y-auto pr-2">
                                    <!-- Subject list will be populated by JavaScript -->
                                </ul>
                            </div>
                        </div>

                        <!-- Section 2: Edit Questions Panel (Hidden by default) -->
                        <div id="edit-questions-panel" class="bg-slate-50 dark:bg-slate-700/50 p-5 rounded-lg border dark:border-slate-700 hidden">
                            <div class="flex justify-between items-center mb-4">
                                <h3 id="edit-questions-title" class="text-xl font-semibold text-slate-700 dark:text-slate-300">Edit Questions</h3>
                                <button id="add-question-modal-btn" class="btn btn-primary text-sm">Add New Question</button>
                            </div>
                            <ul id="question-edit-list" class="space-y-2 max-h-60 overflow-y-auto pr-2">
                                <!-- Question list will be populated by JavaScript -->
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- ===== SCREEN 5: History Screen ===== -->
                <div id="history-screen" class="screen screen-hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-3xl font-extrabold">Quiz History</h1>
                    </div>

                    <!-- Overall Stats -->
                    <div id="overall-stats" class="mb-6">
                        <h3 class="text-xl font-semibold mb-3">Overall Statistics</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-center">
                            <div class="bg-slate-50 dark:bg-slate-700 p-3 rounded-lg">
                                <p class="text-sm text-slate-500 dark:text-slate-400">Total Quizzes</p>
                                <p id="stat-total-quizzes" class="text-lg font-semibold">0</p>
                            </div>
                            <div class="bg-slate-50 dark:bg-slate-700 p-3 rounded-lg">
                                <p class="text-sm text-slate-500 dark:text-slate-400">Total Questions</p>
                                <p id="stat-total-questions" class="text-lg font-semibold">0</p>
                            </div>
                            <div class="bg-slate-50 dark:bg-slate-700 p-3 rounded-lg">
                                <p class="text-sm text-slate-500 dark:text-slate-400">Avg. Score</p>
                                <p id="stat-avg-score" class="text-lg font-semibold">0%</p>
                            </div>
                            <div class="bg-slate-50 dark:bg-slate-700 p-3 rounded-lg">
                                <p class="text-sm text-slate-500 dark:text-slate-400">Best Subject</p>
                                <p id="stat-best-subject" class="text-lg font-semibold">N/A</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex gap-2 items-center">
                            <label for="sort-history-by" class="text-sm font-medium">Sort by:</label>
                            <select id="sort-history-by" class="text-sm p-1 border border-slate-300 dark:border-slate-600 dark:bg-slate-700 rounded-md">
                                <option value="date_desc">Date (Newest)</option>
                                <option value="date_asc">Date (Oldest)</option>
                                <option value="score_desc">Score (Highest)</option>
                                <option value="score_asc">Score (Lowest)</option>
                            </select>
                        </div>
                        <button id="clear-history-btn" class="btn btn-danger py-1 px-3 text-sm">
                            Clear All History
                        </button>
                    </div>
                    
                    <!-- History Table -->
                    <div id="history-table-container" class="w-full max-h-96 overflow-y-auto rounded-lg border dark:border-slate-700">
                        <table id="history-table" class="w-full">
                            <thead class="sticky top-0">
                                <tr>
                                    <th class="w-2/5">Subject</th>
                                    <th class="w-1/5">Score</th>
                                    <th class="w-2/5">Date</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body">
                                <!-- History rows will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    <p id="no-history-msg" class="text-center text-slate-500 dark:text-slate-400 mt-6 hidden">No quiz history found. Complete a quiz to see your results!</p>
                </div>
                
                <!-- ===== SCREEN 6: Settings & Data Screen ===== -->
                <div id="data-screen" class="screen screen-hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-3xl font-extrabold">Settings & Data</h1>
                    </div>
                    
                    <div class="space-y-8 max-h-[70vh] overflow-y-auto pr-2">
                        <!-- Section 1: Import/Export Section -->
                        <div class="bg-slate-50 dark:bg-slate-700/50 p-5 rounded-lg border dark:border-slate-700">
                            <h3 class="text-xl font-semibold text-slate-700 dark:text-slate-300 mb-4">Import / Export Data</h3>
                            
                            <!-- File Inputs -->
                            <input type="file" id="import-subject-file" class="hidden-file-input" accept=".json" multiple>
                            <input type="file" id="import-backup-file" class="hidden-file-input" accept=".json">
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <!-- Import -->
                                <div class="flex flex-col space-y-3">
                                    <label id="import-subject-file-btn" for="import-subject-file" class="btn btn-warning w-full text-center">Import Subject(s)</label>
                                    <label id="import-backup-file-btn" for="import-backup-file" class="btn btn-warning w-full text-center !bg-orange-700 hover:!bg-orange-800">Import Full Backup</label>
                                </div>
                                <!-- Export -->
                                <div class="flex flex-col space-y-3">
                                    <button id="export-subject-btn" class="btn btn-primary !bg-indigo-500 hover:!bg-indigo-600 w-full">Export Subjects...</button>
                                    <button id="export-backup-btn" class="btn btn-primary w-full">Export Full Backup</button>
                                </div>
                            </div>
                        </div>

                        <!-- Section 2: Danger Zone -->
                        <div class="bg-red-50 dark:bg-red-900/20 p-5 rounded-lg border border-red-200 dark:border-red-900/50">
                            <h3 class="text-xl font-semibold text-red-800 dark:text-red-300 mb-4">Danger Zone</h3>
                            <p class="text-sm text-red-700 dark:text-red-400 mb-4">These actions cannot be undone. Be careful.</p>
                            <div class="flex gap-4">
                                <button id="reset-all-data-btn" class="btn btn-danger w-full">
                                    Reset All App Data
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

            </div> <!-- End of Main Content Card -->
        </div> <!-- End of Content Area -->
    </main> <!-- End of Main Content -->

    <!-- ===== MODAL: Add/Edit Question ===== -->
    <div id="question-modal-overlay" class="modal-overlay">
        <div id="question-modal-content" class="modal-content max-w-lg">
            <!-- Form is dynamically moved here -->
            <div id="question-form-container" class="space-y-4">
                <h3 id="question-form-title" class="text-2xl font-semibold text-slate-800 dark:text-slate-200">Add New Question</h3>
                
                <input type="hidden" id="editing-question-index" value="-1">
                <input type="hidden" id="editing-subject-id" value="">

                <div>
                    <label for="admin-subject-select" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Subject</label>
                    <select id="admin-subject-select" class="w-full p-2 border border-slate-300 dark:border-slate-600 dark:bg-slate-700 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>

                <div>
                    <label for="admin-question-text" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Question</label>
                    <textarea id="admin-question-text" rows="2" placeholder="What is...?" class="w-full p-2 border border-slate-300 dark:border-slate-600 dark:bg-slate-700 rounded-lg focus:ring-2 focus:ring-indigo-500"></textarea>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label for="admin-option-1" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Option 1 (Correct Answer)</label>
                        <input type="text" id="admin-option-1" placeholder="The Correct Answer" class="w-full p-2 border border-slate-300 dark:border-slate-600 dark:bg-slate-700 rounded-lg focus:ring-2 focus:ring-green-500">
                    </div>
                    <div>
                        <label for="admin-option-2" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Option 2</label>
                        <input type="text" id="admin-option-2" placeholder="Wrong Answer 1" class="w-full p-2 border border-slate-300 dark:border-slate-600 dark:bg-slate-700 rounded-lg">
                    </div>
                    <div>
                        <label for="admin-option-3" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Option 3</label>
                        <input type="text" id="admin-option-3" placeholder="Wrong Answer 2" class="w-full p-2 border border-slate-300 dark:border-slate-600 dark:bg-slate-700 rounded-lg">
                    </div>
                    <div>
                        <label for="admin-option-4" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Option 4</label>
                        <input type="text" id="admin-option-4" placeholder="Wrong Answer 3" class="w-full p-2 border border-slate-300 dark:border-slate-600 dark:bg-slate-700 rounded-lg">
                    </div>
                </div>
                <p class="text-xs text-slate-500 dark:text-slate-400 -mt-2">Note: For simplicity, **Option 1** is always the correct answer when adding/editing.</p>


                <div class="flex gap-3 pt-4">
                    <button id="save-question-btn" class="btn btn-success w-full py-3">
                        Save Question
                    </button>
                    <button id="cancel-edit-btn" class="btn btn-secondary w-full py-3">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ===== MODAL: Generic Confirmation ===== -->
    <div id="confirm-modal-overlay" class="modal-overlay">
        <div id="confirm-modal-content" class="modal-content">
            <h3 id="confirm-modal-title" class="text-2xl font-semibold text-slate-800 dark:text-slate-200 mb-4">Are you sure?</h3>
            <p id="confirm-modal-message" class="text-slate-600 dark:text-slate-300 mb-6">This action cannot be undone.</p>
            <div class="flex gap-3">
                <button id="confirm-modal-cancel-btn" class="btn btn-secondary w-full">Cancel</button>
                <button id="confirm-modal-confirm-btn" class="btn btn-danger w-full">Confirm</button>
            </div>
        </div>
    </div>
    
    <!-- ===== MODAL: Export Subjects ===== -->
    <div id="export-modal-overlay" class="modal-overlay">
        <div id="export-modal-content" class="modal-content">
            <h3 class="text-2xl font-semibold text-slate-800 dark:text-slate-200 mb-4">Export Subjects</h3>
            <p class="text-slate-600 dark:text-slate-300 mb-4">Select the subjects you want to export. You can select one or multiple.</p>
            
            <div id="export-subject-list" class="space-y-2 max-h-60 overflow-y-auto border dark:border-slate-700 p-3 rounded-md mb-6">
                <!-- Subject list with checkboxes will be populated here -->
            </div>
            
            <div class="flex gap-3">
                <button id="export-modal-cancel-btn" class="btn btn-secondary w-full">Cancel</button>
                <button id="export-modal-confirm-btn" class="btn btn-primary w-full">Export Selected</button>
            </div>
        </div>
    </div>

    <!-- ===== JavaScript ===== -->
    
    <!-- Firebase SDKs -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signInWithPopup,
            GoogleAuthProvider,
            sendPasswordResetEmail,
            signOut,
            signInWithCustomToken,
            signInAnonymously
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            addDoc,
            updateDoc,
            deleteDoc,
            collection, 
            query, 
            onSnapshot,
            writeBatch,
            getDocs,
            Timestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 0. FIREBASE CONFIG ---
        // Get Firebase config from global scope (provided by Canvas environment)
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Initialize Firebase
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase initialization error:", e);
            showToast("Could not connect to Firebase. Please check config.", "error");
        }
        
        // --- 1. LOCAL STORAGE KEYS ---
        // Local storage is only for theme, not data
        const THEME_KEY = 'theme';

        // --- 2. DOM Element References ---
        // App Containers
        const appElements = document.querySelectorAll('.app-hidden');
        
        // Layout
        const sidebar = document.getElementById('sidebar');
        const sidebarCloseBtn = document.getElementById('sidebar-close-btn');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const mainContent = document.getElementById('main-content');
        const hamburgerBtn = document.getElementById('hamburger-btn');
        const sidebarLinks = document.querySelectorAll('.sidebar-link');
        const allScreens = document.querySelectorAll('.screen');
        
        // Header
        const header = document.getElementById('header');
        const headerTitle = document.getElementById('header-title');
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const themeIconLight = document.getElementById('theme-icon-light');
        const themeIconDark = document.getElementById('theme-icon-dark');
        const themeToggleText = document.getElementById('theme-toggle-text');
        const userDisplay = document.getElementById('user-display');
        const logoutBtn = document.getElementById('logout-btn');
        
        // Auth Overlay
        const authOverlay = document.getElementById('auth-overlay');
        const authModal = document.getElementById('auth-modal');
        const authError = document.getElementById('auth-error');
        const authLoader = document.getElementById('auth-loader');
        const authTabLogin = document.getElementById('auth-tab-login');
        const authTabSignup = document.getElementById('auth-tab-signup');
        // Auth Forms
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const forgotForm = document.getElementById('forgot-form');
        // Login
        const loginEmail = document.getElementById('login-email');
        const loginPassword = document.getElementById('login-password');
        const loginBtn = document.getElementById('login-btn');
        const forgotPassLink = document.getElementById('forgot-pass-link');
        const googleSigninBtn = document.getElementById('google-signin-btn');
        // Signup
        const signupEmail = document.getElementById('signup-email');
        const signupPassword = document.getElementById('signup-password');
        const signupBtn = document.getElementById('signup-btn');
        // Forgot
        const forgotEmail = document.getElementById('forgot-email');
        const forgotBtn = document.getElementById('forgot-btn');
        const backToLoginLink = document.getElementById('back-to-login-link');
        
        // Screens
        const homeScreen = document.getElementById('home-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const resultsScreen = document.getElementById('results-screen');
        const adminScreen = document.getElementById('admin-screen');
        const historyScreen = document.getElementById('history-screen');
        const dataScreen = document.getElementById('data-screen');

        // Home Screen
        const subjectCardsContainer = document.getElementById('subject-cards-container');
        const getStartedContainer = document.getElementById('get-started-container');
        const getStartedBtn = document.getElementById('get-started-btn');
        const quickActionsContainer = document.getElementById('quick-actions-container');
        const quizSettingsContainer = document.getElementById('quiz-settings-container');
        const randomQuizBtn = document.getElementById('random-quiz-btn');
        
        // Home Screen (Settings)
        const questionCountSelect = document.getElementById('question-count-select');
        const customQuestionCount = document.getElementById('custom-question-count');
        const timeLimitSelect = document.getElementById('time-limit-select');
        const customTimeLimit = document.getElementById('custom-time-limit');
        const showTimerToggle = document.getElementById('show-timer-toggle');

        // Quiz Screen
        const timerDisplay = document.getElementById('timer');
        const scoreDisplay = document.getElementById('score');
        const progressBarInner = document.getElementById('progress-bar-inner');
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const feedbackMessage = document.getElementById('feedback-message');
        const nextBtn = document.getElementById('next-btn');
        const quitQuizBtn = document.getElementById('quit-quiz-btn');

        // Results Screen
        const finalScore = document.getElementById('final-score');
        const percentageDisplay = document.getElementById('percentage');
        const resultsSummary = document.getElementById('results-summary');
        const restartBtn = document.getElementById('restart-btn');
        const fastestAnswer = document.getElementById('fastest-answer');
        const weeklyAccuracy = document.getElementById('weekly-accuracy');
        const strongestSubject = document.getElementById('strongest-subject');

        // Admin Screen
        const newSubjectName = document.getElementById('new-subject-name');
        const addSubjectBtn = document.getElementById('add-subject-btn');
        const adminSubjectList = document.getElementById('admin-subject-list');
        const editQuestionsPanel = document.getElementById('edit-questions-panel');
        const editQuestionsTitle = document.getElementById('edit-questions-title');
        const questionEditList = document.getElementById('question-edit-list');
        const addQuestionModalBtn = document.getElementById('add-question-modal-btn');
        
        // Question Modal
        const questionModalOverlay = document.getElementById('question-modal-overlay');
        const questionFormTitle = document.getElementById('question-form-title');
        const adminSubjectSelect = document.getElementById('admin-subject-select');
        const adminQuestionText = document.getElementById('admin-question-text');
        const adminOption1 = document.getElementById('admin-option-1');
        const adminOption2 = document.getElementById('admin-option-2');
        const adminOption3 = document.getElementById('admin-option-3');
        const adminOption4 = document.getElementById('admin-option-4');
        const saveQuestionBtn = document.getElementById('save-question-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const editingQuestionIndex = document.getElementById('editing-question-index');
        const editingSubjectId = document.getElementById('editing-subject-id');
        
        // Confirmation Modal
        const confirmModalOverlay = document.getElementById('confirm-modal-overlay');
        const confirmModalTitle = document.getElementById('confirm-modal-title');
        const confirmModalMessage = document.getElementById('confirm-modal-message');
        const confirmModalCancelBtn = document.getElementById('confirm-modal-cancel-btn');
        const confirmModalConfirmBtn = document.getElementById('confirm-modal-confirm-btn');
        
        // Export Modal
        const exportModalOverlay = document.getElementById('export-modal-overlay');
        const exportSubjectList = document.getElementById('export-subject-list');
        const exportModalCancelBtn = document.getElementById('export-modal-cancel-btn');
        const exportModalConfirmBtn = document.getElementById('export-modal-confirm-btn');

        // History Screen
        const sortHistoryBy = document.getElementById('sort-history-by');
        const clearHistoryBtn = document.getElementById('clear-history-btn');
        const historyTableBody = document.getElementById('history-table-body');
        const noHistoryMsg = document.getElementById('no-history-msg');
        const historyTableContainer = document.getElementById('history-table-container');
        // History Stats
        const statTotalQuizzes = document.getElementById('stat-total-quizzes');
        const statTotalQuestions = document.getElementById('stat-total-questions');
        const statAvgScore = document.getElementById('stat-avg-score');
        const statBestSubject = document.getElementById('stat-best-subject');

        // Data Screen
        const importSubjectFileInput = document.getElementById('import-subject-file');
        const importBackupFileInput = document.getElementById('import-backup-file');
        const importSubjectFileBtn = document.getElementById('import-subject-file-btn');
        const importBackupFileBtn = document.getElementById('import-backup-file-btn');
        const exportSubjectBtn = document.getElementById('export-subject-btn');
        const exportBackupBtn = document.getElementById('export-backup-btn');
        const resetAllDataBtn = document.getElementById('reset-all-data-btn');

        // --- 3. State Variables ---
        let userId = null; // Current user's UID
        let quizData = { subjects: [] }; // Local cache for subjects
        let quizHistory = []; // Local cache for history
        let quizSettings = {}; // Local cache for settings
        
        // Firestore unsubscribe functions
        let unsubSubjects = null;
        let unsubHistory = null;
        let unsubSettings = null;

        // Quiz state
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let currentSubjectName = '';
        let score = 0;
        let timerInterval;
        let timePerQuestion = 20; // in seconds
        let timeRemaining = 0;
        let timeElapsed = 0;
        let isTimerVisible = true;
        let questionStartTime = 0;
        let answerTimes = [];
        let userAnswers = [];
        let onConfirmCallback = null; // For modal
        let subjectsToImport = []; // For import logic

        // --- 4. Core Functions ---
        
        /**
         * Initializes the application
         */
        function init() {
            loadTheme();
            addAuthEventListeners(); // Add listeners for login forms
            
            // Listen for auth state changes
            onAuthStateChanged(auth, handleAuthStateChange);
            
            // Auto-sign in using token if available
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                setAuthLoading(true);
                signInWithCustomToken(auth, __initial_auth_token)
                    .catch((error) => {
                        console.error("Custom token sign-in error:", error);
                        setAuthLoading(false);
                    });
            } else {
                // If no token, user must log in manually
                console.log("No auth token found. User must log in.");
            }
        }
        
        /**
         * Initializes the main app UI (called after login)
         */
        function initAppUI() {
            addAppEventListeners();
            addDynamicListeners();
            showScreen('home-screen'); // Show home screen by default
        }

        /**
         * Adds event listeners for auth forms
         */
        function addAuthEventListeners() {
            // Tab switching
            authTabLogin.addEventListener('click', () => switchAuthTab('login'));
            authTabSignup.addEventListener('click', () => switchAuthTab('signup'));
            forgotPassLink.addEventListener('click', (e) => {
                e.preventDefault();
                switchAuthTab('forgot');
            });
            backToLoginLink.addEventListener('click', (e) => {
                e.preventDefault();
                switchAuthTab('login');
            });

            // Form submissions
            loginForm.addEventListener('submit', handleEmailLogin);
            signupForm.addEventListener('submit', handleEmailSignUp);
            forgotForm.addEventListener('submit', handleForgotPassword);
            googleSigninBtn.addEventListener('click', handleGoogleSignIn);
            logoutBtn.addEventListener('click', handleLogout);
        }

        /**
         * Adds all application event listeners (non-auth)
         */
        function addAppEventListeners() {
            // Layout/Navigation
            hamburgerBtn.addEventListener('click', () => toggleSidebar(true));
            sidebarCloseBtn.addEventListener('click', () => toggleSidebar(false));
            sidebarOverlay.addEventListener('click', () => toggleSidebar(false));
            themeToggleBtn.addEventListener('click', toggleTheme);
            sidebarLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    const screenId = e.currentTarget.dataset.screen;
                    if (screenId) {
                        showScreen(screenId);
                        // Close sidebar on mobile after navigation
                        if (window.innerWidth < 768) {
                            toggleSidebar(false);
                        }
                    }
                });
            });
            getStartedBtn.addEventListener('click', () => showScreen('admin-screen'));

            // Quiz Logic
            randomQuizBtn.addEventListener('click', startRandomQuiz);
            nextBtn.addEventListener('click', nextQuestion);
            quitQuizBtn.addEventListener('click', () => {
                showConfirmationModal(
                    "Quit Quiz?",
                    "Are you sure you want to quit? Your progress for this quiz will not be saved.",
                    () => endQuiz(true), // onConfirm
                    "Yes, Quit"
                );
            });
            restartBtn.addEventListener('click', restartQuiz);
            
            // Settings
            questionCountSelect.addEventListener('change', handleSettingChange);
            customQuestionCount.addEventListener('change', handleSettingChange);
            timeLimitSelect.addEventListener('change', handleSettingChange);
            customTimeLimit.addEventListener('change', handleSettingChange);
            showTimerToggle.addEventListener('change', handleSettingChange);

            // History
            sortHistoryBy.addEventListener('change', populateHistoryTable);
            clearHistoryBtn.addEventListener('click', requestClearHistory);

            // Admin: Subject
            addSubjectBtn.addEventListener('click', addSubject);
            addQuestionModalBtn.addEventListener('click', () => {
                const subjectName = editQuestionsTitle.textContent.replace('Questions for: ', '');
                const subject = quizData.subjects.find(s => s.name === subjectName);
                if (subject) {
                    openQuestionModal(subject.id);
                }
            });

            // Admin: Question Modal
            saveQuestionBtn.addEventListener('click', saveQuestion);
            cancelEditBtn.addEventListener('click', closeQuestionModal);
            questionModalOverlay.addEventListener('click', (e) => {
                if (e.target === questionModalOverlay) closeQuestionModal();
            });

            // Confirmation Modal
            confirmModalCancelBtn.addEventListener('click', closeConfirmationModal);
            confirmModalConfirmBtn.addEventListener('click', () => {
                if (onConfirmCallback) {
                    onConfirmCallback();
                }
                closeConfirmationModal();
            });
            confirmModalOverlay.addEventListener('click', (e) => {
                if (e.target === confirmModalOverlay) closeConfirmationModal();
            });
            
            // Export Modal
            exportModalCancelBtn.addEventListener('click', closeExportModal);
            exportModalConfirmBtn.addEventListener('click', handleExportSelected);
            exportModalOverlay.addEventListener('click', (e) => {
                if (e.target === exportModalOverlay) closeExportModal();
            });

            // Data Screen: Import/Export
            importSubjectFileBtn.addEventListener('click', () => importSubjectFileInput.click());
            importBackupFileBtn.addEventListener('click', () => importBackupFileInput.click());
            importSubjectFileInput.addEventListener('change', importSubjectFile);
            importBackupFileInput.addEventListener('change', importBackupFile);
            exportSubjectBtn.addEventListener('click', openExportModal);
            exportBackupBtn.addEventListener('click', exportBackupFile);
            resetAllDataBtn.addEventListener('click', requestResetAllData);
        }

        /**
         * Adds event listeners for dynamically created buttons
         */
        function addDynamicListeners() {
            document.body.addEventListener('click', function(e) {
                // Home Screen Cards
                if (e.target.classList.contains('start-quiz-btn')) {
                    startQuiz(e.target.dataset.id);
                }
                if (e.target.classList.contains('delete-subject-home-btn')) {
                    requestDeleteSubject(e.target.dataset.id, e.target.dataset.name);
                }
                
                // Admin Subject List buttons
                if (e.target.classList.contains('edit-subject-btn')) {
                    editSubject(e.target.dataset.id, e.target.closest('li'));
                }
                if (e.target.classList.contains('save-subject-btn')) {
                    saveSubjectEdit(e.target.dataset.id, e.target.closest('li'));
                }
                if (e.target.classList.contains('cancel-subject-btn')) {
                    cancelSubjectEdit(e.target.closest('li'));
                }
                if (e.target.classList.contains('delete-subject-btn')) {
                    requestDeleteSubject(e.target.dataset.id, e.target.dataset.name);
                }
                if (e.target.classList.contains('view-subject-questions')) {
                    showQuestionsForSubject(e.target.dataset.id);
                }

                // Admin Question List buttons
                if (e.target.classList.contains('edit-q-btn')) {
                    openQuestionModal(e.target.dataset.subjectId, e.target.dataset.qIndex);
                }
                if (e.target.classList.contains('delete-q-btn')) {
                    requestDeleteQuestion(e.target.dataset.subjectId, e.target.dataset.qIndex);
                }
            });
        }
        
        // --- Auth Functions ---

        /**
         * Gatekeeper function, called when auth state changes
         */
        function handleAuthStateChange(user) {
            setAuthLoading(false); // Hide loader once auth state is resolved
            if (user) {
                // User is signed in
                userId = user.uid;
                userDisplay.textContent = user.email;
                
                // Show main app, hide auth
                authOverlay.classList.add('hidden');
                appElements.forEach(el => el.classList.remove('app-hidden'));
                
                // Initialize app UI and load data
                initAppUI();
                loadAllFirestoreData();

            } else {
                // User is signed out
                userId = null;
                
                // Show auth, hide main app
                authOverlay.classList.remove('hidden');
                appElements.forEach(el => el.classList.add('app-hidden'));
                
                // Unsubscribe from any active listeners
                unloadAllFirestoreData();
                
                // Clear local data caches
                quizData = { subjects: [] };
                quizHistory = [];
                
                // Clear UI
                checkEmptyState();
                populateHistoryTable();
                populateOverallStats();
            }
        }

        function switchAuthTab(formName) {
            authError.textContent = ''; // Clear errors
            [loginForm, signupForm, forgotForm].forEach(form => {
                form.classList.toggle('hidden', form.id !== `${formName}-form`);
            });
            [authTabLogin, authTabSignup].forEach(tab => {
                tab.classList.toggle('active', tab.dataset.form === `${formName}-form`);
            });
        }

        function setAuthLoading(isLoading) {
            authLoader.classList.toggle('hidden', !isLoading);
            [loginBtn, signupBtn, forgotBtn, googleSigninBtn].forEach(btn => {
                btn.disabled = isLoading;
            });
        }

        async function handleEmailLogin(e) {
            e.preventDefault();
            authError.textContent = '';
            setAuthLoading(true);
            try {
                await signInWithEmailAndPassword(auth, loginEmail.value, loginPassword.value);
                // onAuthStateChanged will handle the rest
                showToast("Login successful!", "success");
            } catch (error) {
                authError.textContent = getFriendlyAuthError(error);
                setAuthLoading(false);
            }
        }

        async function handleEmailSignUp(e) {
            e.preventDefault();
            authError.textContent = '';
            setAuthLoading(true);
            try {
                await createUserWithEmailAndPassword(auth, signupEmail.value, signupPassword.value);
                // onAuthStateChanged will handle the rest
                showToast("Account created successfully!", "success");
            } catch (error) {
                authError.textContent = getFriendlyAuthError(error);
                setAuthLoading(false);
            }
        }
        
        async function handleGoogleSignIn() {
            authError.textContent = '';
            setAuthLoading(true);
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
                // onAuthStateChanged will handle the rest
                showToast("Signed in with Google!", "success");
            } catch (error) {
                authError.textContent = getFriendlyAuthError(error);
                setAuthLoading(false);
            }
        }
        
        async function handleForgotPassword(e) {
            e.preventDefault();
            authError.textContent = '';
            setAuthLoading(true);
            try {
                await sendPasswordResetEmail(auth, forgotEmail.value);
                showToast("Password reset email sent. Check your inbox.", "success");
                switchAuthTab('login');
            } catch (error) {
                authError.textContent = getFriendlyAuthError(error);
            }
            setAuthLoading(false);
        }

        async function handleLogout() {
            try {
                await signOut(auth);
                // onAuthStateChanged will handle the rest
                showToast("Logged out successfully.", "success");
            } catch (error) {
                showToast(`Logout failed: ${error.message}`, "error");
            }
        }
        
        function getFriendlyAuthError(error) {
            switch (error.code) {
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                    return 'Invalid email or password.';
                case 'auth/email-already-in-use':
                    return 'This email is already in use.';
                case 'auth/weak-password':
                    return 'Password must be at least 6 characters.';
                case 'auth/invalid-email':
                    return 'Please enter a valid email address.';
                case 'auth/popup-closed-by-user':
                    return 'Sign-in popup closed. Please try again.';
                default:
                    return 'An error occurred. Please try again.';
            }
        }

        // --- Layout & Screen Management ---

        function toggleSidebar(open) {
            if (open) {
                sidebar.classList.remove('-translate-x-full');
                sidebarOverlay.classList.remove('hidden');
                header.classList.remove('md:left-0');
                header.classList.add('md:left-64');
                mainContent.classList.remove('md:ml-0');
                mainContent.classList.add('md:ml-64');
            } else {
                sidebar.classList.add('-translate-x-full');
                sidebarOverlay.classList.add('hidden');
                header.classList.remove('md:left-64');
                header.classList.add('md:left-0');
                mainContent.classList.remove('md:ml-64');
                mainContent.classList.add('md:ml-0');
            }
        }

        function showScreen(screenId) {
            let title = 'Home';
            
            if (screenId !== 'quiz-screen' && screenId !== 'results-screen') {
                sidebar.classList.add('md:translate-x-0');
                header.classList.add('md:left-64');
                mainContent.classList.add('md:ml-64');
                hamburgerBtn.classList.remove('md:hidden');
                
            } else {
                sidebar.classList.remove('md:translate-x-0');
                header.classList.remove('md:left-64');
                mainContent.classList.remove('md:ml-64');
                hamburgerBtn.classList.add('md:hidden');
                
                if (window.innerWidth < 768) {
                    toggleSidebar(false);
                }
            }

            allScreens.forEach(screen => {
                screen.classList.toggle('screen-hidden', screen.id !== screenId);
                if (screen.id === screenId) {
                    screen.style.animation = 'fadeIn 0.3s ease-out';
                    setTimeout(() => screen.style.animation = '', 300);
                }
            });
            
            sidebarLinks.forEach(link => {
                link.classList.toggle('active', link.dataset.screen === screenId);
                if (link.dataset.screen === screenId) {
                    title = link.querySelector('span').textContent;
                }
            });
            
            if(screenId === 'quiz-screen') title = 'Quiz in Progress';
            if(screenId === 'results-screen') title = 'Quiz Results';
            
            headerTitle.textContent = title;
            
            // Refresh dynamic content when showing screen
            if (screenId === 'home-screen') {
                checkEmptyState();
                checkRandomQuizButton();
            }
            if (screenId === 'admin-screen') {
                populateAdminControls();
                editQuestionsPanel.classList.add('hidden');
            }
            if (screenId === 'history-screen') {
                populateHistoryTable();
                populateOverallStats();
            }
            if (screenId === 'data-screen') {
                populateExportSubjectButton();
            }
        }
        
        function checkEmptyState() {
            const hasSubjects = quizData && quizData.subjects.length > 0;
            getStartedContainer.classList.toggle('hidden', hasSubjects);
            subjectCardsContainer.classList.toggle('hidden', !hasSubjects);
            quickActionsContainer.classList.toggle('hidden', !hasSubjects);
            quizSettingsContainer.classList.toggle('hidden', !hasSubjects);
            
            if (hasSubjects) {
                populateSubjectCards();
            }
        }
        
        // --- Theme Management ---
        
        function loadTheme() {
            if (localStorage.getItem(THEME_KEY) === 'dark' || 
               (!localStorage.getItem(THEME_KEY) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                setTheme('dark');
            } else {
                setTheme('light');
            }
        }
        
        function setTheme(theme) {
            document.documentElement.classList.toggle('dark', theme === 'dark');
            themeIconLight.classList.toggle('hidden', theme === 'dark');
            themeIconDark.classList.toggle('hidden', theme === 'light');
            localStorage.setItem(THEME_KEY, theme);
        }
        
        function toggleTheme() {
            const currentTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            setTheme(currentTheme === 'dark' ? 'light' : 'dark');
        }
        
        // --- Firestore Data Functions ---
        
        /**
         * Detaches all active Firestore listeners
         */
        function unloadAllFirestoreData() {
            if (unsubSubjects) unsubSubjects();
            if (unsubHistory) unsubHistory();
            if (unsubSettings) unsubSettings();
            unsubSubjects = null;
            unsubHistory = null;
            unsubSettings = null;
        }

        /**
         * Attaches all Firestore listeners for the logged-in user
         */
        function loadAllFirestoreData() {
            if (!userId) return;
            
            // Ensure old listeners are detached before attaching new ones
            unloadAllFirestoreData();
            
            // Setup listeners
            setupSettingsListener();
            setupSubjectListener();
            setupHistoryListener();
        }

        /**
         * Loads and listens for changes to user settings
         */
        function setupSettingsListener() {
            if (!userId) return;
            const settingsPath = `artifacts/${appId}/users/${userId}/settings/main`;
            unsubSettings = onSnapshot(doc(db, settingsPath), (settingsDoc) => {
                if (settingsDoc.exists()) {
                    quizSettings = settingsDoc.data();
                } else {
                    // No settings doc, create one with defaults
                    quizSettings = {
                        count: '5', customCount: 10,
                        timeLimit: '20', customTime: 60,
                        showTimer: true
                    };
                    setDoc(doc(db, settingsPath), quizSettings);
                }
                updateSettingsUI();
            });
        }
        
        /**
         * Updates the UI to reflect the loaded quizSettings
         */
        function updateSettingsUI() {
            questionCountSelect.value = quizSettings.count || '5';
            customQuestionCount.value = quizSettings.customCount || 10;
            timeLimitSelect.value = quizSettings.timeLimit || '20';
            customTimeLimit.value = quizSettings.customTime || 60;
            showTimerToggle.checked = quizSettings.showTimer === false ? false : true;
            
            customQuestionCount.classList.toggle('hidden', (quizSettings.count || '5') !== 'custom_count');
            customTimeLimit.classList.toggle('hidden', (quizSettings.timeLimit || '20') !== 'custom_time');
        }

        function handleSettingChange() {
            // Show/hide custom inputs
            customQuestionCount.classList.toggle('hidden', questionCountSelect.value !== 'custom_count');
            customTimeLimit.classList.toggle('hidden', timeLimitSelect.value !== 'custom_time');
            
            saveSettings();
        }

        async function saveSettings() {
            if (!userId) return;
            const settingsPath = `artifacts/${appId}/users/${userId}/settings/main`;
            quizSettings = {
                count: questionCountSelect.value,
                customCount: parseInt(customQuestionCount.value) || 1,
                timeLimit: timeLimitSelect.value,
                customTime: parseInt(customTimeLimit.value) || 1,
                showTimer: showTimerToggle.checked
            };
            try {
                // Use setDoc with merge to create/update
                await setDoc(doc(db, settingsPath), quizSettings, { merge: true });
            } catch (e) {
                console.error("Error saving settings: ", e);
                showToast("Could not save settings.", "error");
            }
        }
        
        function getQuizSettings() {
            const countSetting = quizSettings.count || '5';
            const timeSetting = quizSettings.timeLimit || '20';
            
            const questionCount = (countSetting === 'custom_count') 
                ? quizSettings.customCount
                : (countSetting === 'all' ? 'all' : parseInt(countSetting));

            const timePerQ = (timeSetting === 'custom_time')
                ? quizSettings.customTime
                : (timeSetting === 'unlimited' ? 'unlimited' : parseInt(timeSetting));

            return {
                count: questionCount,
                timeLimit: timePerQ,
                showTimer: quizSettings.showTimer
            };
        }

        /**
         * Loads and listens for changes to user subjects
         */
        function setupSubjectListener() {
            if (!userId) return;
            const subjectsPath = `artifacts/${appId}/users/${userId}/subjects`;
            const q = query(collection(db, subjectsPath));
            
            unsubSubjects = onSnapshot(q, (snapshot) => {
                quizData.subjects = snapshot.docs.map(subjectDoc => ({
                    id: subjectDoc.id,
                    ...subjectDoc.data()
                }));
                
                // Refresh all UI that depends on subjects
                checkEmptyState();
                checkRandomQuizButton();
                populateAdminControls();
                if (!editQuestionsPanel.classList.contains('hidden')) {
                    const currentSubjectId = editingSubjectId.value; // Check if a list is active
                    if(currentSubjectId) showQuestionsForSubject(currentSubjectId);
                }
            }, (error) => {
                console.error("Error loading subjects: ", error);
                showToast("Could not load subjects.", "error");
            });
        }

        /**
         * Loads and listens for changes to user history
         */
        function setupHistoryListener() {
            if (!userId) return;
            const historyPath = `artifacts/${appId}/users/${userId}/history`;
            const q = query(collection(db, historyPath));
            
            unsubHistory = onSnapshot(q, (snapshot) => {
                quizHistory = snapshot.docs.map(historyDoc => {
                    const data = historyDoc.data();
                    // Convert Firestore Timestamps to JS Dates
                    return {
                        id: historyDoc.id,
                        ...data,
                        date: data.date.toDate ? data.date.toDate() : new Date(data.date) 
                    };
                });
                
                // Refresh UI
                populateHistoryTable();
                populateOverallStats();
            }, (error) => {
                console.error("Error loading history: ", error);
                showToast("Could not load history.", "error");
            });
        }

        /**
         * Populates the subject cards on the home screen
         */
        function populateSubjectCards() {
            subjectCardsContainer.innerHTML = '';
            if (!quizData.subjects || quizData.subjects.length === 0) {
                checkEmptyState();
                return;
            }
            
            quizData.subjects.forEach(subject => {
                const card = document.createElement('div');
                card.className = "p-4 bg-slate-50 dark:bg-slate-700/80 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 fade-in";
                card.innerHTML = `
                    <h3 class="font-bold text-lg text-indigo-600 dark:text-indigo-400 truncate">${subject.name}</h3>
                    <p class="text-sm text-slate-500 dark:text-slate-400 mb-3">${subject.questions.length} questions</p>
                    <div class="flex gap-2">
                        <button class="start-quiz-btn btn btn-primary flex-1 text-sm py-2" data-id="${subject.id}" ${subject.questions.length === 0 ? 'disabled' : ''}>Start Quiz</button>
                        <button class="delete-subject-home-btn btn btn-danger !p-2 text-sm" data-id="${subject.id}" data-name="${subject.name}">
                            <svg class="w-4 h-4 pointer-events-none" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg>
                        </button>
                    </div>
                `;
                subjectCardsContainer.appendChild(card);
            });
        }
        
        /**
         * Populates the admin controls (subject list and dropdown)
         */
        function populateAdminControls() {
            adminSubjectList.innerHTML = '';
            adminSubjectSelect.innerHTML = '';

            if (!quizData.subjects || quizData.subjects.length === 0) {
                adminSubjectList.innerHTML = '<li class="!bg-transparent !border-none text-slate-500 dark:text-slate-400">No subjects yet. Add one above.</li>';
                adminSubjectSelect.innerHTML = '<option disabled>Please add a subject first.</option>';
                return;
            }
            
            quizData.subjects.forEach(subject => {
                // Add to admin list
                const li = document.createElement('li');
                li.innerHTML = `
                    <div class="flex-grow">
                        <span class="subject-name-display font-semibold text-indigo-700 dark:text-indigo-400 cursor-pointer view-subject-questions" data-id="${subject.id}">${subject.name}</span>
                        <span class="text-sm text-slate-500 dark:text-slate-400 ml-2">(${subject.questions.length}Q)</span>
                        <div class="subject-edit-form hidden mt-2 flex gap-2">
                            <input type="text" value="${subject.name}" class="w-full p-1 border border-slate-300 dark:border-slate-600 dark:bg-slate-700 rounded-md">
                            <button class="save-subject-btn text-sm bg-green-500 text-white px-2 py-1 rounded-md" data-id="${subject.id}">Save</button>
                            <button class="cancel-subject-btn text-sm bg-slate-200 text-slate-700 px-2 py-1 rounded-md">Cancel</button>
                        </div>
                    </div>
                    <div class="flex-shrink-0 space-x-2">
                        <button class="edit-subject-btn text-sm text-indigo-600 hover:text-indigo-800 dark:text-indigo-400 dark:hover:text-indigo-300 font-medium" data-id="${subject.id}">[Edit]</button>
                        <button class="delete-subject-btn text-sm text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 font-medium" data-id="${subject.id}" data-name="${subject.name}">[Delete]</button>
                    </div>
                `;
                adminSubjectList.appendChild(li);

                // Add to admin dropdown
                const option = document.createElement('option');
                option.value = subject.id;
                option.textContent = subject.name;
                adminSubjectSelect.appendChild(option.cloneNode(true));
            });
        }
        
        // --- History Management (Local UI) ---
        
        function populateHistoryTable() {
            historyTableBody.innerHTML = '';
            
            if (quizHistory.length === 0) {
                noHistoryMsg.classList.remove('hidden');
                historyTableContainer.classList.add('hidden');
                return;
            }
            
            noHistoryMsg.classList.add('hidden');
            historyTableContainer.classList.remove('hidden');

            const sortMethod = sortHistoryBy.value;
            const sortedHistory = [...quizHistory].sort((a, b) => {
                const scoreA = (a.score / a.totalQuestions) || 0;
                const scoreB = (b.score / b.totalQuestions) || 0;
                switch(sortMethod) {
                    case 'date_asc': return new Date(a.date) - new Date(b.date);
                    case 'score_desc': return scoreB - scoreA;
                    case 'score_asc': return scoreA - scoreB;
                    case 'date_desc':
                    default:
                        return new Date(b.date) - new Date(a.date);
                }
            });
            
            sortedHistory.forEach(entry => {
                const tr = document.createElement('tr');
                const date = new Date(entry.date).toLocaleString(undefined, { dateStyle: 'medium', timeStyle: 'short' });
                tr.innerHTML = `
                    <td class="font-medium">${entry.subjectName}</td>
                    <td>${entry.score} / ${entry.totalQuestions} (${((entry.score / entry.totalQuestions) * 100 || 0).toFixed(0)}%)</td>
                    <td class="text-sm text-slate-500 dark:text-slate-400">${date}</td>
                `;
                historyTableBody.appendChild(tr);
            });
        }
        
        function populateOverallStats() {
            const totalQuizzes = quizHistory.length;
            let totalScore = 0;
            let totalQs = 0;
            const subjectStats = {}; 
            
            quizHistory.forEach(entry => {
                totalScore += entry.score;
                totalQs += entry.totalQuestions;
                
                if (!subjectStats[entry.subjectName]) {
                    subjectStats[entry.subjectName] = { score: 0, total: 0 };
                }
                subjectStats[entry.subjectName].score += entry.score;
                subjectStats[entry.subjectName].total += entry.totalQuestions;
            });
            
            const avgScore = totalQs > 0 ? (totalScore / totalQs * 100) : 0;
            
            let bestSubject = 'N/A';
            let bestAvg = -1;
            
            Object.keys(subjectStats).forEach(subjectName => {
                const stats = subjectStats[subjectName];
                if (stats.total >= 5) { 
                    const avg = stats.total > 0 ? (stats.score / stats.total) : 0;
                    if (avg > bestAvg) {
                        bestAvg = avg;
                        bestSubject = subjectName;
                    }
                }
            });

            statTotalQuizzes.textContent = totalQuizzes;
            statTotalQuestions.textContent = totalQs;
            statAvgScore.textContent = `${avgScore.toFixed(1)}%`;
            statBestSubject.textContent = bestSubject;
        }

        function requestClearHistory() {
            showConfirmationModal(
                "Clear All History?",
                "Are you sure you want to delete ALL quiz history? This cannot be undone.",
                clearHistory,
                "Yes, Delete All"
            );
        }
        
        async function clearHistory() {
            if (!userId) return;
            const historyPath = `artifacts/${appId}/users/${userId}/history`;
            try {
                // Get all docs in the collection
                const querySnapshot = await getDocs(query(collection(db, historyPath)));
                const batch = writeBatch(db);
                querySnapshot.docs.forEach(historyDoc => {
                    batch.delete(historyDoc.ref);
                });
                await batch.commit();
                showToast("Quiz history cleared.", "success");
                // UI will update via onSnapshot
            } catch (e) {
                console.error("Error clearing history: ", e);
                showToast("Could not clear history.", "error");
            }
        }

        // --- Admin Panel: Subject Functions (Firestore) ---
        
        async function addSubject() {
            if (!userId) return;
            const subjectsPath = `artifacts/${appId}/users/${userId}/subjects`;
            const name = newSubjectName.value.trim();
            
            if (!name) {
                showToast("Subject name cannot be empty.", "error");
                return;
            }
            if (quizData.subjects.find(s => s.name.toLowerCase() === name.toLowerCase())) {
                showToast("Subject with this name already exists.", "error");
                return;
            }

            try {
                await addDoc(collection(db, subjectsPath), {
                    name: name,
                    questions: []
                });
                newSubjectName.value = '';
                showToast(`Subject '${name}' added successfully.`, "success");
                // UI will update via onSnapshot
            } catch (e) {
                console.error("Error adding subject: ", e);
                showToast("Could not add subject.", "error");
            }
        }

        function editSubject(subjectId, li) {
            document.querySelectorAll('.subject-edit-form').forEach(form => {
                if (!form.classList.contains('hidden')) {
                    form.classList.add('hidden');
                    form.closest('li').querySelector('.subject-name-display').classList.remove('hidden');
                }
            });
            li.querySelector('.subject-name-display').classList.add('hidden');
            li.querySelector('.subject-edit-form').classList.remove('hidden');
        }

        function cancelSubjectEdit(li) {
            li.querySelector('.subject-name-display').classList.remove('hidden');
            li.querySelector('.subject-edit-form').classList.add('hidden');
        }

        async function saveSubjectEdit(subjectId, li) {
            if (!userId) return;
            const subjectsPath = `artifacts/${appId}/users/${userId}/subjects`;
            
            const newName = li.querySelector('input').value.trim();
            if (!newName) {
                showToast("Subject name cannot be empty.", "error");
                return;
            }
            
            const oldSubject = quizData.subjects.find(s => s.id === subjectId);
            if (newName.toLowerCase() !== oldSubject.name.toLowerCase() && quizData.subjects.find(s => s.name.toLowerCase() === newName.toLowerCase())) {
                showToast("Another subject with this name already exists.", "error");
                return;
            }

            try {
                const docRef = doc(db, subjectsPath, subjectId);
                await updateDoc(docRef, { name: newName });
                
                // Update history (this is a "denormalized" update, good practice)
                const batch = writeBatch(db);
                const historyPath = `artifacts/${appId}/users/${userId}/history`;
                const q = query(collection(db, historyPath), where("subjectName", "==", oldSubject.name));
                const historySnapshot = await getDocs(q);
                historySnapshot.docs.forEach(historyDoc => {
                    batch.update(historyDoc.ref, { subjectName: newName });
                });
                await batch.commit();

                showToast(`Subject renamed to '${newName}'.`, "success");
                // UI will update via onSnapshot
            } catch (e) {
                console.error("Error renaming subject: ", e);
                showToast("Could not rename subject.", "error");
            }
        }

        function requestDeleteSubject(subjectId, subjectName) {
            showConfirmationModal(
                `Delete Subject?`,
                `Are you sure you want to delete "<strong>${subjectName}</strong>"? This will delete all its questions.`,
                () => deleteSubject(subjectId),
                "Yes, Delete"
            );
        }

        async function deleteSubject(subjectId) {
            if (!userId) return;
            const subjectsPath = `artifacts/${appId}/users/${userId}/subjects`;
            
            try {
                await deleteDoc(doc(db, subjectsPath, subjectId));
                editQuestionsPanel.classList.add('hidden');
                showToast(`Subject deleted.`, "success");
                // UI will update via onSnapshot
            } catch (e) {
                console.error("Error deleting subject: ", e);
                showToast("Could not delete subject.", "error");
            }
        }

        // --- Admin Panel: Question Functions (Firestore) ---

        function showQuestionsForSubject(subjectId) {
            editQuestionsPanel.classList.remove('hidden');
            questionEditList.innerHTML = '';
            
            const subject = quizData.subjects.find(s => s.id === subjectId);
            if (!subject) {
                editQuestionsPanel.classList.add('hidden');
                return;
            }
            
            editingSubjectId.value = subjectId; // Store for "Add New" button
            editQuestionsTitle.textContent = `Questions for: ${subject.name}`;
            editQuestionsPanel.scrollIntoView({ behavior: 'smooth', block: 'center' });

            if (!subject.questions || subject.questions.length === 0) {
                questionEditList.innerHTML = '<li class="!bg-transparent !border-none text-slate-500 dark:text-slate-400">No questions in this subject yet.</li>';
                return;
            }

            subject.questions.forEach((q, index) => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span class="flex-grow truncate pr-4" title="${q.question}">${q.question}</span>
                    <div class="flex-shrink-0 space-x-2">
                        <button class="edit-q-btn text-sm text-indigo-600 hover:text-indigo-800 dark:text-indigo-400 dark:hover:text-indigo-300 font-medium" data-subject-id="${subject.id}" data-q-index="${index}">[Edit]</button>
                        <button class="delete-q-btn text-sm text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 font-medium" data-subject-id="${subject.id}" data-q-index="${index}">[Delete]</button>
                    </div>
                `;
                questionEditList.appendChild(li);
            });
        }
        
        function openQuestionModal(subjectId, qIndex = -1) {
            clearQuestionForm();
            populateAdminControls(); // Ensure dropdown is up to date
            
            qIndex = parseInt(qIndex);

            if (qIndex > -1) {
                // Editing existing question
                const subject = quizData.subjects.find(s => s.id === subjectId);
                const question = subject.questions[qIndex];
                if (!question) return;

                questionFormTitle.textContent = "Edit Question";
                adminSubjectSelect.value = subject.id;
                adminQuestionText.value = question.question;
                
                const correctAnswer = question.answer;
                const wrongOptions = question.options.filter(opt => opt !== correctAnswer);
                
                adminOption1.value = correctAnswer;
                adminOption2.value = wrongOptions[0] || '';
                adminOption3.value = wrongOptions[1] || '';
                adminOption4.value = wrongOptions[2] || '';

                editingQuestionIndex.value = qIndex;
                editingSubjectId.value = subjectId; // Store original subject ID
                saveQuestionBtn.textContent = "Update Question";
            } else {
                // Adding new question
                questionFormTitle.textContent = "Add New Question";
                if(subjectId) {
                    adminSubjectSelect.value = subjectId;
                }
            }
            
            questionModalOverlay.classList.add('open');
        }
        
        function closeQuestionModal() {
            questionModalOverlay.classList.remove('open');
        }

        async function saveQuestion() {
            if (!userId) return;
            const subjectsPath = `artifacts/${appId}/users/${userId}/subjects`;
            
            const subjectId = adminSubjectSelect.value;
            const questionText = adminQuestionText.value.trim();
            const correctAnswer = adminOption1.value.trim();
            const options = [
                correctAnswer,
                adminOption2.value.trim(),
                adminOption3.value.trim(),
                adminOption4.value.trim()
            ].filter(opt => opt); 
            const qIndex = parseInt(editingQuestionIndex.value);
            const originalSubjectId = editingSubjectId.value;

            if (!subjectId) {
                showToast("Please select a subject.", "error");
                return;
            }
            if (!questionText || options.length < 2) { 
                showToast("Please fill in the question and at least 2 options (including correct answer).", "error");
                return;
            }

            const subject = quizData.subjects.find(s => s.id === subjectId);
            if (!subject) {
                showToast("Selected subject not found.", "error");
                return;
            }
            
            const finalOptions = [
                correctAnswer,
                adminOption2.value.trim() || 'Option A',
                adminOption3.value.trim() || 'Option B',
                adminOption4.value.trim() || 'Option C'
            ];

            const newQuestion = {
                question: questionText,
                options: finalOptions,
                answer: correctAnswer
            };

            try {
                if (qIndex > -1) {
                    // --- Was Editing ---
                    if (originalSubjectId !== subjectId) {
                        // Subject was changed
                        // 1. Remove from old subject
                        const oldSubject = quizData.subjects.find(s => s.id === originalSubjectId);
                        if(oldSubject) {
                            const oldQuestions = [...oldSubject.questions];
                            oldQuestions.splice(qIndex, 1);
                            await updateDoc(doc(db, subjectsPath, originalSubjectId), { questions: oldQuestions });
                        }
                        // 2. Add to new subject
                        const newQuestions = [...subject.questions, newQuestion];
                        await updateDoc(doc(db, subjectsPath, subjectId), { questions: newQuestions });
                        
                        showToast(`Question moved to '${subject.name}'.`, "success");
                    } else {
                        // Subject is the same, just update
                        const updatedQuestions = [...subject.questions];
                        updatedQuestions[qIndex] = newQuestion;
                        await updateDoc(doc(db, subjectsPath, subjectId), { questions: updatedQuestions });
                        showToast(`Question updated in '${subject.name}'.`, "success");
                    }
                } else {
                    // --- Was Adding New ---
                    const updatedQuestions = [...subject.questions, newQuestion];
                    await updateDoc(doc(db, subjectsPath, subjectId), { questions: updatedQuestions });
                    showToast(`Question added to '${subject.name}'.`, "success");
                }
                
                // UI will update via onSnapshot
                closeQuestionModal();
                
            } catch (e) {
                console.error("Error saving question: ", e);
                showToast("Could not save question.", "error");
            }
        }

        function clearQuestionForm() {
            questionFormTitle.textContent = "Add New Question";
            adminQuestionText.value = '';
            adminOption1.value = '';
            adminOption2.value = '';
            adminOption3.value = '';
            adminOption4.value = '';
            editingQuestionIndex.value = -1;
            editingSubjectId.value = '';
            saveQuestionBtn.textContent = "Save Question";
        }

        function requestDeleteQuestion(subjectId, qIndex) {
            const subject = quizData.subjects.find(s => s.id === subjectId);
            const question = subject.questions[qIndex];
            showConfirmationModal(
                "Delete Question?",
                `Are you sure you want to delete: "<strong>${question.question.substring(0, 40)}...</strong>"?`,
                () => deleteQuestion(subjectId, qIndex),
                "Yes, Delete"
            );
        }

        async function deleteQuestion(subjectId, qIndex) {
            if (!userId) return;
            const subjectsPath = `artifacts/${appId}/users/${userId}/subjects`;
            
            const subject = quizData.subjects.find(s => s.id === subjectId);
            if (subject) {
                try {
                    const updatedQuestions = [...subject.questions];
                    updatedQuestions.splice(qIndex, 1);
                    await updateDoc(doc(db, subjectsPath, subjectId), { questions: updatedQuestions });
                    showToast(`Question deleted.`, "success");
                    // UI will update via onSnapshot
                } catch (e) {
                    console.error("Error deleting question: ", e);
                    showToast("Could not delete question.", "error");
                }
            }
        }

        // --- Data Screen: Import/Export Functions (Firestore) ---
        
        function openExportModal() {
            exportSubjectList.innerHTML = ''; // Clear old list
            if (quizData.subjects.length === 0) {
                exportSubjectList.innerHTML = '<p class="text-slate-500">You have no subjects to export.</p>';
                exportModalConfirmBtn.disabled = true;
            } else {
                quizData.subjects.forEach(subject => {
                    const li = document.createElement('li');
                    li.className = "flex items-center p-2 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700";
                    li.innerHTML = `
                        <input id="export-check-${subject.id}" type="checkbox" data-id="${subject.id}" class="h-4 w-4 text-indigo-600 border-slate-300 dark:border-slate-600 rounded focus:ring-indigo-500 mr-3">
                        <label for="export-check-${subject.id}" class="flex-grow cursor-pointer">${subject.name} <span class="text-sm text-slate-500">(${subject.questions.length}Q)</span></label>
                    `;
                    exportSubjectList.appendChild(li);
                });
                exportModalConfirmBtn.disabled = false;
            }
            exportModalOverlay.classList.add('open');
        }

        function closeExportModal() {
            exportModalOverlay.classList.remove('open');
        }

        function handleExportSelected() {
            const selectedSubjects = [];
            const checkboxes = exportSubjectList.querySelectorAll('input[type="checkbox"]:checked');
            
            checkboxes.forEach(check => {
                const subjectId = check.dataset.id;
                const subject = quizData.subjects.find(s => s.id === subjectId);
                if (subject) {
                    // Omit the 'id' field from the export
                    const { id, ...subjectData } = subject; 
                    selectedSubjects.push(subjectData);
                }
            });

            if (selectedSubjects.length === 0) {
                showToast("No subjects selected to export.", "warning");
                return;
            }
            
            const exportData = {
                "subjects": selectedSubjects
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            downloadJSON(dataStr, `study_helper_subjects_export.json`);
            showToast(`Exported ${selectedSubjects.length} subject(s).`, "success");
            closeExportModal();
        }

        function populateExportSubjectButton() {
            exportSubjectBtn.disabled = !quizData.subjects || quizData.subjects.length === 0;
            exportSubjectBtn.textContent = (quizData.subjects && quizData.subjects.length > 0) ? "Export Subjects..." : "No Subjects to Export";
        }
        
        function importSubjectFile(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            subjectsToImport = [];
            let filesRead = 0;

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        let subjects = [];
                        if (data.subjects && Array.isArray(data.subjects)) {
                            subjects = data.subjects;
                        } else if (data.name && Array.isArray(data.questions)) {
                            subjects = [data];
                        }
                        
                        subjects.forEach(s => {
                            if(s.name && Array.isArray(s.questions)) {
                                subjectsToImport.push(s);
                            }
                        });

                    } catch (error) {
                        showToast(`Could not read file ${file.name}.`, "error");
                    }
                    
                    filesRead++;
                    if (filesRead === files.length) {
                        // All files processed
                        if (subjectsToImport.length === 0) {
                            showToast("No valid subjects found in file(s).", "error");
                            return;
                        }
                        
                        const conflicts = subjectsToImport
                            .filter(s_new => quizData.subjects.find(s_db => s_db.name === s_new.name))
                            .map(s => s.name);
                        
                        if (conflicts.length > 0) {
                            showConfirmationModal(
                                "Overwrite Subjects?",
                                `These subjects already exist: <strong>${conflicts.join(', ')}</strong>. Do you want to overwrite them?`,
                                () => confirmImportSubjects(true),
                                "Yes, Overwrite"
                            );
                        } else {
                            confirmImportSubjects(false); // No conflict, add directly
                        }
                    }
                };
                reader.readAsText(file);
            });
            event.target.value = null; // Clear input
        }

        async function confirmImportSubjects(overwrite) {
            if (!subjectsToImport || subjectsToImport.length === 0 || !userId) return;
            
            const subjectsPath = `artifacts/${appId}/users/${userId}/subjects`;
            const batch = writeBatch(db);
            let importedCount = 0;
            let overwrittenCount = 0;
            
            subjectsToImport.forEach(subject => {
                const existing = quizData.subjects.find(s => s.name === subject.name);
                if (existing) {
                    // Conflict
                    if (overwrite) {
                        const docRef = doc(db, subjectsPath, existing.id);
                        batch.set(docRef, subject); // Overwrite
                        overwrittenCount++;
                    }
                } else {
                    // No conflict
                    const docRef = doc(collection(db, subjectsPath));
                    batch.set(docRef, subject); // Add new
                    importedCount++;
                }
            });
            
            try {
                await batch.commit();
                showToast(`Import complete: ${importedCount} added, ${overwrittenCount} overwritten.`, "success");
            } catch (e) {
                console.error("Error importing subjects: ", e);
                showToast("Import failed.", "error");
            }
            
            subjectsToImport = []; // Clear temp
        }

        async function exportBackupFile() {
            if (!userId) return;
            
            try {
                // 1. Get Subjects
                const subjectsPath = `artifacts/${appId}/users/${userId}/subjects`;
                const subjectsSnapshot = await getDocs(query(collection(db, subjectsPath)));
                const subjects = subjectsSnapshot.docs.map(subjectDoc => subjectDoc.data());
                
                // 2. Get History
                const historyPath = `artifacts/${appId}/users/${userId}/history`;
                const historySnapshot = await getDocs(query(collection(db, historyPath)));
                const history = historySnapshot.docs.map(historyDoc => historyDoc.data());

                // 3. Get Settings (local cache is fine)
                const backupData = {
                    quizData: { subjects: subjects },
                    history: history,
                    settings: quizSettings
                };
                
                const dataStr = JSON.stringify(backupData, null, 2);
                downloadJSON(dataStr, `study_helper_backup_${new Date().toISOString().split('T')[0]}.json`);
                showToast("Full app backup exported.", "success");
                
            } catch (e) {
                console.error("Error exporting backup: ", e);
                showToast("Export failed.", "error");
            }
        }
        
        let backupToImport = null;
        function importBackupFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!data.quizData || !data.history || !data.settings) {
                        throw new Error("Invalid backup file format.");
                    }
                    backupToImport = data; // Store temp
                    
                    showConfirmationModal(
                        "Restore Backup?",
                        "<strong>This will overwrite ALL current subjects, history, and settings for this user.</strong> Are you sure?",
                        () => confirmImportBackup(true),
                        "Yes, Overwrite All"
                    );
                    
                } catch (error) {
                    showToast(`Import failed: ${error.message}`, "error");
                }
            };
            reader.readAsText(file);
            event.target.value = null; // Clear input
        }

        async function confirmImportBackup(confirmed) {
            if (!confirmed || !backupToImport || !userId) {
                backupToImport = null;
                return;
            }
            
            setAuthLoading(true);
            showToast("Restoring backup... This may take a moment.", "warning");
            
            try {
                // 1. Wipe existing data
                await resetAllData(false); // false = don't show toast

                const batch = writeBatch(db);

                // 2. Import Settings
                const settingsPath = `artifacts/${appId}/users/${userId}/settings/main`;
                batch.set(doc(db, settingsPath), backupToImport.settings);
                
                // 3. Import Subjects
                const subjectsPath = `artifacts/${appId}/users/${userId}/subjects`;
                backupToImport.quizData.subjects.forEach(subject => {
                    batch.set(doc(collection(db, subjectsPath)), subject);
                });
                
                // 4. Import History
                const historyPath = `artifacts/${appId}/users/${userId}/history`;
                backupToImport.history.forEach(entry => {
                    // Convert JS dates back to Timestamps if necessary
                    entry.date = new Date(entry.date); // Ensure it's a Date object
                    batch.set(doc(collection(db, historyPath)), entry);
                });

                await batch.commit();
                showToast("Backup restored successfully!", "success");
                // Data will reload via onSnapshot listeners
                
            } catch (e) {
                console.error("Error restoring backup: ", e);
                showToast("Restore failed.", "error");
            }
            
            backupToImport = null;
            setAuthLoading(false);
        }

        function requestResetAllData() {
            showConfirmationModal(
                "Reset All Data?",
                "<strong>DANGER:</strong> This will delete ALL subjects, questions, history, and settings for your account.",
                () => resetAllData(true),
                "Yes, Delete Everything"
            );
        }

        async function resetAllData(showSuccessToast = true) {
            if (!userId) return;
            
            // Unsubscribe to prevent UI flicker
            unloadAllFirestoreData();
            
            try {
                const batch = writeBatch(db);

                // 1. Delete Subjects
                const subjectsPath = `artifacts/${appId}/users/${userId}/subjects`;
                const subjectsSnapshot = await getDocs(query(collection(db, subjectsPath)));
                subjectsSnapshot.docs.forEach(d => batch.delete(d.ref));
                
                // 2. Delete History
                const historyPath = `artifacts/${appId}/users/${userId}/history`;
                const historySnapshot = await getDocs(query(collection(db, historyPath)));
                historySnapshot.docs.forEach(d => batch.delete(d.ref));
                
                // 3. Delete Settings
                const settingsPath = `artifacts/${appId}/users/${userId}/settings/main`;
                batch.delete(doc(db, settingsPath));
                
                await batch.commit();
                
                if(showSuccessToast) showToast("All account data has been reset.", "success");
                
            } catch (e) {
                console.error("Error resetting data: ", e);
                if(showSuccessToast) showToast("Could not reset data.", "error");
            }
            
            // Re-attach listeners
            loadAllFirestoreData();
        }

        /**
         * Helper function to trigger JSON file download
         */
        function downloadJSON(jsonString, fileName) {
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // --- Feedback Functions (Toast & Modal) ---
        
        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            let icon = '';
            if (type === 'success') {
                toast.classList.add('success');
                icon = '<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>';
            } else if (type === 'error') {
                toast.classList.add('error');
                icon = '<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>';
            } else if (type === 'warning') {
                toast.classList.add('warning');
                icon = '<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 3.001-1.742 3.001H4.42c-1.53 0-2.493-1.667-1.743-3.001l5.58-9.92zM10 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>';
            }
            
            toast.classList.add('toast');
            toast.innerHTML = `${icon}<span>${message}</span>`;
            
            toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('fade-out');
                toast.addEventListener('transitionend', () => {
                    toast.remove();
                });
            }, 3000);
        }

        function showConfirmationModal(title, message, callback, confirmText = "Confirm", isDanger = true) {
            confirmModalTitle.textContent = title;
            confirmModalMessage.innerHTML = message;
            onConfirmCallback = callback;
            confirmModalConfirmBtn.textContent = confirmText;
            
            confirmModalConfirmBtn.classList.toggle('btn-danger', isDanger);
            confirmModalConfirmBtn.classList.toggle('btn-primary', !isDanger);
            
            confirmModalOverlay.classList.add('open');
        }
        
        function closeConfirmationModal() {
            confirmModalOverlay.classList.remove('open');
            onConfirmCallback = null;
        }

        // --- Quiz Logic (Unchanged, but uses Firestore-loaded data) ---
        
        function startQuiz(subjectId) {
            const subject = quizData.subjects.find(s => s.id === subjectId);
            if (!subject || subject.questions.length === 0) {
                showToast("This subject has no questions.", "error");
                return;
            }

            const { count, timeLimit, showTimer } = getQuizSettings();
            
            if (count !== 'all' && subject.questions.length < count) {
                showToast(`This subject only has ${subject.questions.length} questions. You need at least ${count}.`, "warning");
                return;
            }

            isTimerVisible = showTimer;
            timePerQuestion = timeLimit;
            currentSubjectName = subject.name; // Use name for history
            
            let allSubjectQuestions = [...subject.questions];
            shuffleArray(allSubjectQuestions);
            
            if (count === 'all') {
                currentQuestions = allSubjectQuestions;
            } else {
                currentQuestions = allSubjectQuestions.slice(0, count);
            }
            
            if (currentQuestions.length === 0) {
                showToast("This subject has no questions yet.", "error");
                return;
            }

            // Reset state
            currentQuestionIndex = 0;
            score = 0;
            userAnswers = [];
            answerTimes = [];
            scoreDisplay.textContent = `Score: 0`;
            feedbackMessage.textContent = '';
            
            startTimer();
            timerDisplay.classList.toggle('hidden', !isTimerVisible);

            showScreen('quiz-screen');
            showQuestion();
            updateProgressBar();
        }

        function checkRandomQuizButton() {
            const allQuestions = (quizData.subjects || []).flatMap(s => s.questions);
            randomQuizBtn.disabled = allQuestions.length === 0;
            randomQuizBtn.title = allQuestions.length === 0 ? "Add some questions to any subject to enable Random Quiz" : "";
        }
        
        function startRandomQuiz() {
            const { count, timeLimit, showTimer } = getQuizSettings();
            const allQuestions = (quizData.subjects || []).flatMap(s => s.questions);

            if (allQuestions.length === 0) {
                showToast("You don't have any questions in your bank! Add some first.", "error");
                return;
            }
            if (count !== 'all' && allQuestions.length < count) {
                showToast(`You only have ${allQuestions.length} questions in total. Starting with ${allQuestions.length}.`, "warning");
                currentQuestions = allQuestions;
            } else if (count === 'all') {
                currentQuestions = allQuestions;
            } else {
                currentQuestions = allQuestions.slice(0, count);
            }
            
            isTimerVisible = showTimer;
            timePerQuestion = timeLimit;
            currentSubjectName = "Random Quiz";

            shuffleArray(currentQuestions);

            // Reset state
            currentQuestionIndex = 0;
            score = 0;
            userAnswers = [];
            answerTimes = [];
            scoreDisplay.textContent = `Score: 0`;
            feedbackMessage.textContent = '';
            
            startTimer();
            timerDisplay.classList.toggle('hidden', !isTimerVisible);

            showScreen('quiz-screen');
            showQuestion();
            updateProgressBar();
        }

        function showQuestion() {
            optionsContainer.innerHTML = '';
            feedbackMessage.textContent = '';
            nextBtn.classList.add('hidden');

            const question = currentQuestions[currentQuestionIndex];
            questionText.textContent = question.question;

            const validOptions = question.options.filter(opt => opt && opt.trim() !== '');
            const shuffledOptions = [...validOptions];
            shuffleArray(shuffledOptions);
            
            shuffledOptions.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.classList.add('option-btn', 'w-full', 'text-left', 'p-4', 'rounded-lg', 'bg-slate-100', 'dark:bg-slate-700', 'hover:bg-slate-200', 'dark:hover:bg-slate-600', 'border', 'border-slate-200', 'dark:border-slate-600', 'transition-all', 'duration-200', 'fade-in');
                button.dataset.answer = option;
                button.addEventListener('click', handleOptionClick);
                optionsContainer.appendChild(button);
            });
            
            questionStartTime = Date.now();
        }

        function handleOptionClick(event) {
            clearInterval(timerInterval);
            
            const timeTaken = (Date.now() - questionStartTime) / 1000; 
            answerTimes.push(timeTaken);
            
            const selectedButton = event.target;
            const selectedAnswer = selectedButton.dataset.answer;
            const correctAnswer = currentQuestions[currentQuestionIndex].answer;

            Array.from(optionsContainer.children).forEach(btn => {
                btn.disabled = true;
                if (btn.dataset.answer === correctAnswer) {
                    btn.classList.add('correct');
                }
            });

            if (selectedAnswer === correctAnswer) {
                score++;
                feedbackMessage.textContent = "Correct! Well done.";
                feedbackMessage.classList.add('text-green-600', 'dark:text-green-400');
                feedbackMessage.classList.remove('text-red-600', 'dark:text-red-400');
            } else {
                selectedButton.classList.add('incorrect');
                feedbackMessage.textContent = `Sorry, the correct answer was: ${correctAnswer}`;
                feedbackMessage.classList.add('text-red-600', 'dark:text-red-400');
                feedbackMessage.classList.remove('text-green-600', 'dark:text-green-400');
            }

            userAnswers.push({
                question: currentQuestions[currentQuestionIndex].question,
                chosen: selectedAnswer,
                correct: correctAnswer
            });

            scoreDisplay.textContent = `Score: ${score}`;
            nextBtn.classList.remove('hidden');
        }

        function nextQuestion() {
            if (timePerQuestion !== 'unlimited') {
                startTimer();
            }
            
            currentQuestionIndex++;
            if (currentQuestionIndex < currentQuestions.length) {
                showQuestion();
                updateProgressBar();
            } else {
                endQuiz();
            }
        }

        async function endQuiz(wasQuit = false) {
            clearInterval(timerInterval);
            
            if (wasQuit && userAnswers.length === 0) {
                showScreen('home-screen');
                return;
            }

            finalScore.textContent = `${score} / ${userAnswers.length}`; 
            percentageDisplay.textContent = `${userAnswers.length > 0 ? (score / userAnswers.length * 100).toFixed(1) : 0}%`;

            if (wasQuit) {
                document.getElementById('results-summary-container').querySelector('h3').textContent = `Review (Quiz Incomplete):`;
            } else {
                document.getElementById('results-summary-container').querySelector('h3').textContent = `Review Your Answers:`;
            }
            
            // Save to history (Firestore)
            const historyEntry = {
                subjectName: currentSubjectName,
                score: score,
                totalQuestions: userAnswers.length,
                date: Timestamp.now() // Use Firestore Timestamp
            };
            
            if (userAnswers.length > 0 && userId) {
                try {
                    const historyPath = `artifacts/${appId}/users/${userId}/history`;
                    await addDoc(collection(db, historyPath), historyEntry);
                    // UI will update via onSnapshot
                } catch (e) {
                    console.error("Error saving history: ", e);
                    showToast("Could not save quiz history.", "error");
                }
            }

            showPerformanceStats();
            showResultsSummary();
            showScreen('results-screen');
        }

        function showPerformanceStats() {
            if (answerTimes.length > 0) {
                const minTime = Math.min(...answerTimes);
                fastestAnswer.textContent = `${minTime.toFixed(1)}s`;
            } else {
                fastestAnswer.textContent = 'N/A';
            }
            
            const oneWeekAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;
            const weeklyHistory = quizHistory.filter(entry => new Date(entry.date).getTime() >= oneWeekAgo);
            
            if (weeklyHistory.length > 0) {
                let totalScore = 0;
                let totalQs = 0;
                weeklyHistory.forEach(entry => {
                    totalScore += entry.score;
                    totalQs += entry.totalQuestions;
                });
                const weeklyAcc = totalQs > 0 ? (totalScore / totalQs * 100) : 0;
                weeklyAccuracy.textContent = `${weeklyAcc.toFixed(1)}%`;
            } else {
                weeklyAccuracy.textContent = 'N/A';
            }
            
            if (quizHistory.length > 0) {
                const subjectStats = {};
                quizHistory.forEach(entry => {
                    if (entry.subjectName === 'Random Quiz') return;
                    if (!subjectStats[entry.subjectName]) {
                        subjectStats[entry.subjectName] = { score: 0, total: 0 };
                    }
                    subjectStats[entry.subjectName].score += entry.score;
                    subjectStats[entry.subjectName].total += entry.totalQuestions;
                });
                
                let bestSubject = 'N/A';
                let bestAvg = -1;
                
                Object.keys(subjectStats).forEach(subjectName => {
                    const stats = subjectStats[subjectName];
                    if (stats.total >= 5) {
                        const avg = stats.total > 0 ? (stats.score / stats.total) : 0;
                        if (avg > bestAvg) {
                            bestAvg = avg;
                            bestSubject = subjectName;
                        }
                    }
                });
                strongestSubject.textContent = bestSubject;
            } else {
                strongestSubject.textContent = 'N/A';
            }
        }

        function showResultsSummary() {
            resultsSummary.innerHTML = '';
            userAnswers.forEach((answer, index) => {
                const resultDiv = document.createElement('div');
                resultDiv.classList.add('p-3', 'bg-slate-50', 'dark:bg-slate-700', 'rounded-lg', 'border', 'border-slate-200', 'dark:border-slate-600');
                
                const isCorrect = answer.chosen === answer.correct;
                
                resultDiv.innerHTML = `
                    <p class="font-semibold text-slate-700 dark:text-slate-300 mb-1">Q${index + 1}: ${answer.question}</p>
                    <p class="text-sm ${isCorrect ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}">
                        Your answer: ${answer.chosen}
                    </p>
                    ${!isCorrect ? `<p class="text-sm text-green-600 dark:text-green-400">Correct answer: ${answer.correct}</p>` : ''}
                `;
                resultsSummary.appendChild(resultDiv);
            });
        }

        function restartQuiz() {
            progressBarInner.style.width = '0%';
            showScreen('home-screen');
        }

        function startTimer() {
            clearInterval(timerInterval);
            
            if (timePerQuestion === 'unlimited') {
                timeElapsed = 0;
                timerDisplay.textContent = `Time: ${formatTime(timeElapsed)}`;
                timerInterval = setInterval(() => {
                    timeElapsed++;
                    timerDisplay.textContent = `Time: ${formatTime(timeElapsed)}`;
                }, 1000);
            } else {
                timeRemaining = timePerQuestion; 
                timerDisplay.textContent = `Time: ${formatTime(timeRemaining)}`;
                timerInterval = setInterval(() => {
                    timeRemaining--;
                    timerDisplay.textContent = `Time: ${formatTime(timeRemaining)}`;
                    if (timeRemaining <= 0) {
                        handleTimeUp();
                    }
                }, 1000);
            }
        }
        
        function handleTimeUp() {
            clearInterval(timerInterval); 
            
            answerTimes.push(timePerQuestion);
            const correctAnswer = currentQuestions[currentQuestionIndex].answer;

            Array.from(optionsContainer.children).forEach(btn => {
                btn.disabled = true;
                if (btn.dataset.answer === correctAnswer) {
                    btn.classList.add('correct');
                }
            });

            feedbackMessage.textContent = `Time's up! The correct answer was: ${correctAnswer}`;
            feedbackMessage.classList.add('text-red-600', 'dark:text-red-400');
            feedbackMessage.classList.remove('text-green-600', 'dark:text-green-400');
            
            userAnswers.push({
                question: currentQuestions[currentQuestionIndex].question,
                chosen: "Time's up",
                correct: correctAnswer
            });

            scoreDisplay.textContent = `Score: ${score}`;
            nextBtn.classList.remove('hidden');
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function updateProgressBar() {
            const progress = ((currentQuestionIndex + 1) / currentQuestions.length) * 100;
            progressBarInner.style.width = `${progress}%`;
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // --- 5. Initial Run ---
        // Must be called after all functions are defined
        if (db && auth) {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            document.addEventListener('DOMContentLoaded', () => {
                document.body.innerHTML = `<div class="p-8 text-center text-red-500">
                    <h1 class="text-2xl font-bold">Firebase Configuration Error</h1>
                    <p>Could not initialize Firebase. Please ensure the \`__firebase_config\` variable is set correctly.</p>
                </div>`;
            });
        }

    </script>
</body>
</html>

