<!DOCTYPE html>
<html lang="en" class=""> <!-- 'dark' class will be toggled here -->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyHelper Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide.min.js"></script>
    <script>
        // Set up Tailwind CSS
        tailwind.config = {
            darkMode: 'class', // Enable dark mode using a class
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <style>
        /* Custom scrollbar for webkit browsers */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            /* cool-gray-300 */
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
            /* cool-gray-400 */
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #475569;
            /* slate-600 */
        }

        .dark ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
            /* slate-500 */
        }

        /* Basic transition for dark mode */
        body,
        .app-shell {
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Hide number input spinners */
        input[type='number']::-webkit-outer-spin-button,
        input[type='number']::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type='number'] {
            -moz-appearance: textfield;
        }

        /* Sidebar active state */
        .sidebar-link[data-active="true"] {
            background-color: #e0f2fe;
            /* light blue */
            color: #0284c7;
            /* sky-700 */
            font-weight: 600;
        }

        .dark .sidebar-link[data-active="true"] {
            background-color: #0c4a6e;
            /* sky-900 */
            color: #e0f2fe;
            /* sky-100 */
        }
    </style>
</head>

<body class="bg-slate-50 dark:bg-slate-900 font-sans text-slate-900 dark:text-slate-100 antialiased">

    <!-- 
      ================================================================
      APP LOADER
      Initially visible, hidden by JS when Firebase auth is ready.
      ================================================================
    -->
    <div id="app-loader"
        class="fixed inset-0 flex flex-col items-center justify-center bg-slate-50 dark:bg-slate-900 z-[100]">
        <svg class="animate-spin h-12 w-12 text-sky-600" xmlns="http://www.w3.org/2000/svg" fill="none"
            viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
            </path>
        </svg>
        <p class="mt-4 text-lg font-medium text-slate-700 dark:text-slate-300">Loading StudyHelper...</p>
        <p class="text-sm text-slate-500 dark:text-slate-400">Initializing secure session...</p>
    </div>

    <!-- 
      ================================================================
      LOGIN / SIGNUP PAGE
      Hidden when the user is logged in.
      ================================================================
    -->
    <div id="login-page"
        class="min-h-screen flex items-center justify-center bg-slate-100 dark:bg-slate-900 p-4 hidden">
        <div class="w-full max-w-md bg-white dark:bg-slate-800 rounded-2xl shadow-xl p-8">

            <!-- Logo and Title -->
            <div class="flex flex-col items-center mb-6">
                <div class="bg-sky-600 p-3 rounded-full">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 6.253v13.m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.747 0-3.332.477-4.5 1.253">
                        </path>
                    </svg>
                </div>
                <h1 class="text-3xl font-bold text-slate-900 dark:text-white mt-4">StudyHelper</h1>
                <p id="auth-form-title" class="text-slate-500 dark:text-slate-400 mt-1">Sign in to your account</p>
            </div>

            <!-- Auth Error Message -->
            <div id="auth-error"
                class="hidden bg-red-100 dark:bg-red-900 border border-red-300 dark:border-red-700 text-red-700 dark:text-red-200 px-4 py-3 rounded-lg relative mb-4 text-sm"
                role="alert">
                <span class="block sm:inline"></span>
            </div>

            <!-- Email/Password Form -->
            <form id="auth-form" class="space-y-4">
                <div class="space-y-2">
                    <label for="email" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Email
                        address</label>
                    <input type="email" id="email" name="email" required autocomplete="email"
                        class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-transparent">
                </div>
                <div class="space-y-2">
                    <label for="password"
                        class="block text-sm font-medium text-slate-700 dark:text-slate-300">Password</label>
                    <input type="password" id="password" name="password" required autocomplete="current-password"
                        class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-transparent">
                </div>

                <!-- Auth Buttons -->
                <div id="login-buttons" class="pt-2 space-y-3">
                    <button type="submit" id="login-button"
                        class="w-full bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2.5 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2 dark:focus:ring-offset-slate-800 transition duration-150 ease-in-out">
                        Sign In
                    </button>
                    <button type="button" id="toggle-to-signup"
                        class="w-full bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 font-semibold py-2.5 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2 dark:focus:ring-offset-slate-800 transition duration-150 ease-in-out">
                        Don't have an account? Sign Up
                    </button>
                </div>

                <div id="signup-buttons" class="pt-2 space-y-3 hidden">
                    <button type="submit" id="signup-button"
                        class="w-full bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2.5 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2 dark:focus:ring-offset-slate-800 transition duration-150 ease-in-out">
                        Create Account
                    </button>
                    <button type="button" id="toggle-to-login"
                        class="w-full bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 font-semibold py-2.5 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2 dark:focus:ring-offset-slate-800 transition duration-150 ease-in-out">
                        Already have an account? Sign In
                    </button>
                </div>
            </form>

            <!-- OR Separator -->
            <div class="flex items-center justify-center my-6">
                <div class="flex-grow border-t border-slate-300 dark:border-slate-600"></div>
                <span class="mx-4 text-sm font-medium text-slate-500 dark:text-slate-400">OR</span>
                <div class="flex-grow border-t border-slate-300 dark:border-slate-600"></div>
            </div>

            <!-- Google Sign-In Button -->
            <button id="google-signin-button"
                class="w-full bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 hover:bg-slate-50 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 font-semibold py-2.5 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2 dark:focus:ring-offset-slate-800 transition duration-150 ease-in-out flex items-center justify-center space-x-2">
                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
                    <path fill="#FFC107"
                        d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z" />
                    <path fill="#FF3D00"
                        d="m6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z" />
                    <path fill="#4CAF50"
                        d="m24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.202 0-9.619-3.317-11.283-7.946l-6.522 5.025C9.505 39.556 16.227 44 24 44z" />
                    <path fill="#1976D2"
                        d="M43.611 20.083H42V20H24v8h11.303c-0.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C42.012 34.569 44 29.865 44 24c0-1.341-.138-2.65-.389-3.917z" />
                </svg>
                <span>Sign in with Google</span>
            </button>
        </div>
    </div>

    <!-- 
      ================================================================
      MAIN APPLICATION SHELL
      Visible when the user is logged in.
      ================================================================
    -->
    <div id="app-shell" class="app-shell flex h-screen bg-slate-50 dark:bg-slate-900 hidden">

        <!-- 
          --------------------------------------
          SIDEBAR
          --------------------------------------
        -->
        <nav
            class="w-64 bg-white dark:bg-slate-800 border-r border-slate-200 dark:border-slate-700 flex flex-col shrink-0">
            <!-- Sidebar Header -->
            <div class="h-16 flex items-center px-6 border-b border-slate-200 dark:border-slate-700">
                <div class="bg-sky-600 p-2.5 rounded-lg">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 6.253v13.m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.747 0-3.332.477-4.5 1.253">
                        </path>
                    </svg>
                </div>
                <span class="text-xl font-bold ml-3 text-slate-900 dark:text-white">StudyHelper</span>
            </div>

            <!-- Navigation Links -->
            <div class="flex-grow overflow-y-auto py-6 px-4 space-y-2">
                <a href="#"
                    class="sidebar-link flex items-center space-x-3 px-3 py-2.5 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700"
                    data-page="page-home">
                    <i data-lucide="home" class="w-5 h-5"></i>
                    <span class="font-medium">Home</span>
                </a>
                <a href="#"
                    class="sidebar-link flex items-center space-x-3 px-3 py-2.5 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700"
                    data-page="page-manage-bank">
                    <i data-lucide="database" class="w-5 h-5"></i>
                    <span class="font-medium">Manage Bank</span>
                </a>
                <a href="#"
                    class="sidebar-link flex items-center space-x-3 px-3 py-2.5 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700"
                    data-page="page-take-quiz">
                    <i data-lucide="edit-3" class="w-5 h-5"></i>
                    <span class="font-medium">Take Quiz</span>
                </a>
                <a href="#"
                    class="sidebar-link flex items-center space-x-3 px-3 py-2.5 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700"
                    data-page="page-quiz-history">
                    <i data-lucide="history" class="w-5 h-5"></i>
                    <span class="font-medium">Quiz History</span>
                </a>
                <a href="#"
                    class="sidebar-link flex items-center space-x-3 px-3 py-2.5 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700"
                    data-page="page-settings">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                    <span class="font-medium">Settings & Data</span>
                </a>
            </div>

            <!-- Sidebar Footer -->
            <div class="p-4 border-t border-slate-200 dark:border-slate-700">
                <!-- Dark Mode Toggle -->
                <button id="dark-mode-toggle"
                    class="w-full flex items-center justify-between px-3 py-2.5 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700">
                    <span class="font-medium flex items-center space-x-3">
                        <i data-lucide="moon" class="w-5 h-5 hidden dark:inline"></i>
                        <i data-lucide="sun" class="w-5 h-5 inline dark:hidden"></i>
                        <span>Toggle Theme</span>
                    </span>
                    <!-- Toggle Switch -->
                    <div class="relative inline-flex items-center cursor-pointer">
                        <span class="w-11 h-6 bg-slate-200 dark:bg-slate-600 rounded-full"></span>
                        <span
                            class="absolute left-1 top-1 w-4 h-4 bg-white dark:bg-slate-300 rounded-full transition-transform dark:translate-x-5"></span>
                    </div>
                </button>
                <!-- User Info -->
                <div class="mt-4 flex items-center space-x-3">
                    <img id="user-avatar" class="w-10 h-10 rounded-full bg-slate-200 dark:bg-slate-600 object-cover"
                        src="https://placehold.co/40x40/e2e8f0/64748b?text=U" alt="User Avatar">
                    <div class="flex-grow min-w-0">
                        <p id="user-display-name" class="text-sm font-semibold text-slate-900 dark:text-white truncate">
                            Loading...</p>
                        <p id="user-email" class="text-xs text-slate-500 dark:text-slate-400 truncate">...</p>
                    </div>
                    <button id="logout-button" title="Sign Out"
                        class="shrink-0 text-slate-500 dark:text-slate-400 hover:text-red-500 dark:hover:text-red-400">
                        <i data-lucide="log-out" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </nav>

        <!-- 
          --------------------------------------
          MAIN CONTENT AREA
          --------------------------------------
        -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <!-- Main Content Header -->
            <header
                class="h-16 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between px-6 shrink-0">
                <h1 id="page-title" class="text-2xl font-bold text-slate-900 dark:text-white">Home</h1>
                <button id="quick-start-button"
                    class="bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center space-x-2 transition duration-150 ease-in-out">
                    <i data-lucide="play" class="w-5 h-5"></i>
                    <span>Quick Start</span>
                </button>
            </header>

            <!-- 
              --------------------------------------
              CONTENT PAGES WRAPPER
              (Scrollable)
              --------------------------------------
            -->
            <div class="flex-1 overflow-y-auto p-6 md:p-8 space-y-6">

                <!-- 
                  ================ PAGE: HOME (DASHBOARD) ================
                -->
                <div id="page-home" class="page-content space-y-6">
                    <!-- Welcome Message -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow">
                        <h2 class="text-2xl font-bold">Welcome back, <span id="welcome-user-name">User</span>!</h2>
                        <p class="text-slate-500 dark:text-slate-400 mt-1">You're doing great! Keep up the momentum.</p>
                    </div>

                    <!-- Main Dashboard Cards -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                        <!-- Card: Quick Start -->
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow flex flex-col">
                            <div class="flex items-center space-x-3">
                                <div class="p-3 rounded-lg bg-sky-100 dark:bg-sky-900">
                                    <i data-lucide="play-circle" class="w-6 h-6 text-sky-600 dark:text-sky-300"></i>
                                </div>
                                <h3 class="text-xl font-semibold">Quick Start</h3>
                            </div>
                            <p class="text-slate-500 dark:text-slate-400 mt-4 mb-5 flex-grow">Jump right into your next
                                quiz. Pick a subject and get started.</p>
                            <button data-page="page-take-quiz"
                                class="nav-button w-full bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2.5 px-4 rounded-lg">
                                Take a Quiz
                            </button>
                        </div>

                        <!-- Card: Question Bank -->
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow flex flex-col">
                            <div class="flex items-center space-x-3">
                                <div class="p-3 rounded-lg bg-emerald-100 dark:bg-emerald-900">
                                    <i data-lucide="database"
                                        class="w-6 h-6 text-emerald-600 dark:text-emerald-300"></i>
                                </div>
                                <h3 class="text-xl font-semibold">Question Bank</h3>
                            </div>
                            <p class="text-slate-500 dark:text-slate-400 mt-4 mb-5 flex-grow">Manage your subjects and
                                questions. Add new topics or edit existing ones.</p>
                            <div class="flex items-baseline space-x-2">
                                <span id="db-question-count" class="text-4xl font-bold">0</span>
                                <span class="text-slate-500 dark:text-slate-400">Questions</span>
                            </div>
                            <div class="flex items-baseline space-x-2 mt-1">
                                <span id="db-subject-count" class="text-4xl font-bold">0</span>
                                <span class="text-slate-500 dark:text-slate-400">Subjects</span>
                            </div>
                            <button data-page="page-manage-bank"
                                class="nav-button w-full mt-5 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2.5 px-4 rounded-lg">
                                Manage Bank
                            </button>
                        </div>

                        <!-- Card: Your Progress -->
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow flex flex-col">
                            <div class="flex items-center space-x-3">
                                <div class="p-3 rounded-lg bg-indigo-100 dark:bg-indigo-900">
                                    <i data-lucide="trending-up"
                                        class="w-6 h-6 text-indigo-600 dark:text-indigo-300"></i>
                                </div>
                                <h3 class="text-xl font-semibold">Your Progress</h3>
                            </div>
                            <p class="text-slate-500 dark:text-slate-400 mt-4 mb-5 flex-grow">Review your quiz history
                                and track your improvement over time.</p>
                            <div class="space-y-3">
                                <div>
                                    <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Average Score</p>
                                    <p id="db-avg-score" class="text-2xl font-bold">N/A</p>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Quizzes Taken</p>
                                    <p id="db-quizzes-taken" class="text-2xl font-bold">0</p>
                                </div>
                            </div>
                            <button data-page="page-quiz-history"
                                class="nav-button w-full mt-5 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2.5 px-4 rounded-lg">
                                View History
                            </button>
                        </div>

                    </div>
                </div>

                <!-- 
                  ================ PAGE: MANAGE BANK ================
                -->
                <div id="page-manage-bank" class="page-content hidden space-y-6">

                    <!-- Subjects Management -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow">
                        <h2 class="text-2xl font-bold mb-4">Manage Subjects</h2>

                        <!-- Form to Add Subject -->
                        <form id="add-subject-form" class="flex items-center space-x-2 mb-4">
                            <input type="text" id="new-subject-name" placeholder="New subject name (e.g., HTML)"
                                required
                                class="flex-grow px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-transparent">
                            <button type="submit"
                                class="bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center space-x-2 shrink-0">
                                <i data-lucide="plus" class="w-5 h-5"></i>
                                <span>Add Subject</span>
                            </button>
                        </form>
                        <p id="add-subject-error" class="text-sm text-red-500 mb-4 hidden"></p>

                        <!-- List of Subjects -->
                        <div id="subject-list" class="space-y-2 max-h-48 overflow-y-auto pr-2">
                            <!-- Subjects will be dynamically inserted here -->
                            <p id="no-subjects-msg" class="text-slate-500 dark:text-slate-400">No subjects added yet.
                            </p>
                        </div>
                    </div>

                    <!-- Questions Management -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow">
                        <h2 class="text-2xl font-bold mb-4">Manage Questions</h2>

                        <!-- Form to Add Question -->
                        <form id="add-question-form" class="space-y-4">
                            <!-- Subject Select -->
                            <div>
                                <label for="question-subject"
                                    class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Subject</label>
                                <select id="question-subject" required
                                    class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-transparent">
                                    <option value="">Select a subject</option>
                                    <!-- Subject options will be dynamically inserted here -->
                                </select>
                            </div>

                            <!-- Question Text -->
                            <div>
                                <label for="question-text"
                                    class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Question</label>
                                <textarea id="question-text" rows="2" required
                                    class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-transparent"
                                    placeholder="What does HTML stand for?"></textarea>
                            </div>

                            <!-- Options -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="option-0"
                                        class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Option
                                        1 (Correct Answer)</label>
                                    <input type="text" id="option-0" required
                                        class="question-option w-full px-4 py-2 border border-emerald-400 dark:border-emerald-600 rounded-lg bg-emerald-50 dark:bg-emerald-900 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                                        placeholder="Correct Answer">
                                </div>
                                <div>
                                    <label for="option-1"
                                        class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Option
                                        2</label>
                                    <input type="text" id="option-1" required
                                        class="question-option w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-sky-500"
                                        placeholder="Wrong Answer 1">
                                </div>
                                <div>
                                    <label for="option-2"
                                        class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Option
                                        3</label>
                                    <input type="text" id="option-2" required
                                        class="question-option w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-sky-500"
                                        placeholder="Wrong Answer 2">
                                </div>
                                <div>
                                    <label for="option-3"
                                        class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Option
                                        4</label>
                                    <input type="text" id="option-3" required
                                        class="question-option w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-sky-500"
                                        placeholder="Wrong Answer 3">
                                </div>
                            </div>

                            <p id="add-question-error" class="text-sm text-red-500 hidden"></p>

                            <!-- Add Question Button -->
                            <div class="text-right">
                                <button type="submit"
                                    class="bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2.5 px-5 rounded-lg flex items-center space-x-2 float-right">
                                    <i data-lucide="plus" class="w-5 h-5"></i>
                                    <span>Add Question</span>
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- List of Questions -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow">
                        <h2 class="text-2xl font-bold mb-4">Current Question Bank</h2>
                        <div id="question-bank-list" class="space-y-4">
                            <!-- Questions grouped by subject will be inserted here -->
                            <p id="no-questions-msg" class="text-slate-500 dark:text-slate-400">No questions added yet.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- 
                  ================ PAGE: TAKE QUIZ ================
                -->
                <div id="page-take-quiz" class="page-content hidden">
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow">
                        <h2 class="text-2xl font-bold mb-4">Select a Quiz</h2>
                        <p class="text-slate-500 dark:text-slate-400 mb-6">Choose a subject to start your quiz. You must
                            add subjects and questions in the "Manage Bank" section first.</p>

                        <div id="quiz-selection-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- Quiz subject cards will be inserted here -->
                            <p id="no-quizzes-msg"
                                class="text-slate-500 dark:text-slate-400 md:col-span-2 lg:col-span-3">No quizzes
                                available. Go to "Manage Bank" to add subjects and questions.</p>
                        </div>
                    </div>
                </div>

                <!-- 
                  ================ PAGE: QUIZ ACTIVE ================
                -->
                <div id="page-quiz-active" class="page-content hidden">
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow max-w-3xl mx-auto">
                        <!-- Quiz Header -->
                        <div class="flex justify-between items-center mb-4">
                            <h2 id="quiz-active-title" class="text-2xl font-bold">HTML Quiz</h2>
                            <span id="quiz-progress-text"
                                class="text-lg font-semibold text-sky-600 dark:text-sky-300">Question 1 / 10</span>
                        </div>

                        <!-- Progress Bar -->
                        <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2.5 mb-6">
                            <div id="quiz-progress-bar" class="bg-sky-600 h-2.5 rounded-full" style="width: 10%"></div>
                        </div>

                        <!-- Question -->
                        <div class="mb-6">
                            <p id="quiz-active-question" class="text-xl font-medium mb-6 min-h-[50px]">What does HTML
                                stand for?</p>
                            <div id="quiz-options-container" class="space-y-3">
                                <!-- Options will be dynamically inserted here -->
                            </div>
                        </div>

                        <!-- Feedback Message -->
                        <div id="quiz-feedback" class="hidden p-4 rounded-lg mb-6 text-sm"></div>

                        <!-- Navigation -->
                        <div class="flex justify-between items-center">
                            <button id="quiz-exit-button"
                                class="bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 font-semibold py-2.5 px-5 rounded-lg">
                                Exit Quiz
                            </button>
                            <button id="quiz-next-button"
                                class="bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2.5 px-5 rounded-lg">
                                Next
                            </button>
                            <button id="quiz-submit-button"
                                class="hidden bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2.5 px-5 rounded-lg">
                                Submit Quiz
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 
                  ================ PAGE: QUIZ RESULTS ================
                -->
                <div id="page-quiz-results" class="page-content hidden">
                    <div class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow max-w-2xl mx-auto text-center">
                        <i data-lucide="check-circle" class="w-20 h-20 text-emerald-500 mx-auto"></i>
                        <h2 class="text-4xl font-bold mt-4">Quiz Complete!</h2>
                        <p id="results-subject-name" class="text-lg text-slate-500 dark:text-slate-400 mt-1">HTML Quiz
                        </p>

                        <div class="my-8">
                            <p class="text-lg text-slate-600 dark:text-slate-300">Your Score:</p>
                            <p id="results-score-text" class="text-7xl font-bold text-sky-600 dark:text-sky-300 my-2">
                                80%</p>
                            <p id="results-score-details" class="text-lg text-slate-600 dark:text-slate-300">You
                                answered 8 out of 10 questions correctly.</p>
                        </div>

                        <div class="flex items-center justify-center space-x-4">
                            <button data-page="page-home"
                                class="nav-button bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 font-semibold py-2.5 px-6 rounded-lg">
                                Go to Home
                            </button>
                            <button id="results-retake-button"
                                class="bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2.5 px-6 rounded-lg">
                                Retake Quiz
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 
                  ================ PAGE: QUIZ HISTORY ================
                -->
                <div id="page-quiz-history" class="page-content hidden">
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow">
                        <h2 class="text-2xl font-bold mb-4">Quiz History</h2>
                        <div class="overflow-x-auto">
                            <table class="w-full min-w-[600px] text-left">
                                <thead class="border-b border-slate-200 dark:border-slate-700">
                                    <tr>
                                        <th class="p-3 text-sm font-semibold text-slate-500 dark:text-slate-400">Subject
                                        </th>
                                        <th class="p-3 text-sm font-semibold text-slate-500 dark:text-slate-400">Date
                                        </th>
                                        <th class="p-3 text-sm font-semibold text-slate-500 dark:text-slate-400">Score
                                        </th>
                                        <th class="p-3 text-sm font-semibold text-slate-500 dark:text-slate-400">Correct
                                        </th>
                                        <th class="p-3 text-sm font-semibold text-slate-500 dark:text-slate-400">Total
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="quiz-history-table-body">
                                    <!-- History rows will be inserted here -->
                                    <tr id="no-history-msg">
                                        <td colspan="5" class="p-4 text-center text-slate-500 dark:text-slate-400">You
                                            haven't completed any quizzes yet.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 
                  ================ PAGE: SETTINGS & DATA ================
                -->
                <div id="page-settings" class="page-content hidden space-y-6">
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow">
                        <h2 class="text-2xl font-bold mb-4">Data Management</h2>
                        <p class="text-slate-500 dark:text-slate-400 mb-6">Export your data for backup or import it to a
                            new device. You can also delete all your data permanently.</p>

                        <div class="flex items-center space-x-4">
                            <button id="export-data-button"
                                class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2.5 px-5 rounded-lg flex items-center space-x-2">
                                <i data-lucide="download" class="w-5 h-5"></i>
                                <span>Export My Data</span>
                            </button>

                            <label
                                class="bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2.5 px-5 rounded-lg flex items-center space-x-2 cursor-pointer">
                                <i data-lucide="upload" class="w-5 h-5"></i>
                                <span>Import Data</span>
                                <input type="file" id="import-data-input" accept=".json" class="hidden">
                            </label>
                            <p id="import-status" class="text-sm text-slate-500"></p>
                        </div>
                    </div>

                    <div
                        class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow border-2 border-red-300 dark:border-red-700">
                        <h2 class="text-2xl font-bold mb-4 text-red-700 dark:text-red-300">Danger Zone</h2>
                        <p class="text-slate-500 dark:text-slate-400 mb-6">This action is irreversible. All your
                            subjects, questions, and quiz history will be permanently deleted.</p>

                        <button id="delete-all-data-button"
                            class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2.5 px-5 rounded-lg flex items-center space-x-2">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                            <span>Delete All My Data</span>
                        </button>
                    </div>
                </div>

            </div> <!-- /End Content Pages Wrapper -->
        </main> <!-- /End Main Content Area -->
    </div> <!-- /End App Shell -->

    <!-- 
      ================================================================
      CUSTOM MODAL (for confirmations)
      ================================================================
    -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black/50 z-40 hidden flex items-center justify-center p-4">
        <div id="modal" class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl w-full max-w-md p-6">
            <h3 id="modal-title" class="text-xl font-bold mb-2">Are you sure?</h3>
            <p id="modal-message" class="text-slate-600 dark:text-slate-300 mb-6">This action cannot be undone.</p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel-button"
                    class="bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 font-semibold py-2 px-4 rounded-lg">
                    Cancel
                </button>
                <button id="modal-confirm-button"
                    class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg">
                    Confirm
                </button>
            </div>
        </div>
    </div>


    <script type="module">
        // 
        // =================================================================
        // === FIREBASE & APP INITIALIZATION ===============================
        // =================================================================
        // 

        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signInWithPopup,
            GoogleAuthProvider,
            signOut,
            updateProfile
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            getDoc,
            setDoc,
            addDoc,
            updateDoc,
            deleteDoc,
            onSnapshot,
            collection,
            query,
            writeBatch,
            getDocs,
            Timestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- PASTE YOUR FIREBASE CONFIG HERE ---
        // You can get this from your Firebase project settings
        const firebaseConfig = {
            apiKey: "AIzaSyDXZZVwU6Q8l5GtK8ngxfIkQLEVkbihNhM",
            authDomain: "studyhelper-quizzes.firebaseapp.com",
            projectId: "studyhelper-quizzes",
            storageBucket: "studyhelper-quizzes.firebasestorage.app",
            messagingSenderId: "217416839389",
            appId: "1:217416839389:web:060ca955eaa8befce12b34",
            measurementId: "G-4XVEYVNL7L"
        };
        // ---------------------------------------

        // Initialize Firebase
        let app, auth, db;
        try {
            // Check for __firebase_config first (for canvas environment)
            const config = typeof __firebase_config !== 'undefined'
                ? JSON.parse(__firebase_config)
                : firebaseConfig;

            app = initializeApp(config);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log("Firebase initialized successfully.");
        } catch (error) {
            console.error("Error initializing Firebase:", error);
            document.getElementById('app-loader').innerHTML = '<p class="text-red-500 p-4">Error: Firebase config is missing or invalid. Please check `index.html`.</p>';
            // Stop further execution if Firebase fails
            throw new Error("Firebase initialization failed.");
        }

        // App-wide variables
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'studyhelper-app';
        let currentUserId = null;
        let currentAuthUser = null;

        // Global state object
        const appState = {
            subjects: [],
            questions: [],
            quizHistory: [],
            activeQuiz: null, // { subject, questions, currentIndex, userAnswers, score }
        };

        // Firestore collection unsubscribe listeners
        // We need to store these so we can detach them on logout
        let unsubSubjects = () => { };
        let unsubQuestions = () => { };
        let unsubHistory = () => { };

    
        // === DOM ELEMENT SELECTORS =======================================
       
  
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        const appLoader = $('#app-loader');
        const loginPage = $('#login-page');
        const appShell = $('#app-shell');
        const pageTitle = $('#page-title');
        const contentPages = $$('.page-content');

        // Auth
        const authForm = $('#auth-form');
        const authFormTitle = $('#auth-form-title');
        const authError = $('#auth-error');
        const emailInput = $('#email');
        const passwordInput = $('#password');
        const loginButtons = $('#login-buttons');
        const signupButtons = $('#signup-buttons');

        // Sidebar
        const userAvatar = $('#user-avatar');
        const userDisplayName = $('#user-display-name');
        const userEmail = $('#user-email');

        // Modals
        const modalBackdrop = $('#modal-backdrop');
        const modal = $('#modal');
        const modalTitle = $('#modal-title');
        const modalMessage = $('#modal-message');
        const modalCancelBtn = $('#modal-cancel-button');
        const modalConfirmBtn = $('#modal-confirm-button');
        let modalConfirmCallback = null;

        // Manage Bank
        const addSubjectForm = $('#add-subject-form');
        const newSubjectNameInput = $('#new-subject-name');
        const addSubjectError = $('#add-subject-error');
        const subjectList = $('#subject-list');
        const noSubjectsMsg = $('#no-subjects-msg');

        const addQuestionForm = $('#add-question-form');
        const questionSubjectSelect = $('#question-subject');
        const questionTextInput = $('#question-text');
        const questionOptions = $$('.question-option');
        const addQuestionError = $('#add-question-error');
        const questionBankList = $('#question-bank-list');
        const noQuestionsMsg = $('#no-questions-msg');

        // Dashboard
        const welcomeUserName = $('#welcome-user-name');
        const dbQuestionCount = $('#db-question-count');
        const dbSubjectCount = $('#db-subject-count');
        const dbAvgScore = $('#db-avg-score');
        const dbQuizzesTaken = $('#db-quizzes-taken');

        // Take Quiz
        const quizSelectionList = $('#quiz-selection-list');
        const noQuizzesMsg = $('#no-quizzes-msg');

        // Active Quiz
        const quizActiveTitle = $('#quiz-active-title');
        const quizProgressText = $('#quiz-progress-text');
        const quizProgressBar = $('#quiz-progress-bar');
        const quizActiveQuestion = $('#quiz-active-question');
        const quizOptionsContainer = $('#quiz-options-container');
        const quizFeedback = $('#quiz-feedback');
        const quizNextButton = $('#quiz-next-button');
        const quizSubmitButton = $('#quiz-submit-button');

        // Results Page
        const resultsSubjectName = $('#results-subject-name');
        const resultsScoreText = $('#results-score-text');
        const resultsScoreDetails = $('#results-score-details');
        const resultsRetakeButton = $('#results-retake-button');

        // History Page
        const quizHistoryTableBody = $('#quiz-history-table-body');
        const noHistoryMsg = $('#no-history-msg');


        // 
        // =================================================================
        // === UTILITY & HELPER FUNCTIONS ==================================
        // =================================================================
        // 

        /**
         * Clears all active Firestore listeners. Called on logout.
         */
        function detachFirestoreListeners() {
            unsubSubjects();
            unsubQuestions();
            unsubHistory();
            console.log("Firestore listeners detached.");
        }

        /**
         * Resets the global app state. Called on logout.
         */
        function resetAppState() {
            appState.subjects = [];
            appState.questions = [];
            appState.quizHistory = [];
            appState.activeQuiz = null;
            console.log("App state reset.");
        }

        /**
         * Clears all dynamically rendered content from the UI. Called on logout.
         */
        function clearDynamicUI() {
            subjectList.innerHTML = '';
            questionSubjectSelect.innerHTML = '<option value="">Select a subject</option>';
            questionBankList.innerHTML = '';
            quizSelectionList.innerHTML = '';
            quizHistoryTableBody.innerHTML = '';

            // Add back the "no items" messages
            subjectList.append(noSubjectsMsg);
            questionBankList.append(noQuestionsMsg);
            quizSelectionList.append(noQuizzesMsg);
            quizHistoryTableBody.append(noHistoryMsg);

            // Reset dashboard
            welcomeUserName.textContent = 'User';
            dbQuestionCount.textContent = '0';
            dbSubjectCount.textContent = '0';
            dbAvgScore.textContent = 'N/A';
            dbQuizzesTaken.textContent = '0';
        }

        /**
         * Shows a page by its ID and hides all others.
         * @param {string} pageId - The ID of the page-content element to show.
         */
        function showPage(pageId) {
            contentPages.forEach(page => page.classList.add('hidden'));
            const newPage = $(`#${pageId}`);
            if (newPage) {
                newPage.classList.remove('hidden');

                // Update page title
                const link = $(`[data-page="${pageId}"]`);
                if (link) {
                    pageTitle.textContent = link.querySelector('span').textContent;
                    // Update active sidebar link
                    $$('.sidebar-link').forEach(l => l.setAttribute('data-active', 'false'));
                    link.setAttribute('data-active', 'true');
                } else if (pageId === 'page-home') {
                    // Handle special case for home/dashboard
                    pageTitle.textContent = 'Home';
                    $('[data-page="page-home"]').setAttribute('data-active', 'true');
                } else {
                    // For non-sidebar pages like quiz-active
                    pageTitle.textContent = pageId.replace('page-', '').replace('-', ' ');
                }

                // Show/hide quick start button
                $('#quick-start-button').classList.toggle('hidden', pageId === 'page-take-quiz');
            }
        }

        /**
         * Shows the custom modal dialog.
         * @param {string} title - The title for the modal.
         * @param {string} message - The message body for the modal.
         * @param {function} onConfirm - The callback function to execute on confirm.
         * @param {string} [confirmText='Confirm'] - The text for the confirm button.
         * @param {string} [confirmClass='bg-red-600'] - The bg color class for the confirm button.
         */
        function showModal(title, message, onConfirm, confirmText = 'Confirm', confirmClass = 'bg-red-600') {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalConfirmBtn.textContent = confirmText;

            // Reset confirm button classes
            modalConfirmBtn.className = 'text-white font-semibold py-2 px-4 rounded-lg';
            modalConfirmBtn.classList.add(confirmClass); // Add the specific class

            modalConfirmCallback = onConfirm;
            modalBackdrop.classList.remove('hidden');
        }

        /**
         * Hides the custom modal dialog.
         */
        function hideModal() {
            modalBackdrop.classList.add('hidden');
            modalConfirmCallback = null;
        }

        // Add modal button listeners
        modalCancelBtn.addEventListener('click', hideModal);
        modalConfirmBtn.addEventListener('click', () => {
            if (typeof modalConfirmCallback === 'function') {
                modalConfirmCallback();
            }
            hideModal();
        });

        /**
         * Shows an error message in the auth form.
         * @param {string} message - The error message to display.
         */
        function showAuthError(message) {
            authError.textContent = message;
            authError.classList.remove('hidden');
        }

        /**
         * Hides the auth form error message.
         */
        function hideAuthError() {
            authError.classList.add('hidden');
            authError.textContent = '';
        }

        /**
         * Formats a Firebase Timestamp into a readable date string.
         * @param {Timestamp} timestamp - The Firebase Timestamp object.
         * @returns {string} - Formatted date string (e.g., "Oct 30, 2025").
         */
        function formatFirebaseDate(timestamp) {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate();
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        }

        /**
         * Shuffles an array in place. (Fisher-Yates shuffle)
         * @param {Array} array - The array to shuffle.
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // 
        // =================================================================
        // === AUTHENTICATION LOGIC ========================================
        // =================================================================
        // 

        /**
         * Main auth state listener. This controls the entire app flow.
         */
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in
                console.log("Auth state changed: User is signed in.", user.uid);
                currentAuthUser = user;

                // Handle canvas auth token
                if (typeof __initial_auth_token === 'undefined') {
                    currentUserId = user.uid;
                } else {
                    // In canvas, use the UID from the token, not the auth state
                    // This is a placeholder, as the custom token flow is complex.
                    // For this static build, we'll just use the auth uid.
                    currentUserId = user.uid;
                }

                updateUserInfoUI(user);
                attachFirestoreListeners();

                loginPage.classList.add('hidden');
                appShell.classList.remove('hidden');
                appLoader.classList.add('hidden');
                showPage('page-home');

            } else {
                // User is signed out
                console.log("Auth state changed: User is signed out.");
                currentAuthUser = null;
                currentUserId = null;

                detachFirestoreListeners();
                resetAppState();
                clearDynamicUI();

                appShell.classList.add('hidden');
                loginPage.classList.remove('hidden');
                appLoader.classList.add('hidden');
            }
        });

        // Handle Canvas custom token auth
        async function initializeAuth() {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                try {
                    console.log("Attempting sign in with custom token...");
                    await signInWithCustomToken(auth, __initial_auth_token);
                    console.log("Custom token sign in successful.");
                } catch (error) {
                    console.error("Custom token sign in failed:", error);
                    // Fallback to anonymous
                    await signInAnonymously(auth);
                }
            } else if (auth.currentUser) {
                // Already signed in (e.g., from persistence)
                console.log("User already signed in:", auth.currentUser.uid);
                // onAuthStateChanged will handle the rest
            } else {
                // No token, no current user. Show login page.
                console.log("No user or token found. Showing login page.");
                appShell.classList.add('hidden');
                loginPage.classList.remove('hidden');
                appLoader.classList.add('hidden');
            }
        }

        /**
         * Updates the sidebar UI with user information.
         * @param {object} user - The Firebase Auth user object.
         */
        function updateUserInfoUI(user) {
            if (user) {
                const displayName = user.displayName || 'Anonymous User';
                userDisplayName.textContent = displayName;
                welcomeUserName.textContent = displayName.split(' ')[0]; // Just first name
                userEmail.textContent = user.email || 'No email provided';
                if (user.photoURL) {
                    userAvatar.src = user.photoURL;
                } else {
                    // Placeholder with first initial
                    const initial = (displayName[0] || 'U').toUpperCase();
                    userAvatar.src = `https://placehold.co/40x40/e2e8f0/64748b?text=${initial}`;
                }
            }
        }

        /**
         * Toggles the auth form between Login and Sign Up.
         * @param {'login' | 'signup'} mode - The mode to switch to.
         */
        function setAuthFormMode(mode) {
            hideAuthError();
            if (mode === 'signup') {
                authFormTitle.textContent = 'Create a new account';
                loginButtons.classList.add('hidden');
                signupButtons.classList.remove('hidden');
            } else {
                authFormTitle.textContent = 'Sign in to your account';
                loginButtons.classList.remove('hidden');
                signupButtons.classList.add('hidden');
            }
        }

        // Auth form submission listener
        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideAuthError();

            const email = emailInput.value;
            const password = passwordInput.value;
            const isSignUp = !signupButtons.classList.contains('hidden');

            try {
                if (isSignUp) {
                    // --- Handle Sign Up ---
                    console.log('Attempting sign up...');
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    console.log('Sign up successful:', userCredential.user.uid);
                    // Update profile with a default name from email
                    const defaultName = email.split('@')[0];
                    await updateProfile(userCredential.user, {
                        displayName: defaultName
                    });
                    // onAuthStateChanged will handle the UI transition
                } else {
                    // --- Handle Login ---
                    console.log('Attempting login...');
                    await signInWithEmailAndPassword(auth, email, password);
                    console.log('Login successful.');
                    // onAuthStateChanged will handle the UI transition
                }
            } catch (error) {
                console.error("Auth error:", error.message);
                showAuthError(error.message);
            }
        });

        // Auth form toggle listeners
        $('#toggle-to-signup').addEventListener('click', () => setAuthFormMode('signup'));
        $('#toggle-to-login').addEventListener('click', () => setAuthFormMode('login'));

        // Google Sign-In listener
        $('#google-signin-button').addEventListener('click', async () => {
            hideAuthError();
            const provider = new GoogleAuthProvider();
            try {
                console.log('Attempting Google Sign-In...');
                await signInWithPopup(auth, provider);
                console.log('Google Sign-In successful.');
                // onAuthStateChanged will handle the UI transition
            } catch (error) {
                console.error("Google Sign-In error:", error.message);
                showAuthError(error.message);
            }
        });

        // Logout listener
        $('#logout-button').addEventListener('click', () => {
            console.log('Attempting sign out...');
            signOut(auth);
        });

        // 
        // =================================================================
        // === FIRESTORE PATHS & LISTENERS =================================
        // =================================================================
        // 

        // --- Path Builder Functions ---
        // We use functions to ensure currentUserId is fresh.
        // NOTE: Firestore security rules MUST enforce these paths.

        // Collection for subjects (e.g., 'HTML', 'CSS')
        const getSubjectsCol = () => collection(db, `artifacts/${appId}/users/${currentUserId}/subjects`);
        // Collection for all questions
        const getQuestionsCol = () => collection(db, `artifacts/${appId}/users/${currentUserId}/questions`);
        // Collection for quiz attempt history
        const getHistoryCol = () => collection(db, `artifacts/${appId}/users/${currentUserId}/quizHistory`);

        /**
         * Attaches all real-time Firestore listeners.
         * This is called on successful login.
         */
        function attachFirestoreListeners() {
            if (!currentUserId) return;
            console.log(`Attaching Firestore listeners for user ${currentUserId}`);

            // --- Listener for Subjects ---
            const subjectsQuery = query(getSubjectsCol());
            unsubSubjects = onSnapshot(subjectsQuery, (snapshot) => {
                appState.subjects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log('Firestore update: Subjects', appState.subjects);
                renderSubjectList();
                renderQuestionSubjectSelect();
                renderQuizSelectionList();
                renderDashboardStats(); // Update subject count
            }, (error) => console.error("Error listening to subjects:", error));

            // --- Listener for Questions ---
            const questionsQuery = query(getQuestionsCol());
            unsubQuestions = onSnapshot(questionsQuery, (snapshot) => {
                appState.questions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log('Firestore update: Questions', appState.questions);
                renderQuestionBankList();
                renderQuizSelectionList(); // Update question counts on quiz cards
                renderDashboardStats(); // Update question count
            }, (error) => console.error("Error listening to questions:", error));

            // --- Listener for Quiz History ---
            const historyQuery = query(getHistoryCol());
            unsubHistory = onSnapshot(historyQuery, (snapshot) => {
                appState.quizHistory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Sort by date, newest first
                appState.quizHistory.sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis());
                console.log('Firestore update: Quiz History', appState.quizHistory);
                renderQuizHistoryTable();
                renderDashboardStats(); // Update progress stats
            }, (error) => console.error("Error listening to quiz history:", error));
        }

        // 
        // =================================================================
        // === UI RENDERING FUNCTIONS ======================================
        // =================================================================
        // 

        /**
         * Renders the list of subjects in "Manage Bank".
         */
        function renderSubjectList() {
            if (appState.subjects.length === 0) {
                subjectList.innerHTML = '';
                subjectList.append(noSubjectsMsg);
                return;
            }

            subjectList.innerHTML = appState.subjects.map(subject => `
                <div class="flex items-center justify-between p-3 bg-slate-100 dark:bg-slate-700 rounded-lg">
                    <span class="font-medium">${subject.name}</span>
                    <button class="delete-subject-btn text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300" data-id="${subject.id}" data-name="${subject.name}">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        /**
         * Renders the <select> dropdown for subjects in "Manage Bank".
         */
        function renderQuestionSubjectSelect() {
            if (appState.subjects.length === 0) {
                questionSubjectSelect.innerHTML = '<option value="">Add a subject first</option>';
                return;
            }

            questionSubjectSelect.innerHTML = '<option value="">Select a subject</option>' +
                appState.subjects.map(subject => `
                    <option value="${subject.id}">${subject.name}</option>
                `).join('');
        }

        /**
         * Renders the list of questions in "Manage Bank", grouped by subject.
         */
        function renderQuestionBankList() {
            if (appState.questions.length === 0) {
                questionBankList.innerHTML = '';
                questionBankList.append(noQuestionsMsg);
                return;
            }

            // Group questions by subjectId
            const questionsBySubject = appState.subjects.reduce((acc, subject) => {
                acc[subject.id] = {
                    name: subject.name,
                    questions: appState.questions.filter(q => q.subjectId === subject.id)
                };
                return acc;
            }, {});

            questionBankList.innerHTML = Object.values(questionsBySubject)
                .filter(group => group.questions.length > 0) // Only show subjects with questions
                .map(group => `
                    <div class="mb-4">
                        <h3 class="text-lg font-semibold border-b border-slate-200 dark:border-slate-700 pb-2 mb-3">${group.name}</h3>
                        <div class="space-y-3">
                            ${group.questions.map(q => `
                                <div class="p-3 bg-slate-50 dark:bg-slate-700 rounded-lg">
                                    <div class="flex justify-between items-start">
                                        <p class="font-medium text-slate-800 dark:text-slate-100">${q.question}</p>
                                        <button class="delete-question-btn text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 ml-4 shrink-0" data-id="${q.id}">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                    <ul class="mt-2 space-y-1 text-sm">
                                        ${q.options.map((opt, index) => `
                                            <li class="${index === q.correctAnswerIndex ? 'text-emerald-600 dark:text-emerald-400 font-medium' : 'text-slate-600 dark:text-slate-400'}">
                                                ${index === q.correctAnswerIndex ? '<i data-lucide="check" class="w-4 h-4 inline-block -mt-1 mr-1"></i>' : ''}
                                                ${opt}
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            lucide.createIcons();
        }

        /**
         * Renders the subject cards on the "Take Quiz" page.
         */
        function renderQuizSelectionList() {
            // Create a map of question counts by subject
            const questionCounts = appState.questions.reduce((acc, q) => {
                acc[q.subjectId] = (acc[q.subjectId] || 0) + 1;
                return acc;
            }, {});

            const availableQuizzes = appState.subjects
                .map(subject => ({
                    ...subject,
                    questionCount: questionCounts[subject.id] || 0
                }))
                .filter(subject => subject.questionCount > 0); // Only show quizzes with questions

            if (availableQuizzes.length === 0) {
                quizSelectionList.innerHTML = '';
                quizSelectionList.append(noQuizzesMsg);
                return;
            }

            quizSelectionList.innerHTML = availableQuizzes.map(subject => `
                <div class="bg-slate-50 dark:bg-slate-700 p-5 rounded-xl shadow-sm border border-slate-200 dark:border-slate-600">
                    <h3 class="text-xl font-semibold">${subject.name}</h3>
                    <p class="text-slate-500 dark:text-slate-400 my-3">${subject.questionCount} Questions</p>
                    <button class="start-quiz-btn w-full bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2 px-4 rounded-lg" data-subject-id="${subject.id}" data-subject-name="${subject.name}">
                        Start Quiz
                    </button>
                </div>
            `).join('');
        }

        /**
         * Renders the Quiz History table.
         */
        function renderQuizHistoryTable() {
            if (appState.quizHistory.length === 0) {
                quizHistoryTableBody.innerHTML = '';
                quizHistoryTableBody.append(noHistoryMsg);
                return;
            }

            quizHistoryTableBody.innerHTML = appState.quizHistory.map(item => `
                <tr class="border-b border-slate-200 dark:border-slate-700">
                    <td class="p-3 font-medium">${item.subjectName}</td>
                    <td class="p-3 text-slate-600 dark:text-slate-400">${formatFirebaseDate(item.timestamp)}</td>
                    <td class="p-3 font-semibold ${item.score >= 70 ? 'text-emerald-600 dark:text-emerald-400' : 'text-red-600 dark:text-red-400'}">${item.score}%</td>
                    <td class="p-3 text-slate-600 dark:text-slate-400">${item.correct}</td>
                    <td class="p-3 text-slate-600 dark:text-slate-400">${item.total}</td>
                </tr>
            `).join('');
        }

        /**
         * Updates all stats on the Home/Dashboard page.
         */
        function renderDashboardStats() {
            // Question/Subject counts
            dbSubjectCount.textContent = appState.subjects.length;
            dbQuestionCount.textContent = appState.questions.length;

            // Progress stats
            const history = appState.quizHistory;
            dbQuizzesTaken.textContent = history.length;

            if (history.length > 0) {
                const totalScore = history.reduce((sum, item) => sum + item.score, 0);
                const avg = Math.round(totalScore / history.length);
                dbAvgScore.textContent = `${avg}%`;
            } else {
                dbAvgScore.textContent = 'N/A';
            }
        }

        // 
        // =================================================================
        // === "MANAGE BANK" LOGIC =========================================
        // =================================================================
        // 

        // --- Add New Subject ---
        addSubjectForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const subjectName = newSubjectNameInput.value.trim();
            if (!subjectName) return;

            // Check for duplicates (case-insensitive)
            if (appState.subjects.some(s => s.name.toLowerCase() === subjectName.toLowerCase())) {
                addSubjectError.textContent = 'This subject already exists.';
                addSubjectError.classList.remove('hidden');
                return;
            }

            addSubjectError.classList.add('hidden');
            try {
                const docRef = await addDoc(getSubjectsCol(), {
                    name: subjectName
                });
                console.log("Subject added with ID:", docRef.id);
                newSubjectNameInput.value = '';
            } catch (error) {
                console.error("Error adding subject:", error);
                addSubjectError.textContent = 'Error adding subject. Please try again.';
                addSubjectError.classList.remove('hidden');
            }
        });

        // --- Delete Subject (Event Delegation) ---
        subjectList.addEventListener('click', (e) => {
            const deleteButton = e.target.closest('.delete-subject-btn');
            if (!deleteButton) return;

            const subjectId = deleteButton.dataset.id;
            const subjectName = deleteButton.dataset.name;

            showModal(
                'Delete Subject?',
                `Are you sure you want to delete "${subjectName}"? This will also delete all associated questions. This cannot be undone.`,
                async () => {
                    console.log(`Deleting subject: ${subjectId}`);
                    try {
                        // This requires a batch write to delete the subject AND its questions
                        const batch = writeBatch(db);

                        // 1. Delete the subject doc
                        const subjectDocRef = doc(getSubjectsCol(), subjectId);
                        batch.delete(subjectDocRef);

                        // 2. Find and delete all questions for this subject
                        const questionsToDelete = appState.questions.filter(q => q.subjectId === subjectId);
                        questionsToDelete.forEach(q => {
                            const questionDocRef = doc(getQuestionsCol(), q.id);
                            batch.delete(questionDocRef);
                        });

                        await batch.commit();
                        console.log(`Successfully deleted subject and ${questionsToDelete.length} questions.`);
                    } catch (error) {
                        console.error("Error deleting subject and questions:", error);
                    }
                }
            );
        });

        // --- Add New Question ---
        addQuestionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            addQuestionError.classList.add('hidden');

            const subjectId = questionSubjectSelect.value;
            const question = questionTextInput.value.trim();
            const options = Array.from(questionOptions).map(input => input.value.trim());
            const correctAnswerIndex = 0; // We defined Option 1 as the correct one

            // Validation
            if (!subjectId || !question || options.some(opt => !opt)) {
                addQuestionError.textContent = 'Please fill out all fields.';
                addQuestionError.classList.remove('hidden');
                return;
            }

            try {
                const docRef = await addDoc(getQuestionsCol(), {
                    subjectId: subjectId,
                    question: question,
                    options: options, // The array of 4 options
                    correctAnswerIndex: correctAnswerIndex // Always 0 based on our form
                });
                console.log("Question added with ID:", docRef.id);

                // Reset form
                addQuestionForm.reset();
                questionSubjectSelect.value = ''; // Reset select
            } catch (error) {
                console.error("Error adding question:", error);
                addQuestionError.textContent = 'Error adding question. Please try again.';
                addQuestionError.classList.remove('hidden');
            }
        });

        // --- Delete Question (Event Delegation) ---
        questionBankList.addEventListener('click', (e) => {
            const deleteButton = e.target.closest('.delete-question-btn');
            if (!deleteButton) return;

            const questionId = deleteButton.dataset.id;

            showModal(
                'Delete Question?',
                'Are you sure you want to delete this question?',
                async () => {
                    console.log(`Deleting question: ${questionId}`);
                    try {
                        await deleteDoc(doc(getQuestionsCol(), questionId));
                        console.log("Question deleted successfully.");
                    } catch (error) {
                        console.error("Error deleting question:", error);
                    }
                }
            );
        });

        // 
        // =================================================================
        // === QUIZ LOGIC ==================================================
        // =================================================================
        // 

        /**
         * Starts a new quiz.
         * @param {string} subjectId - The ID of the subject to start.
         * @param {string} subjectName - The name of the subject.
         */
        function startQuiz(subjectId, subjectName) {
            console.log(`Starting quiz for ${subjectName} (${subjectId})`);

            const questionsForSubject = appState.questions.filter(q => q.subjectId === subjectId);
            if (questionsForSubject.length === 0) {
                console.error("No questions found for this subject.");
                return;
            }

            // Create a *deep copy* of questions for this quiz instance
            // and shuffle the questions
            let quizQuestions = JSON.parse(JSON.stringify(questionsForSubject));
            shuffleArray(quizQuestions);

            // For each question, shuffle its options
            quizQuestions.forEach(q => {
                // Create an array of option objects: [{ text: 'Option A', isCorrect: true }, ...]
                const optionsWithState = q.options.map((optionText, index) => ({
                    text: optionText,
                    isCorrect: index === q.correctAnswerIndex
                }));

                // Shuffle this new array
                shuffleArray(optionsWithState);

                // Map back to simple text options and find new correct index
                q.options = optionsWithState.map(opt => opt.text);
                q.correctAnswerIndex = optionsWithState.findIndex(opt => opt.isCorrect);
            });

            // Set up the active quiz state
            appState.activeQuiz = {
                subjectId,
                subjectName,
                questions: quizQuestions,
                currentIndex: 0,
                userAnswers: new Array(quizQuestions.length).fill(null),
                score: 0
            };

            console.log("Active quiz state:", appState.activeQuiz);

            quizActiveTitle.textContent = `${subjectName} Quiz`;
            renderActiveQuizQuestion();
            showPage('page-quiz-active');
        }

        /**
         * Renders the current question in the active quiz.
         */
        function renderActiveQuizQuestion() {
            if (!appState.activeQuiz) return;

            const quiz = appState.activeQuiz;
            const q = quiz.questions[quiz.currentIndex];

            quizFeedback.classList.add('hidden');
            quizActiveQuestion.textContent = q.question;

            // Update progress
            const progress = ((quiz.currentIndex + 1) / quiz.questions.length) * 100;
            quizProgressText.textContent = `Question ${quiz.currentIndex + 1} / ${quiz.questions.length}`;
            quizProgressBar.style.width = `${progress}%`;

            // Render options
            quizOptionsContainer.innerHTML = q.options.map((option, index) => `
                <label class="block w-full p-4 border border-slate-300 dark:border-slate-600 rounded-lg cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors has-[:checked]:bg-sky-100 dark:has-[:checked]:bg-sky-900 has-[:checked]:border-sky-500">
                    <input type="radio" name="quiz-option" value="${index}" class="hidden">
                    <span class="text-base font-medium">${option}</span>
                </label>
            `).join('');

            // Show/hide next/submit buttons
            quizNextButton.classList.toggle('hidden', quiz.currentIndex === quiz.questions.length - 1);
            quizSubmitButton.classList.toggle('hidden', quiz.currentIndex !== quiz.questions.length - 1);
        }

        /**
         * Handles logic for the "Next" or "Submit" button click.
         */
        function handleQuizNext() {
            if (!appState.activeQuiz) return;

            const quiz = appState.activeQuiz;

            // 1. Get user's selected answer
            const selectedOption = $('input[name="quiz-option"]:checked');
            if (!selectedOption) {
                // User didn't select an answer
                quizFeedback.textContent = 'Please select an answer.';
                quizFeedback.className = 'p-4 rounded-lg mb-6 text-sm bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200';
                quizFeedback.classList.remove('hidden');
                return;
            }

            const selectedAnswerIndex = parseInt(selectedOption.value);
            quiz.userAnswers[quiz.currentIndex] = selectedAnswerIndex;

            // 2. Check if it's the last question
            if (quiz.currentIndex === quiz.questions.length - 1) {
                // This was the submit button
                finishQuiz();
            } else {
                // This was the next button
                quiz.currentIndex++;
                renderActiveQuizQuestion();
            }
        }

        /**
         * Calculates score, saves to Firestore, and shows results page.
         */
        async function finishQuiz() {
            if (!appState.activeQuiz) return;

            const quiz = appState.activeQuiz;

            // Calculate score
            let correctAnswers = 0;
            quiz.questions.forEach((q, index) => {
                if (q.correctAnswerIndex === quiz.userAnswers[index]) {
                    correctAnswers++;
                }
            });

            const totalQuestions = quiz.questions.length;
            const finalScore = Math.round((correctAnswers / totalQuestions) * 100);
            quiz.score = finalScore;

            console.log("Quiz finished. Score:", finalScore);

            // Save attempt to Firestore
            try {
                await addDoc(getHistoryCol(), {
                    subjectId: quiz.subjectId,
                    subjectName: quiz.subjectName,
                    score: finalScore,
                    correct: correctAnswers,
                    total: totalQuestions,
                    timestamp: Timestamp.now()
                });
                console.log("Quiz history saved to Firestore.");
            } catch (error) {
                console.error("Error saving quiz history:", error);
            }

            // Show results page
            resultsSubjectName.textContent = `${quiz.subjectName} Quiz`;
            resultsScoreText.textContent = `${finalScore}%`;
            resultsScoreDetails.textContent = `You answered ${correctAnswers} out of ${totalQuestions} questions correctly.`;

            // Set up retake button
            resultsRetakeButton.dataset.subjectId = quiz.subjectId;
            resultsRetakeButton.dataset.subjectName = quiz.subjectName;

            showPage('page-quiz-results');

            // Clear active quiz state
            appState.activeQuiz = null;
        }

        // --- Start Quiz (Event Delegation) ---
        quizSelectionList.addEventListener('click', (e) => {
            const startButton = e.target.closest('.start-quiz-btn');
            if (startButton) {
                const subjectId = startButton.dataset.subjectId;
                const subjectName = startButton.dataset.subjectName;
                startQuiz(subjectId, subjectName);
            }
        });

        // --- Quiz Navigation Buttons ---
        quizNextButton.addEventListener('click', handleQuizNext);
        quizSubmitButton.addEventListener('click', handleQuizNext);

        $('#quiz-exit-button').addEventListener('click', () => {
            showModal(
                'Exit Quiz?',
                'Are you sure you want to exit? Your progress for this attempt will be lost.',
                () => {
                    appState.activeQuiz = null;
                    showPage('page-take-quiz');
                }
            );
        });

        // --- Retake Quiz from Results ---
        resultsRetakeButton.addEventListener('click', (e) => {
            const { subjectId, subjectName } = e.currentTarget.dataset;
            startQuiz(subjectId, subjectName);
        });

        // 
        // =================================================================
        // === "SETTINGS & DATA" LOGIC =====================================
        // =================================================================
        // 

        // --- Export Data ---
        $('#export-data-button').addEventListener('click', () => {
            if (!currentUserId) return;

            const dataToExport = {
                subjects: appState.subjects.map(({ id, ...s }) => s), // Remove IDs
                questions: appState.questions.map(({ id, ...q }) => q), // Remove IDs
                quizHistory: appState.quizHistory.map(({ id, ...h }) => ({ // Remove IDs and convert Timestamps
                    ...h,
                    timestamp: h.timestamp.toDate().toISOString() // Convert to string
                }))
            };

            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `studyhelper_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // --- Import Data ---
        $('#import-data-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const importedData = JSON.parse(event.target.result);

                    if (!importedData.subjects || !importedData.questions || !importedData.quizHistory) {
                        throw new Error('Invalid backup file format.');
                    }

                    showModal(
                        'Import Data?',
                        'This will add all subjects, questions, and history from the file. It may create duplicates. Are you sure you want to continue?',
                        async () => {
                            await importDataToFirestore(importedData);
                        },
                        'Import',
                        'bg-sky-600'
                    );
                } catch (error) {
                    console.error('Error parsing import file:', error);
                    $('#import-status').textContent = `Error: ${error.message}`;
                }
            };
            reader.readAsText(file);
            e.target.value = null; // Reset input
        });

        async function importDataToFirestore(data) {
            if (!currentUserId) return;
            $('#import-status').textContent = 'Importing...';

            try {
                const batch = writeBatch(db);

                // Import subjects
                data.subjects.forEach(subject => {
                    const docRef = doc(getSubjectsCol()); // Create new doc with new ID
                    batch.set(docRef, subject);
                });

                // Import questions
                data.questions.forEach(question => {
                    const docRef = doc(getQuestionsCol());
                    batch.set(docRef, question);
                });

                // Import history
                data.quizHistory.forEach(item => {
                    const docRef = doc(getHistoryCol());
                    // Convert ISO string back to Firebase Timestamp
                    const itemWithTimestamp = {
                        ...item,
                        timestamp: Timestamp.fromDate(new Date(item.timestamp))
                    };
                    batch.set(docRef, itemWithTimestamp);
                });

                await batch.commit();
                console.log('Data import successful.');
                $('#import-status').textContent = 'Import successful!';
                setTimeout(() => $('#import-status').textContent = '', 3000);
            } catch (error) {
                console.error('Error importing data:', error);
                $('#import-status').textContent = 'Error during import.';
            }
        }

        // --- Delete All Data ---
        $('#delete-all-data-button').addEventListener('click', () => {
            showModal(
                'DELETE ALL DATA?',
                'This is your final warning. All your subjects, questions, and quiz history will be permanently erased. This cannot be undone.',
                async () => {
                    console.log('Deleting all data for user:', currentUserId);
                    try {
                        // This is a complex operation and requires deleting all docs in all 3 collections
                        const batch = writeBatch(db);

                        // Get all docs from each collection and add to batch
                        const subjectsSnapshot = await getDocs(getSubjectsCol());
                        subjectsSnapshot.forEach(doc => batch.delete(doc.ref));

                        const questionsSnapshot = await getDocs(getQuestionsCol());
                        questionsSnapshot.forEach(doc => batch.delete(doc.ref));

                        const historySnapshot = await getDocs(getHistoryCol());
                        historySnapshot.forEach(doc => batch.delete(doc.ref));

                        await batch.commit();
                        console.log('All user data deleted successfully.');
                    } catch (error) {
                        console.error('Error deleting all data:', error);
                    }
                }
            );
        });

        // 
        // =================================================================
        // === APP-WIDE EVENT LISTENERS ====================================
        // =================================================================
        // 

        // --- Sidebar Navigation ---
        $$('.sidebar-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const pageId = link.dataset.page;
                showPage(pageId);
            });
        });

        // --- Other Navigation Buttons (Event Delegation on document) ---
        document.addEventListener('click', (e) => {
            // Check for nav-buttons (used on dashboard cards, etc.)
            const navButton = e.target.closest('.nav-button');
            if (navButton) {
                e.preventDefault();
                const pageId = navButton.dataset.page;
                showPage(pageId);
            }

            // Check for quick start button
            if (e.target.closest('#quick-start-button')) {
                e.preventDefault();
                showPage('page-take-quiz');
            }
        });

        // --- Dark Mode Toggle ---
        $('#dark-mode-toggle').addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            // You could save this preference in localStorage or Firestore user settings
        });

        // --- Final Initialization ---
        lucide.createIcons(); // Initialize all icons on load
        initializeAuth(); // Start the auth process

    </script>
</body>

</html>