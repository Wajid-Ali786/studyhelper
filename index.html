<!DOCTYPE html>
<html lang="en" class=""> <!-- 'dark' class will be toggled here -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyHelper</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <script>
        // Set up Tailwind CSS
        tailwind.config = {
            darkMode: 'class', // Enable dark mode using a class
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        body, .app-shell, main, nav { 
            transition: background-color 0.3s ease, color 0.3s ease, margin-left 0.3s ease, width 0.3s ease; 
        }
        /* Hide number input spinners */
        input[type='number']::-webkit-outer-spin-button,
        input[type='number']::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type='number'] { -moz-appearance: textfield; }
        /* Sidebar active state */
        .sidebar-link[data-active="true"] {
            background-color: #e0f2fe; color: #0284c7; font-weight: 600;
        }
        .dark .sidebar-link[data-active="true"] {
            background-color: #0c4a6e; color: #e0f2fe;
        }
        /* Modal transitions */
        .modal-backdrop {
            transition: opacity 0.2s ease-in-out;
        }
        .modal-content {
            transition: transform 0.2s ease-in-out, opacity 0.2s ease-in-out;
            transform: scale(0.95);
            opacity: 0;
        }
        .modal-backdrop.open {
            opacity: 1;
        }
        .modal-backdrop.open .modal-content {
            transform: scale(1);
            opacity: 1;
        }
        /* Toast Notification */
        #toast-notification {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            transform: translateY(100%);
            opacity: 0;
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            z-index: 100;
        }
        #toast-notification.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        /* Sidebar collapsing */
        nav {
            width: 16rem; /* w-64 */
            transition: width 0.3s ease-in-out;
            z-index: 20;
        }
        main {
            margin-left: 16rem; /* ml-64 */
            width: calc(100% - 16rem);
            transition: margin-left 0.3s ease-in-out, width 0.3s ease-in-out;
        }
        nav.collapsed {
            width: 4.5rem; /* w-18 */
        }
        main.sidebar-collapsed {
            margin-left: 4.5rem;
            width: calc(100% - 4.5rem);
        }
        
        /* Hide text and show tooltips when collapsed */
        nav.collapsed .sidebar-text {
            display: none;
        }
        nav:not(.collapsed) .sidebar-tooltip {
            display: none;
        }
        nav.collapsed .sidebar-link {
            justify-content: center;
        }
        nav.collapsed .sidebar-logo-text {
            display: none;
        }
        nav.collapsed .sidebar-footer-text {
            display: none;
        }
        nav.collapsed #dark-mode-toggle span:first-child {
            margin: 0;
        }
        nav.collapsed #dark-mode-toggle span:first-child span {
             display: none;
        }
        nav.collapsed #dark-mode-toggle {
            justify-content: center;
        }
        
        /* Disabled button styles */
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Quiz answer feedback styles */
        .quiz-option-label.correct {
            background-color: #dcfce7; /* emerald-100 */
            border-color: #22c55e; /* emerald-500 */
        }
        .dark .quiz-option-label.correct {
            background-color: #064e3b; /* emerald-900 */
            border-color: #22c55e;
        }
        .quiz-option-label.incorrect {
            background-color: #fee2e2; /* red-100 */
            border-color: #ef4444; /* red-500 */
        }
        .dark .quiz-option-label.incorrect {
            background-color: #7f1d1d; /* red-900 */
            border-color: #ef4444;
        }
        .quiz-option-label.disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 font-sans text-slate-900 dark:text-slate-100 antialiased overflow-hidden">

    <!-- 
      ================================================================
      APP LOADER
      ================================================================
    -->
    <div id="app-loader" class="fixed inset-0 flex flex-col items-center justify-center bg-slate-50 dark:bg-slate-900 z-[100]">
        <svg class="animate-spin h-12 w-12 text-sky-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="mt-4 text-lg font-medium text-slate-700 dark:text-slate-300">Loading StudyHelper...</p>
        <p class="text-sm text-slate-500 dark:text-slate-400">Initializing secure session...</p>
    </div>

    <!-- 
      ================================================================
      MAIN APPLICATION SHELL
      Visible when the user is logged in (or on auth-ready).
      ================================================================
    -->
    <div id="app-shell" class="app-shell flex h-screen bg-slate-50 dark:bg-slate-900 hidden">

        <!-- 
          --------------------------------------
          SIDEBAR
          --------------------------------------
        -->
        <nav id="sidebar" class="bg-white dark:bg-slate-800 border-r border-slate-200 dark:border-slate-700 flex flex-col shrink-0 overflow-hidden fixed top-0 left-0 h-full">
            <!-- Sidebar Header -->
            <div class="h-16 flex items-center px-6 border-b border-slate-200 dark:border-slate-700 shrink-0">
                <div class="bg-sky-600 p-2.5 rounded-lg text-white">
                    <i data-lucide="book-open" class="w-6 h-6"></i>
                </div>
                <span id="sidebar-logo-text" class="sidebar-logo-text text-xl font-bold ml-3 text-slate-900 dark:text-white">StudyHelper</span>
            </div>

            <!-- Navigation Links -->
            <div class="flex-grow overflow-y-auto py-6 px-4 space-y-2">
                <a href="#" class="sidebar-link group relative flex items-center space-x-3 px-3 py-2.5 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700" data-page="page-home">
                    <i data-lucide="home" class="w-5 h-5"></i>
                    <span class="sidebar-text font-medium">Home</span>
                    <span class="sidebar-tooltip absolute left-14 p-2 px-3 rounded-md shadow-lg bg-slate-900 text-white text-xs font-medium opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap hidden z-10">
                        Home
                    </span>
                </a>
                <a href="#" class="sidebar-link group relative flex items-center space-x-3 px-3 py-2.5 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700" data-page="page-manage-bank">
                    <i data-lucide="database" class="w-5 h-5"></i>
                    <span class="sidebar-text font-medium">Manage Bank</span>
                    <span class="sidebar-tooltip absolute left-14 p-2 px-3 rounded-md shadow-lg bg-slate-900 text-white text-xs font-medium opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap hidden z-10">
                        Manage Bank
                    </span>
                </a>
                <a href="#" class="sidebar-link group relative flex items-center space-x-3 px-3 py-2.5 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700" data-page="page-take-quiz">
                    <i data-lucide="edit-3" class="w-5 h-5"></i>
                    <span class="sidebar-text font-medium">Take Quiz</span>
                    <span class="sidebar-tooltip absolute left-14 p-2 px-3 rounded-md shadow-lg bg-slate-900 text-white text-xs font-medium opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap hidden z-10">
                        Take Quiz
                    </span>
                </a>
                <a href="#" class="sidebar-link group relative flex items-center space-x-3 px-3 py-2.5 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700" data-page="page-quiz-history">
                    <i data-lucide="history" class="w-5 h-5"></i>
                    <span class="sidebar-text font-medium">Quiz History</span>
                    <span class="sidebar-tooltip absolute left-14 p-2 px-3 rounded-md shadow-lg bg-slate-900 text-white text-xs font-medium opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap hidden z-10">
                        Quiz History
                    </span>
                </a>
                <a href="#" class="sidebar-link group relative flex items-center space-x-3 px-3 py-2.5 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700" data-page="page-settings">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                    <span class="sidebar-text font-medium">Settings & Data</span>
                    <span class="sidebar-tooltip absolute left-14 p-2 px-3 rounded-md shadow-lg bg-slate-900 text-white text-xs font-medium opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap hidden z-10">
                        Settings & Data
                    </span>
                </a>
            </div>

            <!-- Sidebar Footer -->
            <div class="p-4 border-t border-slate-200 dark:border-slate-700 shrink-0">
                <!-- Dark Mode Toggle -->
                <button id="dark-mode-toggle" class="w-full flex items-center justify-between px-3 py-2.5 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700">
                    <span class="font-medium flex items-center space-x-3">
                        <i data-lucide="moon" class="w-5 h-5 hidden dark:inline"></i>
                        <i data-lucide="sun" class="w-5 h-5 inline dark:hidden"></i>
                        <span class="sidebar-text">Toggle Theme</span>
                    </span>
                    <!-- Toggle Switch -->
                    <div class="relative inline-flex items-center cursor-pointer sidebar-text">
                        <span class="w-11 h-6 bg-slate-200 dark:bg-slate-600 rounded-full"></span>
                        <span id="dark-mode-switch" class="absolute left-1 top-1 w-4 h-4 bg-white dark:bg-slate-300 rounded-full transition-transform dark:translate-x-5"></span>
                    </div>
                </button>
                <div class="sidebar-footer-text mt-4 text-xs text-center text-slate-400 dark:text-slate-500">
                    <p>User ID: <span id="user-id-display">Not logged in</span></p>
                </div>
            </div>
        </nav>

        <!-- 
          --------------------------------------
          MAIN CONTENT AREA
          --------------------------------------
        -->
        <main id="main-content" class="flex-1 flex flex-col overflow-hidden">
            <!-- Main Content Header -->
            <header class="h-16 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between px-6 shrink-0">
                <div class="flex items-center space-x-3">
                    <button id="sidebar-toggle-btn" class="p-2 rounded-md text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700">
                        <i data-lucide="panel-left-close" class="w-6 h-6"></i>
                    </button>
                    <h1 id="page-title" class="text-2xl font-bold text-slate-900 dark:text-white">Home</h1>
                </div>
                
                <!-- Header Auth Area -->
                <div class="relative">
                    <button id="login-button-header" class="bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center space-x-2 transition duration-150 ease-in-out">
                        <i data-lucide="log-in" class="w-5 h-5"></i>
                        <span>Login / Sign Up</span>
                    </button>
                    
                    <button id="account-button-header" class="hidden w-10 h-10 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center hover:ring-2 hover:ring-sky-500 hover:ring-offset-2 dark:hover:ring-offset-slate-800">
                        <img id="user-avatar" class="w-full h-full rounded-full object-cover" src="https://placehold.co/40x40/e2e8f0/64748b?text=U" alt="User Avatar">
                    </button>

                    <!-- Account Details Dropdown/Modal -->
                    <div id="account-modal" class="modal-content hidden absolute top-14 right-0 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700 z-50 p-4">
                        <p class="text-sm font-medium text-slate-900 dark:text-white truncate">Welcome!</p>
                        <p id="account-modal-email" class="text-sm text-slate-500 dark:text-slate-400 truncate mb-4">...</p>
                        <button id="logout-button" class="w-full flex items-center justify-center space-x-2 bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 font-semibold py-2.5 px-4 rounded-lg">
                            <i data-lucide="log-out" class="w-5 h-5"></i>
                            <span>Sign Out</span>
                        </button>
                    </div>
                </div>
            </header>

            <!-- 
              --------------------------------------
              CONTENT PAGES WRAPPER
              --------------------------------------
            -->
            <div class="flex-1 overflow-y-auto p-6 md:p-8 space-y-6">

                <!-- 
                  ================ PAGE: HOME (DASHBOARD) ================
                -->
                <div id="page-home" class="page-content space-y-6">
                    <!-- Welcome Message -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow">
                        <h2 class="text-2xl font-bold">Welcome back, <span id="welcome-user-name">User</span>!</h2>
                        <p class="text-slate-500 dark:text-slate-400 mt-1">You're doing great! Keep up the momentum.</p>
                    </div>

                    <!-- Main Dashboard Cards -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        
                        <!-- Card: Quick Start -->
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow flex flex-col">
                            <div class="flex items-center space-x-3">
                                <div class="p-3 rounded-lg bg-sky-100 dark:bg-sky-900">
                                    <i data-lucide="play-circle" class="w-6 h-6 text-sky-600 dark:text-sky-300"></i>
                                </div>
                                <h3 class="text-xl font-semibold">Quick Start</h3>
                            </div>
                            <p class="text-slate-500 dark:text-slate-400 mt-4 mb-5 flex-grow">Jump right into your next quiz. Pick a subject and get started.</p>
                            <button data-page="page-take-quiz" class="nav-button w-full bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2.5 px-4 rounded-lg">
                                Take a Quiz
                            </button>
                        </div>

                        <!-- Card: Question Bank -->
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow flex flex-col">
                            <div class="flex items-center space-x-3">
                                <div class="p-3 rounded-lg bg-emerald-100 dark:bg-emerald-900">
                                    <i data-lucide="database" class="w-6 h-6 text-emerald-600 dark:text-emerald-300"></i>
                                </div>
                                <h3 class="text-xl font-semibold">Question Bank</h3>
                            </div>
                            <p class="text-slate-500 dark:text-slate-400 mt-4 mb-5 flex-grow">Manage your subjects and questions. Add new topics or edit existing ones.</p>
                            <div class="flex items-baseline space-x-2">
                                <span id="db-question-count" class="text-4xl font-bold">0</span>
                                <span class="text-slate-500 dark:text-slate-400">Questions</span>
                            </div>
                            <div class="flex items-baseline space-x-2 mt-1">
                                <span id="db-subject-count" class="text-4xl font-bold">0</span>
                                <span class="text-slate-500 dark:text-slate-400">Subjects</span>
                            </div>
                            <button data-page="page-manage-bank" class="nav-button w-full mt-5 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2.5 px-4 rounded-lg">
                                Manage Bank
                            </button>
                        </div>

                        <!-- Card: Your Progress -->
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow flex flex-col">
                            <div class="flex items-center space-x-3">
                                <div class="p-3 rounded-lg bg-indigo-100 dark:bg-indigo-900">
                                    <i data-lucide="trending-up" class="w-6 h-6 text-indigo-600 dark:text-indigo-300"></i>
                                </div>
                                <h3 class="text-xl font-semibold">Your Progress</h3>
                            </div>
                            <p class="text-slate-500 dark:text-slate-400 mt-4 mb-5 flex-grow">Review your quiz history and track your improvement over time.</p>
                            <div class="space-y-3">
                                <div>
                                    <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Average Score</p>
                                    <p id="db-avg-score" class="text-2xl font-bold">N/A</p>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Quizzes Taken</p>
                                    <p id="db-quizzes-taken" class="text-2xl font-bold">0</p>
                                </div>
                            </div>
                            <button data-page="page-quiz-history" class="nav-button w-full mt-5 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2.5 px-4 rounded-lg">
                                View History
                            </button>
                        </div>

                    </div>
                </div>

                <!-- 
                  ================ PAGE: MANAGE BANK ================
                -->
                <div id="page-manage-bank" class="page-content hidden space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold">Manage Question Bank</h2>
                        <button id="add-new-subject-btn" class="bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center space-x-2">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                            <span>New Subject</span>
                        </button>
                    </div>

                    <!-- Subject Cards Grid -->
                    <div id="subject-card-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        <!-- Subject cards will be dynamically inserted here -->
                        <p id="no-subjects-msg" class="text-slate-500 dark:text-slate-400 md:col-span-2 lg:col-span-3">
                            You haven't added any subjects yet. Click "New Subject" to get started.
                        </p>
                    </div>
                </div>

                <!-- 
                  ================ PAGE: TAKE QUIZ (NEW UI) ================
                -->
                <div id="page-take-quiz" class="page-content hidden">
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow max-w-lg mx-auto">
                        <h2 class="text-2xl font-bold mb-6">Quiz Setup</h2>
                        
                        <form id="quiz-setup-form" class="space-y-4">
                            <div>
                                <label for="quiz-setup-subject" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Select Subject</label>
                                <select id="quiz-setup-subject" required class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-sky-500">
                                    <option value="">Select a subject...</option>
                                    <!-- Subject options -->
                                </select>
                            </div>

                            <div>
                                <label for="quiz-setup-num-questions" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
                                    Number of Questions <span id="quiz-setup-max-questions" class="text-xs text-slate-500">(Max: 0)</span>
                                </label>
                                <input type="number" id="quiz-setup-num-questions" min="1" max="0" required class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-sky-500">
                            </div>
                            
                            <div>
                                <label for="quiz-setup-time-per-question" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
                                    Time per Question (seconds)
                                    <span class="text-xs text-slate-500">(0 for no limit)</span>
                                </label>
                                <input type="number" id="quiz-setup-time-per-question" min="0" value="0" required class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-sky-500">
                            </div>

                            <div class="flex items-center justify-between">
                                <label for="quiz-setup-show-timer" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Show Timer during Quiz?</label>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="quiz-setup-show-timer" class="sr-only peer">
                                    <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-sky-300 dark:peer-focus:ring-sky-800 rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-slate-600 peer-checked:bg-sky-600"></div>
                                </label>
                            </div>

                            <p id="quiz-setup-error" class="text-sm text-red-500 hidden"></p>

                            <button type="submit" id="quiz-setup-start-button" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2.5 px-4 rounded-lg flex items-center justify-center space-x-2">
                                <i data-lucide="play" class="w-5 h-5"></i>
                                <span>Start Quiz</span>
                            </button>
                        </form>
                    </div>
                </div>

                <!-- 
                  ================ PAGE: QUIZ ACTIVE (NEW UI) ================
                -->
                <div id="page-quiz-active" class="page-content hidden">
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow max-w-3xl mx-auto relative">
                        <!-- Quit Button -->
                        <button id="quiz-exit-button-icon" class="absolute top-4 right-4 text-slate-400 hover:text-red-500 dark:hover:text-red-400">
                            <i data-lucide="x-circle" class="w-6 h-6"></i>
                        </button>
                        
                        <!-- Timer Display -->
                        <div id="quiz-timer-display" class="hidden absolute top-4 left-6 text-lg font-semibold text-slate-700 dark:text-slate-300">
                            <i data-lucide="clock" class="w-5 h-5 inline-block -mt-1 mr-1"></i>
                            <span id="quiz-timer-time">00:00</span>
                        </div>

                        <!-- Quiz Header -->
                        <div class="flex justify-between items-center mb-4 pt-8">
                            <h2 id="quiz-active-title" class="text-2xl font-bold">HTML Quiz</h2>
                            <span id="quiz-progress-text" class="text-lg font-semibold text-sky-600 dark:text-sky-300">Question 1 / 10</span>
                        </div>
                        
                        <!-- Progress Bar -->
                        <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2.5 mb-6">
                            <div id="quiz-progress-bar" class="bg-sky-600 h-2.5 rounded-full" style="width: 10%"></div>
                        </div>

                        <!-- Question -->
                        <div class="mb-6">
                            <p id="quiz-active-question" class="text-xl font-medium mb-6 min-h-[50px]">What does HTML stand for?</p>
                            <div id="quiz-options-container" class="space-y-3">
                                <!-- Options will be dynamically inserted here -->
                            </div>
                        </div>

                        <!-- Navigation -->
                        <div class="flex justify-end items-center min-h-[44px]">
                            <button id="quiz-next-button" class="hidden bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2.5 px-5 rounded-lg">
                                Next
                            </button>
                            <button id="quiz-submit-button" class="hidden bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2.5 px-5 rounded-lg">
                                Submit Quiz
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 
                  ================ PAGE: QUIZ RESULTS (NEW UI) ================
                -->
                <div id="page-quiz-results" class="page-content hidden">
                    <div class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow max-w-2xl mx-auto text-center">
                        <i data-lucide="check-circle" class="w-20 h-20 text-emerald-500 mx-auto"></i>
                        <h2 class="text-4xl font-bold mt-4">Quiz Complete!</h2>
                        <p id="results-subject-name" class="text-lg text-slate-500 dark:text-slate-400 mt-1">HTML Quiz</p>

                        <div class="my-8">
                            <p class="text-lg text-slate-600 dark:text-slate-300">Your Score:</p>
                            <p id="results-score-text" class="text-7xl font-bold text-sky-600 dark:text-sky-300 my-2">80%</p>
                            <p id="results-score-details" class="text-lg text-slate-600 dark:text-slate-300">You answered 8 out of 10 questions correctly.</p>
                        </div>

                        <div class="flex items-center justify-center space-x-4">
                            <button data-page="page-home" class="nav-button bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 font-semibold py-2.5 px-6 rounded-lg">
                                Go to Home
                            </button>
                            <button id="quiz-review-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2.5 px-6 rounded-lg">
                                Review Answers
                            </button>
                        </div>
                    </div>
                    
                    <!-- Answer Review Section -->
                    <div id="quiz-review-section" class="hidden bg-white dark:bg-slate-800 p-8 rounded-2xl shadow max-w-3xl mx-auto mt-6">
                        <h3 class="text-2xl font-bold mb-6 text-center">Answer Review</h3>
                        <div id="quiz-review-container" class="space-y-6">
                            <!-- Review content will be dynamically inserted here -->
                        </div>
                    </div>
                </div>

                <!-- 
                  ================ PAGE: QUIZ HISTORY ================
                -->
                <div id="page-quiz-history" class="page-content hidden">
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow">
                        <h2 class="text-2xl font-bold mb-4">Quiz History</h2>
                        <div class="overflow-x-auto">
                            <table class="w-full min-w-[600px] text-left">
                                <thead class="border-b border-slate-200 dark:border-slate-700">
                                    <tr>
                                        <th class="p-3 text-sm font-semibold text-slate-500 dark:text-slate-400">Subject</th>
                                        <th class="p-3 text-sm font-semibold text-slate-500 dark:text-slate-400">Date</th>
                                        <th class="p-3 text-sm font-semibold text-slate-500 dark:text-slate-400">Score</th>
                                        <th class="p-3 text-sm font-semibold text-slate-500 dark:text-slate-400">Correct</th>
                                        <th class="p-3 text-sm font-semibold text-slate-500 dark:text-slate-400">Total</th>
                                    </tr>
                                </thead>
                                <tbody id="quiz-history-table-body">
                                    <!-- History rows will be inserted here -->
                                    <tr id="no-history-msg">
                                        <td colspan="5" class="p-4 text-center text-slate-500 dark:text-slate-400">You haven't completed any quizzes yet.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 
                  ================ PAGE: SETTINGS & DATA ================
                -->
                <div id="page-settings" class="page-content hidden space-y-6">
                    <h2 class="text-2xl font-bold">Settings & Data</h2>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Import Card -->
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow space-y-6">
                            <h3 class="text-xl font-bold">Import Data</h3>
                            
                            <!-- Import Subject -->
                            <form id="import-subject-form" class="space-y-3">
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Import Subject (.json)</label>
                                <select id="import-subject-select" required class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-sky-500">
                                    <option value="">Select subject to import into...</option>
                                    <!-- Subject options -->
                                </select>
                                <input type="file" id="import-subject-file" accept=".json" required class="block w-full text-sm text-slate-500 dark:text-slate-400
                                    file:mr-4 file:py-2 file:px-4
                                    file:rounded-lg file:border-0
                                    file:text-sm file:font-semibold
                                    file:bg-sky-50 dark:file:bg-sky-900
                                    file:text-sky-700 dark:file:text-sky-300
                                    hover:file:bg-sky-100 dark:hover:file:bg-sky-800">
                                <button type="submit" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2.5 px-4 rounded-lg">
                                    Import Subject
                                </button>
                            </form>

                            <div class="border-t border-slate-200 dark:border-slate-700"></div>

                            <!-- Import Full Backup -->
                            <form id="import-full-form" class="space-y-3">
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Import Full Backup (.json)</label>
                                <input type="file" id="import-full-file" accept=".json" required class="block w-full text-sm text-slate-500 dark:text-slate-400
                                    file:mr-4 file:py-2 file:px-4
                                    file:rounded-lg file:border-0
                                    file:text-sm file:font-semibold
                                    file:bg-sky-50 dark:file:bg-sky-900
                                    file:text-sky-700 dark:file:text-sky-300
                                    hover:file:bg-sky-100 dark:hover:file:bg-sky-800">
                                <button type="submit" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2.5 px-4 rounded-lg">
                                    Import Full Backup
                                </button>
                            </form>
                            <p id="import-status" class="text-sm text-slate-500 text-center"></p>
                        </div>
                        
                        <!-- Export Card -->
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow space-y-6">
                            <h3 class="text-xl font-bold">Export Data</h3>

                            <!-- Export Subject -->
                            <div class="space-y-3">
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Export Subject as .json</label>
                                <select id="export-subject-select" class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-sky-500">
                                    <option value="">Select subject to export...</option>
                                    <!-- Subject options -->
                                </select>
                                <button id="export-subject-button" class="w-full bg-slate-600 hover:bg-slate-700 text-white font-semibold py-2.5 px-4 rounded-lg">
                                    Export Subject
                                </button>
                            </div>
                            
                            <div class="border-t border-slate-200 dark:border-slate-700"></div>
                            
                            <!-- Export Full Backup -->
                            <div class="space-y-3">
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Export Full Backup</label>
                                <button id="export-full-button" class="w-full bg-slate-600 hover:bg-slate-700 text-white font-semibold py-2.5 px-4 rounded-lg">
                                    Export All Data as .json
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Danger Zone -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow border-2 border-red-300 dark:border-red-700">
                        <h2 class="text-xl font-bold mb-2 text-red-700 dark:text-red-300">Danger Zone</h2>
                        <p class="text-slate-500 dark:text-slate-400 mb-4">These actions are permanent and cannot be undone. Be careful!</p>
                        
                        <button id="delete-all-data-button" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2.5 px-5 rounded-lg flex items-center space-x-2">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                            <span>Delete All My Data</span>
                        </button>
                    </div>
                </div>

            </div> <!-- /End Content Pages Wrapper -->
        </main> <!-- /End Main Content Area -->
    </div> <!-- /End App Shell -->

    
    <!-- 
      ================================================================
      MODALS & TOAST (Moved outside app-shell to ensure centering)
      ================================================================
    -->

    <!-- --- Universal Modal Backdrop --- -->
    <div id="modal-backdrop" class="modal-backdrop fixed inset-0 bg-black/60 z-40 hidden opacity-0 items-center justify-center p-4" data-closable="true">
        
        <!-- AUTH MODAL -->
        <div id="auth-modal" class="modal-content hidden bg-white dark:bg-slate-800 rounded-2xl shadow-xl w-full max-w-md p-8">
            <div class="flex flex-col items-center mb-6">
                <div class="bg-sky-600 p-3 rounded-full text-white">
                    <i data-lucide="book-open" class="w-8 h-8"></i>
                </div>
                <h1 class="text-3xl font-bold text-slate-900 dark:text-white mt-4">StudyHelper</h1>
                <p id="auth-form-title" class="text-slate-500 dark:text-slate-400 mt-1">Sign in to your account</p>
            </div>
            <div id="auth-error" class="hidden bg-red-100 dark:bg-red-900 border border-red-300 dark:border-red-700 text-red-700 dark:text-red-200 px-4 py-3 rounded-lg relative mb-4 text-sm" role="alert"></div>
            <form id="auth-form" class="space-y-4">
                <div class="space-y-2">
                    <label for="email" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Email address</label>
                    <input type="email" id="email" name="email" required autocomplete="email" class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-transparent">
                </div>
                <div class="space-y-2">
                    <label for="password" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Password</label>
                    <input type="password" id="password" name="password" required autocomplete="current-password" class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-transparent">
                </div>
                <div id="login-buttons" class="pt-2 space-y-3">
                    <button type="submit" id="login-button" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2.5 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2 dark:focus:ring-offset-slate-800 transition duration-150 ease-in-out">
                        Sign In
                    </button>
                    <button type="button" id="toggle-to-signup" class="w-full bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 font-semibold py-2.5 px-4 rounded-lg">
                        Don't have an account? Sign Up
                    </button>
                </div>
                <div id="signup-buttons" class="pt-2 space-y-3 hidden">
                    <button type="submit" id="signup-button" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2.5 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2 dark:focus:ring-offset-slate-800 transition duration-150 ease-in-out">
                        Create Account
                    </button>
                    <button type="button" id="toggle-to-login" class="w-full bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 font-semibold py-2.5 px-4 rounded-lg">
                        Already have an account? Sign In
                    </button>
                </div>
            </form>
            <div class="flex items-center justify-center my-6">
                <div class="flex-grow border-t border-slate-300 dark:border-slate-600"></div><span class="mx-4 text-sm font-medium text-slate-500 dark:text-slate-400">OR</span><div class="flex-grow border-t border-slate-300 dark:border-slate-600"></div>
            </div>
            <button id="google-signin-button" class="w-full bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 hover:bg-slate-50 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 font-semibold py-2.5 px-4 rounded-lg flex items-center justify-center space-x-2">
                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"/><path fill="#FF3D00" d="m6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"/><path fill="#4CAF50" d="m24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.202 0-9.619-3.317-11.283-7.946l-6.522 5.025C9.505 39.556 16.227 44 24 44z"/><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-0.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C42.012 34.569 44 29.865 44 24c0-1.341-.138-2.65-.389-3.917z"/></svg>
                <span>Sign in with Google</span>
            </button>
        </div>

        <!-- CONFIRM MODAL -->
        <div id="confirm-modal" class="modal-content hidden bg-white dark:bg-slate-800 rounded-2xl shadow-xl w-full max-w-md p-6">
            <h3 id="confirm-modal-title" class="text-xl font-bold mb-2">Are you sure?</h3>
            <p id="confirm-modal-message" class="text-slate-600 dark:text-slate-300 mb-6">This action cannot be undone.</p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel-button" class="bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 font-semibold py-2 px-4 rounded-lg">
                    Cancel
                </button>
                <button id="modal-confirm-button" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg">
                    Confirm
                </button>
            </div>
        </div>

        <!-- SUBJECT MODAL -->
        <div id="subject-modal" class="modal-content hidden bg-white dark:bg-slate-800 rounded-2xl shadow-xl w-full max-w-md p-6">
            <form id="subject-form">
                <h3 id="subject-modal-title" class="text-xl font-bold mb-4">Add New Subject</h3>
                <input type="hidden" id="subject-id-input">
                <div class="space-y-2">
                    <label for="subject-name-input" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Subject Name</label>
                    <input type="text" id="subject-name-input" placeholder="e.g., Mathematics" required class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-sky-500">
                </div>
                <p id="subject-form-error" class="text-sm text-red-500 mt-2 hidden"></p>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" class="modal-close-button bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 font-semibold py-2 px-4 rounded-lg">
                        Cancel
                    </button>
                    <button type="submit" class="bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2 px-4 rounded-lg">
                        Save Subject
                    </button>
                </div>
            </form>
        </div>

        <!-- MANAGE QUESTIONS MODAL -->
        <div id="manage-questions-modal" class="modal-content hidden bg-white dark:bg-slate-800 rounded-2xl shadow-xl w-full max-w-2xl p-6 flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-4 shrink-0">
                <h3 id="manage-q-modal-title" class="text-xl font-bold">Manage Questions</h3>
                <button type="button" class="modal-close-button text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="flex justify-between items-center mb-4 shrink-0">
                <button id="edit-subject-name-btn" class="bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 font-semibold py-2 px-4 rounded-lg flex items-center space-x-2">
                    <i data-lucide="edit-2" class="w-4 h-4"></i>
                    <span>Edit Subject</span>
                </button>
                <button id="add-new-question-btn" class="bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center space-x-2">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                    <span>Add New Question</span>
                </button>
            </div>
            <div id="question-list-container" class="flex-grow overflow-y-auto space-y-3 pr-2">
                <p id="no-questions-msg" class="text-slate-500 dark:text-slate-400">No questions added yet for this subject.</p>
            </div>
        </div>
        
        <!-- QUESTION MODAL -->
        <div id="question-modal" class="modal-content hidden bg-white dark:bg-slate-800 rounded-2xl shadow-xl w-full max-w-2xl p-6">
            <form id="question-form" class="space-y-4">
                <h3 id="question-modal-title" class="text-xl font-bold mb-4">Add New Question</h3>
                <input type="hidden" id="question-id-input">
                <input type="hidden" id="question-subject-id-input">
                
                <div>
                    <label for="question-text" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Question</label>
                    <textarea id="question-text" rows="2" required class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="What does HTML stand for?"></textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="option-0" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Option 1 (Correct Answer)</label>
                        <input type="text" id="option-0" required class="question-option w-full px-4 py-2 border border-emerald-400 dark:border-emerald-600 rounded-lg bg-emerald-50 dark:bg-emerald-900 focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="Correct Answer">
                    </div>
                    <div>
                        <label for="option-1" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Option 2</label>
                        <input type="text" id="option-1" required class="question-option w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="Wrong Answer 1">
                    </div>
                    <div>
                        <label for="option-2" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Option 3</label>
                        <input type="text" id="option-2" required class="question-option w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="Wrong Answer 2">
                    </div>
                    <div>
                        <label for="option-3" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Option 4</label>
                        <input type="text" id="option-3" required class="question-option w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="Wrong Answer 3">
                    </div>
                </div>
                <p id="question-form-error" class="text-sm text-red-500 hidden"></p>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" class="modal-close-button bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 font-semibold py-2 px-4 rounded-lg">
                        Cancel
                    </button>
                    <button type="submit" class="bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2 px-4 rounded-lg">
                        Save Question
                    </button>
                </div>
            </form>
        </div>

    </div> <!-- /End Modal Backdrop -->

    <!-- TOAST NOTIFICATION -->
    <div id="toast-notification" class="w-full max-w-xs p-4 rounded-lg shadow-lg" role="alert">
        <div class="flex items-center">
            <i id="toast-icon" data-lucide="check-circle" class="w-5 h-5"></i>
            <span id="toast-message" class="ml-3 text-sm font-medium">Item saved successfully.</span>
        </div>
    </div>


    <!-- 
      ================================================================
      JAVASCRIPT
      ================================================================
    -->
    <script type="module">
        // 
        // =================================================================
        // === FIREBASE & APP INITIALIZATION ===============================
        // =================================================================
        // 
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signInWithPopup,
            GoogleAuthProvider,
            signOut,
            updateProfile,
            signInAnonymously,
            signInWithCustomToken
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            addDoc,
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query,
            writeBatch,
            getDocs,
            Timestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- USER'S FIREBASE CONFIG ---
        const firebaseConfig = {
          apiKey: "AIzaSyDXZZVwU6Q8l5GtK8ngxfIkQLEVkbihNhM",
          authDomain: "studyhelper-quizzes.firebaseapp.com",
          projectId: "studyhelper-quizzes",
          storageBucket: "studyhelper-quizzes.firebasestorage.app",
          messagingSenderId: "217416839389",
          appId: "1:217416839389:web:060ca955eaa8befce12b34",
          measurementId: "G-4XVEYVNL7L"
        };
        // -----------------------------
        
        let app, auth, db;
        try {
            const config = typeof __firebase_config !== 'undefined' 
                ? JSON.parse(__firebase_config) 
                : firebaseConfig;

            app = initializeApp(config);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log("Firebase initialized successfully.");
        } catch (error) {
            console.error("Error initializing Firebase:", error);
            document.getElementById('app-loader').innerHTML = '<p class="text-red-500 p-4">Error: Firebase config is missing or invalid. Please check `index.html`.</p>';
            throw new Error("Firebase initialization failed.");
        }
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'studyhelper-quizzes'; 
        let currentUserId = null;
        let currentAuthUser = null;
        let currentEditingSubject = null; 
        let toastTimeout;
        let quizTimerInterval;

        const appState = {
            subjects: [],
            questions: [],
            quizHistory: [],
            activeQuiz: null, // { subjectId, subjectName, questions, currentIndex, userAnswers, score, timePerQuestion, showTimer, currentQuestionStartTime, savedQuizData }
            isAuthReady: false,
            isSidebarOpen: true
        };

        let unsubSubjects = () => {};
        let unsubQuestions = () => {};
        let unsubHistory = () => {};

        // 
        // =================================================================
        // === DOM ELEMENT SELECTORS =======================================
        // =================================================================
        // 
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        const appLoader = $('#app-loader');
        const appShell = $('#app-shell');
        const sidebar = $('#sidebar');
        const mainContent = $('#main-content');
        const sidebarToggleBtn = $('#sidebar-toggle-btn');
        const pageTitle = $('#page-title');
        const contentPages = $$('.page-content');
        const userIdDisplay = $('#user-id-display');

        // Header Auth
        const loginButtonHeader = $('#login-button-header');
        const accountButtonHeader = $('#account-button-header');
        const userAvatar = $('#user-avatar');
        const accountModal = $('#account-modal');
        const accountModalEmail = $('#account-modal-email');
        const logoutButton = $('#logout-button');

        // Auth Modal
        const authModal = $('#auth-modal');
        const authForm = $('#auth-form');
        const authFormTitle = $('#auth-form-title');
        const authError = $('#auth-error');
        const emailInput = $('#email');
        const passwordInput = $('#password');
        const loginButtons = $('#login-buttons');
        const signupButtons = $('#signup-buttons');
        const googleSigninButton = $('#google-signin-button');

        // Modals
        const modalBackdrop = $('#modal-backdrop');
        const allModals = $$('.modal-content');
        const confirmModal = $('#confirm-modal');
        const confirmModalTitle = $('#confirm-modal-title');
        const confirmModalMessage = $('#confirm-modal-message');
        const modalCancelBtn = $('#modal-cancel-button');
        const modalConfirmBtn = $('#modal-confirm-button');
        let modalConfirmCallback = null;

        // Subject Modal
        const subjectModal = $('#subject-modal');
        const subjectForm = $('#subject-form');
        const subjectModalTitle = $('#subject-modal-title');
        const subjectIdInput = $('#subject-id-input');
        const subjectNameInput = $('#subject-name-input');
        const subjectFormError = $('#subject-form-error');

        // Manage Questions Modal
        const manageQuestionsModal = $('#manage-questions-modal');
        const manageQModalTitle = $('#manage-q-modal-title');
        const editSubjectNameBtn = $('#edit-subject-name-btn');
        const addNewQuestionBtn = $('#add-new-question-btn');
        const questionListContainer = $('#question-list-container');
        const noQuestionsMsg = $('#no-questions-msg');
        
        // Question Modal
        const questionModal = $('#question-modal');
        const questionForm = $('#question-form');
        const questionModalTitle = $('#question-modal-title');
        const questionIdInput = $('#question-id-input');
        const questionSubjectIdInput = $('#question-subject-id-input');
        const questionTextInput = $('#question-text');
        const questionOptions = $$('.question-option');
        const questionFormError = $('#question-form-error');

        // Manage Bank Page
        const subjectCardGrid = $('#subject-card-grid');
        const noSubjectsMsg = $('#no-subjects-msg');

        // Dashboard
        const welcomeUserName = $('#welcome-user-name');
        const dbQuestionCount = $('#db-question-count');
        const dbSubjectCount = $('#db-subject-count');
        const dbAvgScore = $('#db-avg-score');
        const dbQuizzesTaken = $('#db-quizzes-taken');

        // Take Quiz Page
        const quizSetupForm = $('#quiz-setup-form');
        const quizSetupSubject = $('#quiz-setup-subject');
        const quizSetupMaxQuestions = $('#quiz-setup-max-questions');
        const quizSetupNumQuestions = $('#quiz-setup-num-questions');
        const quizSetupTimePerQuestion = $('#quiz-setup-time-per-question');
        const quizSetupShowTimer = $('#quiz-setup-show-timer');
        const quizSetupError = $('#quiz-setup-error');
        const quizSetupStartButton = $('#quiz-setup-start-button');

        // Active Quiz Page
        const quizExitButtonIcon = $('#quiz-exit-button-icon');
        const quizTimerDisplay = $('#quiz-timer-display');
        const quizTimerTime = $('#quiz-timer-time');
        const quizActiveTitle = $('#quiz-active-title');
        const quizProgressText = $('#quiz-progress-text');
        const quizProgressBar = $('#quiz-progress-bar');
        const quizActiveQuestion = $('#quiz-active-question');
        const quizOptionsContainer = $('#quiz-options-container');
        const quizNextButton = $('#quiz-next-button');
        const quizSubmitButton = $('#quiz-submit-button');

        // Results Page
        const resultsSubjectName = $('#results-subject-name');
        const resultsScoreText = $('#results-score-text');
        const resultsScoreDetails = $('#results-score-details');
        const quizReviewButton = $('#quiz-review-button');
        const quizReviewSection = $('#quiz-review-section');
        const quizReviewContainer = $('#quiz-review-container');

        // History Page
        const quizHistoryTableBody = $('#quiz-history-table-body');
        const noHistoryMsg = $('#no-history-msg');

        // Settings Page
        const importSubjectSelect = $('#import-subject-select');
        const importSubjectForm = $('#import-subject-form');
        const importFullForm = $('#import-full-form');
        const importStatus = $('#import-status');
        const exportSubjectSelect = $('#export-subject-select');
        const exportSubjectButton = $('#export-subject-button');
        const exportFullButton = $('#export-full-button');
        const deleteAllDataButton = $('#delete-all-data-button');

        // Toast
        const toast = $('#toast-notification');
        const toastIcon = $('#toast-icon');
        const toastMessage = $('#toast-message');

        // 
        // =================================================================
        // === UTILITY, MODAL & TOAST FUNCTIONS ============================
        // =================================================================
        // 

        function showToast(message, type = 'success') {
            clearTimeout(toastTimeout);
            toastMessage.textContent = message;
            
            if (type === 'success') {
                toast.className = "w-full max-w-xs p-4 rounded-lg shadow-lg bg-emerald-500 text-white";
                toastIcon.setAttribute('data-lucide', 'check-circle');
            } else {
                toast.className = "w-full max-w-xs p-4 rounded-lg shadow-lg bg-red-500 text-white";
                toastIcon.setAttribute('data-lucide', 'alert-circle');
            }
            lucide.createIcons();
            toast.classList.add('show');
            
            toastTimeout = setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function detachFirestoreListeners() {
            unsubSubjects();
            unsubQuestions();
            unsubHistory();
            console.log("Firestore listeners detached.");
        }

        function resetAppState() {
            appState.subjects = [];
            appState.questions = [];
            appState.quizHistory = [];
            appState.activeQuiz = null;
            appState.isAuthReady = false;
            console.log("App state reset.");
        }

        function clearDynamicUI() {
            subjectCardGrid.innerHTML = '';
            subjectCardGrid.append(noSubjectsMsg);
            
            quizSetupSubject.innerHTML = '<option value="">Select a subject...</option>';
            
            quizHistoryTableBody.innerHTML = '';
            quizHistoryTableBody.append(noHistoryMsg);

            importSubjectSelect.innerHTML = '<option value="">Select subject...</option>';
            exportSubjectSelect.innerHTML = '<option value="">Select subject...</option>';
            
            welcomeUserName.textContent = 'User';
            dbQuestionCount.textContent = '0';
            dbSubjectCount.textContent = '0';
            dbAvgScore.textContent = 'N/A';
            dbQuizzesTaken.textContent = '0';
            userIdDisplay.textContent = 'Not logged in';
        }

        function showModal(modalId, isClosable = true) {
            if (!modalId) {
                modalBackdrop.classList.add('opacity-0');
                allModals.forEach(m => m.classList.remove('open', 'opacity-100', 'scale-100'));
                setTimeout(() => {
                    modalBackdrop.classList.add('hidden');
                    allModals.forEach(m => m.classList.add('hidden'));
                }, 200); 
                return;
            }

            modalBackdrop.dataset.closable = isClosable;
            modalBackdrop.classList.remove('hidden');
            allModals.forEach(m => m.classList.add('hidden')); 
            
            const modalToShow = $(`#${modalId}`);
            if(modalToShow) {
                modalToShow.classList.remove('hidden');
                setTimeout(() => {
                    modalBackdrop.classList.add('open', 'opacity-100');
                    modalToShow.classList.add('open', 'opacity-100', 'scale-100');
                    lucide.createIcons(); 
                }, 10); 
            }
        }
        
        modalBackdrop.addEventListener('click', (e) => {
            if (e.target === modalBackdrop && modalBackdrop.dataset.closable === 'true') {
                showModal(null);
            }
        });
        
        $$('.modal-close-button').forEach(btn => {
            btn.addEventListener('click', () => {
                const parentModal = btn.closest('.modal-content');
                if (parentModal.id) {
                    showModal(null);
                }
            });
        });

        function showConfirmModal(title, message, onConfirm, confirmText = 'Confirm', confirmClass = 'bg-red-600') {
            confirmModalTitle.textContent = title;
            confirmModalMessage.textContent = message;
            modalConfirmBtn.textContent = confirmText;
            
            modalConfirmBtn.className = 'text-white font-semibold py-2 px-4 rounded-lg';
            modalConfirmBtn.classList.add(confirmClass); 

            modalConfirmCallback = onConfirm;
            showModal('confirm-modal', false);
        }

        modalCancelBtn.addEventListener('click', () => showModal(null));
        modalConfirmBtn.addEventListener('click', () => {
            if (typeof modalConfirmCallback === 'function') {
                modalConfirmCallback();
            }
            showModal(null);
        });

        function showPage(pageId) {
            // New safety check: if a quiz is active, confirm before navigating away
            if (appState.activeQuiz && pageId !== 'page-quiz-active') {
                showConfirmModal(
                    'Exit Quiz?',
                    'Are you sure you want to exit? Your progress for this attempt will be lost.',
                    () => {
                        abandonQuiz(); // This will clear the quiz state
                        // Now we can safely navigate
                        _navigateToPage(pageId);
                    }
                );
                return; // Stop navigation until user confirms
            }
            
            _navigateToPage(pageId);
        }

        function _navigateToPage(pageId) {
             if (!appState.isAuthReady && pageId !== 'page-home') {
                 if(currentAuthUser == null) {
                    showModal('auth-modal');
                    return;
                 }
            }

            contentPages.forEach(page => page.classList.add('hidden'));
            const newPage = $(`#${pageId}`);
            if (newPage) {
                newPage.classList.remove('hidden');

                const link = $(`[data-page="${pageId}"]`);
                if (link) {
                    // Try to find sidebar text, fallback to tooltip
                    const linkText = (link.querySelector('.sidebar-text') || link.querySelector('.sidebar-tooltip')).textContent.trim();
                    pageTitle.textContent = linkText;
                    $$('.sidebar-link').forEach(l => l.setAttribute('data-active', 'false'));
                    link.setAttribute('data-active', 'true');
                } else if (pageId === 'page-home') {
                    pageTitle.textContent = 'Home';
                    $('[data-page="page-home"]').setAttribute('data-active', 'true');
                }
            }
        }

        function showAuthError(message) {
            authError.textContent = message;
            authError.classList.remove('hidden');
        }

        function hideAuthError() {
            authError.classList.add('hidden');
            authError.textContent = '';
        }

        function formatFirebaseDate(timestamp) {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate();
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }
        
        // 
        // =================================================================
        // === AUTHENTICATION LOGIC ========================================
        // =================================================================
        // 

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("Auth state changed: User is signed in.", user.uid);
                currentAuthUser = user;
                currentUserId = user.uid;
                appState.isAuthReady = true;

                updateUserInfoUI(user);
                attachFirestoreListeners();
                
                loginButtonHeader.classList.add('hidden');
                accountButtonHeader.classList.remove('hidden');
                
                appLoader.classList.add('hidden');
                appShell.classList.remove('hidden');
                showPage('page-home'); 
                showModal(null); 

            } else {
                console.log("Auth state changed: User is signed out.");
                if (appState.activeQuiz) {
                    abandonQuiz();
                }
                currentAuthUser = null;
                currentUserId = null;
                appState.isAuthReady = true; 

                detachFirestoreListeners();
                resetAppState();
                clearDynamicUI();
                
                loginButtonHeader.classList.remove('hidden');
                accountButtonHeader.classList.add('hidden');
                
                appShell.classList.remove('hidden'); 
                appLoader.classList.add('hidden');
                showPage('page-home'); 
            }
        });

        async function initializeAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    console.log("Attempting sign in with custom token...");
                    await signInWithCustomToken(auth, __initial_auth_token);
                    console.log("Custom token sign in successful.");
                } else if (auth.currentUser) {
                    console.log("User already signed in:", auth.currentUser.uid);
                } else {
                    console.log("No user or token found. App is ready for login.");
                    appState.isAuthReady = true;
                    appShell.classList.remove('hidden');
                    appLoader.classList.add('hidden');
                    showPage('page-home');
                }
            } catch (error) {
                 console.error("Auth initialization error:", error);
                 if (typeof __initial_auth_token !== 'undefined') {
                    await signInAnonymously(auth);
                 } else {
                    appState.isAuthReady = true;
                    appShell.classList.remove('hidden');
                    appLoader.classList.add('hidden');
                    showPage('page-home');
                 }
            }
        }

        function updateUserInfoUI(user) {
            if (user) {
                const displayName = user.displayName || user.email.split('@')[0] || 'User';
                const email = user.email || 'No email provided';
                
                accountModalEmail.textContent = email;
                if (user.photoURL) {
                    userAvatar.src = user.photoURL;
                } else {
                    const initial = (displayName[0] || 'U').toUpperCase();
                    userAvatar.src = `https://placehold.co/40x40/e2e8f0/64748b?text=${initial}`;
                }
                welcomeUserName.textContent = displayName.split(' ')[0];
                userIdDisplay.textContent = user.uid;
            } else {
                accountModalEmail.textContent = '...';
                userAvatar.src = 'https://placehold.co/40x40/e2e8f0/64748b?text=U';
                welcomeUserName.textContent = 'User';
                userIdDisplay.textContent = 'Not logged in';
            }
        }

        loginButtonHeader.addEventListener('click', () => {
            setAuthFormMode('login');
            showModal('auth-modal');
        });

        accountButtonHeader.addEventListener('click', (e) => {
            e.stopPropagation(); 
            accountModal.classList.toggle('hidden');
            if(!accountModal.classList.contains('hidden')) {
                accountModal.classList.add('open', 'opacity-100', 'scale-100');
            } else {
                accountModal.classList.remove('open', 'opacity-100', 'scale-100');
            }
        });
        
        document.addEventListener('click', (e) => {
            if (!accountButtonHeader.contains(e.target) && !accountModal.contains(e.target)) {
                accountModal.classList.add('hidden');
                accountModal.classList.remove('open', 'opacity-100', 'scale-100');
            }
        });

        logoutButton.addEventListener('click', () => {
            console.log('Attempting sign out...');
            signOut(auth);
            accountModal.classList.add('hidden');
            accountModal.classList.remove('open', 'opacity-100', 'scale-100');
            showToast('You have been logged out.', 'success');
        });

        function setAuthFormMode(mode) {
            hideAuthError();
            if (mode === 'signup') {
                authFormTitle.textContent = 'Create a new account';
                loginButtons.classList.add('hidden');
                signupButtons.classList.remove('hidden');
            } else {
                authFormTitle.textContent = 'Sign in to your account';
                loginButtons.classList.remove('hidden');
                signupButtons.classList.add('hidden');
            }
        }

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideAuthError();
            
            const email = emailInput.value;
            const password = passwordInput.value;
            const isSignUp = !signupButtons.classList.contains('hidden');

            try {
                if (isSignUp) {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const defaultName = email.split('@')[0];
                    await updateProfile(userCredential.user, { displayName: defaultName });
                    showToast('Welcome! Your account has been created.', 'success');
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                    showToast('Welcome back!', 'success');
                }
            } catch (error) {
                console.error("Auth error:", error.message);
                showAuthError(error.message);
                showToast(error.message, 'error');
            }
        });

        $('#toggle-to-signup').addEventListener('click', () => setAuthFormMode('signup'));
        $('#toggle-to-login').addEventListener('click', () => setAuthFormMode('login'));

        googleSigninButton.addEventListener('click', async () => {
            hideAuthError();
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
                showToast('Signed in with Google!', 'success');
            } catch (error) {
                console.error("Google Sign-In error:", error.message);
                showAuthError(error.message);
                showToast(error.message, 'error');
            }
        });

        // 
        // =================================================================
        // === FIRESTORE PATHS & LISTENERS =================================
        // =================================================================
        // 

        const getSubjectsCol = () => collection(db, `artifacts/${appId}/users/${currentUserId}/subjects`);
        const getQuestionsCol = () => collection(db, `artifacts/${appId}/users/${currentUserId}/questions`);
        const getHistoryCol = () => collection(db, `artifacts/${appId}/users/${currentUserId}/quizHistory`);

        function attachFirestoreListeners() {
            if (!currentUserId) return;
            console.log(`Attaching Firestore listeners for user ${currentUserId}`);
            
            detachFirestoreListeners();

            const subjectsQuery = query(getSubjectsCol());
            unsubSubjects = onSnapshot(subjectsQuery, (snapshot) => {
                appState.subjects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log('Firestore update: Subjects', appState.subjects);
                renderSubjectCards();
                renderQuizSetupDropdown();
                renderDashboardStats();
                renderSettingsDropdowns();
            }, (error) => console.error("Error listening to subjects:", error));

            const questionsQuery = query(getQuestionsCol());
            unsubQuestions = onSnapshot(questionsQuery, (snapshot) => {
                appState.questions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log('Firestore update: Questions', appState.questions);
                renderQuizSetupDropdown();
                renderDashboardStats();
                if (!manageQuestionsModal.classList.contains('hidden') && currentEditingSubject) {
                    renderQuestionListModal(currentEditingSubject.id);
                }
                renderSubjectCards();
            }, (error) => console.error("Error listening to questions:", error));

            const historyQuery = query(getHistoryCol());
            unsubHistory = onSnapshot(historyQuery, (snapshot) => {
                appState.quizHistory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                appState.quizHistory.sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis());
                console.log('Firestore update: Quiz History', appState.quizHistory);
                renderQuizHistoryTable();
                renderDashboardStats();
            }, (error) => console.error("Error listening to quiz history:", error));
        }

        // 
        // =================================================================
        // === UI RENDERING FUNCTIONS ======================================
        // =================================================================
        // 
        
        function renderSubjectCards() {
            if (!currentUserId) {
                subjectCardGrid.innerHTML = '<p class="text-slate-500 dark:text-slate-400 md:col-span-2 lg:col-span-3">Please log in to manage your question bank.</p>';
                return;
            }
            if (appState.subjects.length === 0) {
                subjectCardGrid.innerHTML = '';
                subjectCardGrid.append(noSubjectsMsg);
                return;
            }

            const questionCounts = appState.questions.reduce((acc, q) => {
                acc[q.subjectId] = (acc[q.subjectId] || 0) + 1;
                return acc;
            }, {});

            subjectCardGrid.innerHTML = appState.subjects.map(subject => {
                const count = questionCounts[subject.id] || 0;
                return `
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow p-5 flex flex-col border border-slate-200 dark:border-slate-700">
                    <h3 class="text-xl font-semibold mb-2">${subject.name}</h3>
                    <p class="text-sm text-slate-500 dark:text-slate-400 mb-4">${count} question(s)</p>
                    
                    <button class="start-quiz-btn w-full bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2.5 px-4 rounded-lg flex items-center justify-center space-x-2"
                            data-subject-id="${subject.id}" data-subject-name="${subject.name}" ${count === 0 ? 'disabled' : ''}>
                        <i data-lucide="play" class="w-5 h-5"></i>
                        <span>Start Quiz</span>
                    </button>
                    
                    <div class="flex items-center space-x-2 mt-3">
                        <button class="manage-subject-btn flex-1 bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 font-medium py-2 px-3 rounded-lg flex items-center justify-center space-x-2"
                                data-subject-id="${subject.id}" data-subject-name="${subject.name}">
                            <i data-lucide="settings-2" class="w-4 h-4"></i>
                            <span>Manage</span>
                        </button>
                        <button class="delete-subject-btn bg-red-50 hover:bg-red-100 dark:bg-red-900/50 dark:hover:bg-red-900 text-red-600 dark:text-red-400 font-medium p-2 rounded-lg"
                                data-subject-id="${subject.id}" data-subject-name="${subject.name}">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            `}).join('');
            lucide.createIcons();
        }

        /**
         * Renders the subject dropdown on the "Take Quiz" page.
         */
        function renderQuizSetupDropdown() {
            if (!currentUserId) {
                quizSetupSubject.innerHTML = '<option value="">Log in to see subjects</option>';
                return;
            }
            
            const questionCounts = appState.questions.reduce((acc, q) => {
                acc[q.subjectId] = (acc[q.subjectId] || 0) + 1;
                return acc;
            }, {});

            const availableQuizzes = appState.subjects
                .map(subject => ({
                    ...subject,
                    questionCount: questionCounts[subject.id] || 0
                }))
                .filter(subject => subject.questionCount > 0); 

            if (availableQuizzes.length === 0) {
                quizSetupSubject.innerHTML = '<option value="">No subjects with questions</option>';
                return;
            }

            quizSetupSubject.innerHTML = '<option value="">Select a subject...</option>' + 
                availableQuizzes.map(subject => `
                    <option value="${subject.id}" data-name="${subject.name}" data-max="${subject.questionCount}">
                        ${subject.name} (${subject.questionCount} questions)
                    </option>
                `).join('');
        }
        
        function renderQuestionListModal(subjectId) {
             const questionsForSubject = appState.questions.filter(q => q.subjectId === subjectId);
             
             if (questionsForSubject.length === 0) {
                questionListContainer.innerHTML = '';
                questionListContainer.append(noQuestionsMsg);
                return;
             }
             
             questionListContainer.innerHTML = questionsForSubject.map(q => `
                <div class="p-3 bg-slate-50 dark:bg-slate-700 rounded-lg">
                    <p class="font-medium text-slate-800 dark:text-slate-100">${q.question}</p>
                    <ul class="mt-2 space-y-1 text-sm list-disc list-inside">
                        ${q.options.map((opt, index) => `
                            <li class="${index === q.correctAnswerIndex ? 'text-emerald-600 dark:text-emerald-400 font-medium' : 'text-slate-600 dark:text-slate-400'}">
                                ${opt}
                            </li>
                        `).join('')}
                    </ul>
                    <div class="flex items-center space-x-2 mt-3">
                        <button class="edit-question-btn flex-1 bg-slate-200 hover:bg-slate-300 dark:bg-slate-600 dark:hover:bg-slate-500 text-sm font-medium py-1.5 px-3 rounded-md" data-question-id="${q.id}">
                            Edit
                        </button>
                        <button class="delete-question-btn flex-1 bg-red-100 hover:bg-red-200 dark:bg-red-900 dark:hover:bg-red-800 text-red-700 dark:text-red-300 text-sm font-medium py-1.5 px-3 rounded-md" data-question-id="${q.id}">
                            Delete
                        </button>
                    </div>
                </div>
             `).join('');
             lucide.createIcons();
        }

        function renderQuizHistoryTable() {
            if (!currentUserId) {
                quizHistoryTableBody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-slate-500 dark:text-slate-400">Please log in to view your history.</td></tr>';
                return;
            }
            if (appState.quizHistory.length === 0) {
                quizHistoryTableBody.innerHTML = '';
                quizHistoryTableBody.append(noHistoryMsg);
                return;
            }

            quizHistoryTableBody.innerHTML = appState.quizHistory.map(item => `
                <tr class="border-b border-slate-200 dark:border-slate-700">
                    <td class="p-3 font-medium">${item.subjectName}</td>
                    <td class="p-3 text-slate-600 dark:text-slate-400">${formatFirebaseDate(item.timestamp)}</td>
                    <td class="p-3 font-semibold ${item.score >= 70 ? 'text-emerald-600 dark:text-emerald-400' : 'text-red-600 dark:text-red-400'}">${item.score}%</td>
                    <td class="p-3 text-slate-600 dark:text-slate-400">${item.correct}</td>
                    <td class="p-3 text-slate-600 dark:text-slate-400">${item.total}</td>
                </tr>
            `).join('');
        }

        function renderDashboardStats() {
            if (!currentUserId) return; 

            dbSubjectCount.textContent = appState.subjects.length;
            dbQuestionCount.textContent = appState.questions.length;

            const history = appState.quizHistory;
            dbQuizzesTaken.textContent = history.length;

            if (history.length > 0) {
                const totalScore = history.reduce((sum, item) => sum + item.score, 0);
                const avg = Math.round(totalScore / history.length);
                dbAvgScore.textContent = `${avg}%`;
            } else {
                dbAvgScore.textContent = 'N/A';
            }
        }
        
         function renderSettingsDropdowns() {
            if (!currentUserId) {
                importSubjectSelect.innerHTML = '<option value="">Log in to import</option>';
                exportSubjectSelect.innerHTML = '<option value="">Log in to export</option>';
                return;
            }
            if (appState.subjects.length === 0) {
                importSubjectSelect.innerHTML = '<option value="">Add a subject first</option>';
                exportSubjectSelect.innerHTML = '<option value="">Add a subject first</option>';
                return;
            }
            
            const optionsHtml = appState.subjects.map(subject => 
                `<option value="${subject.id}">${subject.name}</option>`
            ).join('');
            
            importSubjectSelect.innerHTML = `<option value="">Select subject to import into...</option>${optionsHtml}`;
            exportSubjectSelect.innerHTML = `<option value="">Select subject to export...</option>${optionsHtml}`;
         }

        // 
        // =================================================================
        // === "MANAGE BANK" LOGIC =========================================
        // =================================================================
        // 
        
        function openSubjectModal(subjectId = null, subjectName = '') {
            subjectForm.reset();
            subjectFormError.classList.add('hidden');
            if (subjectId) {
                subjectModalTitle.textContent = 'Edit Subject';
                subjectIdInput.value = subjectId;
                subjectNameInput.value = subjectName;
            } else {
                subjectModalTitle.textContent = 'Add New Subject';
                subjectIdInput.value = '';
                subjectNameInput.value = '';
            }
            showModal('subject-modal');
        }
        
        $('#add-new-subject-btn').addEventListener('click', () => {
             if (!currentUserId) {
                showModal('auth-modal');
                return;
            }
            openSubjectModal();
        });

        subjectForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const subjectName = subjectNameInput.value.trim();
            const subjectId = subjectIdInput.value;
            if (!subjectName) return;

            if (appState.subjects.some(s => s.name.toLowerCase() === subjectName.toLowerCase() && s.id !== subjectId)) {
                subjectFormError.textContent = 'This subject already exists.';
                subjectFormError.classList.remove('hidden');
                return;
            }
            
            subjectFormError.classList.add('hidden');
            
            try {
                if (subjectId) {
                    const docRef = doc(getSubjectsCol(), subjectId);
                    await updateDoc(docRef, { name: subjectName });
                    showToast('Subject updated successfully!', 'success');
                } else {
                    const docRef = await addDoc(getSubjectsCol(), { name: subjectName });
                    showToast('Subject added successfully!', 'success');
                }
                showModal(null); 
                if (!manageQuestionsModal.classList.contains('hidden') && currentEditingSubject) {
                    currentEditingSubject.name = subjectName;
                    manageQModalTitle.textContent = `Manage Questions for "${subjectName}"`;
                }
            } catch (error) {
                console.error("Error saving subject:", error);
                subjectFormError.textContent = 'Error saving subject. Please try again.';
                subjectFormError.classList.remove('hidden');
                showToast('Error saving subject.', 'error');
            }
        });

        subjectCardGrid.addEventListener('click', (e) => {
            const subjectCard = e.target.closest('[data-subject-id]');
            if (!subjectCard) return;
            
            const { subjectId, subjectName } = subjectCard.dataset;

            const deleteButton = e.target.closest('.delete-subject-btn');
            if (deleteButton) {
                showConfirmModal(
                    'Delete Subject?',
                    `Are you sure you want to delete "${subjectName}"? This will also delete all associated questions. This cannot be undone.`,
                    async () => {
                        try {
                            const batch = writeBatch(db);
                            const subjectDocRef = doc(getSubjectsCol(), subjectId);
                            batch.delete(subjectDocRef);

                            const questionsToDelete = appState.questions.filter(q => q.subjectId === subjectId);
                            questionsToDelete.forEach(q => {
                                const questionDocRef = doc(getQuestionsCol(), q.id);
                                batch.delete(questionDocRef);
                            });
                            await batch.commit();
                            showToast('Subject and questions deleted.', 'success');
                        } catch (error) {
                            console.error("Error deleting subject:", error);
                            showToast('Error deleting subject.', 'error');
                        }
                    }
                );
                return;
            }
            
            const manageButton = e.target.closest('.manage-subject-btn');
            if (manageButton) {
                openManageQuestionsModal(subjectId, subjectName);
                return;
            }
            
            const startButton = e.target.closest('.start-quiz-btn');
            if (startButton && !startButton.disabled) {
                // Don't start quiz, just go to the page
                showPage('page-take-quiz');
                // Pre-select this subject in the dropdown
                quizSetupSubject.value = subjectId;
                // Manually trigger change event to update max questions
                quizSetupSubject.dispatchEvent(new Event('change'));
                return;
            }
        });
        
        // 
        // =================================================================
        // === "MANAGE QUESTIONS" MODAL LOGIC ==============================
        // =================================================================
        // 
        
        function openManageQuestionsModal(subjectId, subjectName) {
            currentEditingSubject = { id: subjectId, name: subjectName };
            manageQModalTitle.textContent = `Manage Questions for "${subjectName}"`;
            renderQuestionListModal(subjectId);
            showModal('manage-questions-modal');
        }
        
        editSubjectNameBtn.addEventListener('click', () => {
            if (currentEditingSubject) {
                openSubjectModal(currentEditingSubject.id, currentEditingSubject.name);
            }
        });
        
        addNewQuestionBtn.addEventListener('click', () => {
            if (currentEditingSubject) {
                openQuestionModal(currentEditingSubject.id);
            }
        });
        
        function openQuestionModal(subjectId, questionId = null) {
            questionForm.reset();
            questionFormError.classList.add('hidden');
            questionSubjectIdInput.value = subjectId;
            
            if (questionId) {
                questionModalTitle.textContent = 'Edit Question';
                questionIdInput.value = questionId;
                const questionData = appState.questions.find(q => q.id === questionId);
                if (questionData) {
                    questionTextInput.value = questionData.question;
                    questionOptions.forEach((input, index) => {
                        input.value = questionData.options[index] || '';
                    });
                }
            } else {
                questionModalTitle.textContent = 'Add New Question';
                questionIdInput.value = '';
            }
            showModal('question-modal', false); 
        }

        questionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            questionFormError.classList.add('hidden');

            const subjectId = questionSubjectIdInput.value;
            const questionId = questionIdInput.value;
            const question = questionTextInput.value.trim();
            const options = Array.from(questionOptions).map(input => input.value.trim());
            const correctAnswerIndex = 0; 

            if (!subjectId || !question || options.some(opt => !opt)) {
                questionFormError.textContent = 'Please fill out all fields.';
                questionFormError.classList.remove('hidden');
                return;
            }

            const questionData = {
                subjectId,
                question,
                options,
                correctAnswerIndex
            };

            try {
                if (questionId) {
                    const docRef = doc(getQuestionsCol(), questionId);
                    await updateDoc(docRef, questionData);
                    showToast('Question updated!', 'success');
                } else {
                    const docRef = await addDoc(getQuestionsCol(), questionData);
                    showToast('Question added!', 'success');
                }
                showModal('manage-questions-modal'); 
            } catch (error) {
                console.error("Error saving question:", error);
                questionFormError.textContent = 'Error saving question. Please try again.';
                questionFormError.classList.remove('hidden');
                showToast('Error saving question.', 'error');
            }
        });
        
        questionListContainer.addEventListener('click', (e) => {
            const editButton = e.target.closest('.edit-question-btn');
            if (editButton) {
                const questionId = editButton.dataset.questionId;
                openQuestionModal(currentEditingSubject.id, questionId);
                return;
            }
            
            const deleteButton = e.target.closest('.delete-question-btn');
            if (deleteButton) {
                const questionId = deleteButton.dataset.questionId;
                showConfirmModal(
                    'Delete Question?',
                    'Are you sure you want to delete this question?',
                    async () => {
                        try {
                            await deleteDoc(doc(getQuestionsCol(), questionId));
                            showToast('Question deleted.', 'success');
                        } catch (error) {
                            console.error("Error deleting question:", error);
                            showToast('Error deleting question.', 'error');
                        }
                    }
                );
                return;
            }
        });


        // 
        // =================================================================
        // === QUIZ LOGIC (NEW) ============================================
        // =================================================================
        // 

        // --- Event Listener for "Take Quiz" form ---
        quizSetupSubject.addEventListener('change', () => {
            const selectedOption = quizSetupSubject.options[quizSetupSubject.selectedIndex];
            const max = selectedOption.dataset.max || 0;
            
            quizSetupMaxQuestions.textContent = `(Max: ${max})`;
            quizSetupNumQuestions.max = max;
            if (parseInt(quizSetupNumQuestions.value) > max) {
                quizSetupNumQuestions.value = max;
            }
            if (max == 0) {
                 quizSetupNumQuestions.value = 0;
            }
        });

        quizSetupForm.addEventListener('submit', (e) => {
            e.preventDefault();
            quizSetupError.classList.add('hidden');

            const selectedOption = quizSetupSubject.options[quizSetupSubject.selectedIndex];
            const subjectId = quizSetupSubject.value;
            const subjectName = selectedOption.dataset.name;
            const maxQuestions = parseInt(selectedOption.dataset.max || 0);
            
            const numQuestions = parseInt(quizSetupNumQuestions.value);
            const timePerQuestion = parseInt(quizSetupTimePerQuestion.value) || 0;
            const showTimer = quizSetupShowTimer.checked;

            // --- Validation ---
            if (!subjectId) {
                quizSetupError.textContent = 'Please select a subject.';
                quizSetupError.classList.remove('hidden');
                return;
            }
            if (isNaN(numQuestions) || numQuestions <= 0 || numQuestions > maxQuestions) {
                quizSetupError.textContent = `Please enter a valid number of questions (1 - ${maxQuestions}).`;
                quizSetupError.classList.remove('hidden');
                return;
            }

            console.log(`Starting quiz: ${subjectName}, ${numQuestions} questions, ${timePerQuestion}s/q, timer: ${showTimer}`);
            
            // --- Quiz Setup ---
            const allQuestions = appState.questions.filter(q => q.subjectId === subjectId);
            shuffleArray(allQuestions);
            
            let quizQuestions = allQuestions.slice(0, numQuestions);
            
            // For each question, create a *deep copy* and shuffle its options
            quizQuestions = quizQuestions.map(q => {
                const newQ = JSON.parse(JSON.stringify(q)); // Deep copy
                
                const optionsWithState = newQ.options.map((optionText, index) => ({
                    text: optionText,
                    isCorrect: index === newQ.correctAnswerIndex
                }));
                shuffleArray(optionsWithState);
                
                newQ.options = optionsWithState.map(opt => opt.text);
                newQ.correctAnswerIndex = optionsWithState.findIndex(opt => opt.isCorrect);
                return newQ;
            });
            
            appState.activeQuiz = {
                subjectId,
                subjectName,
                questions: quizQuestions,
                currentIndex: 0,
                userAnswers: new Array(quizQuestions.length).fill(null), // Stores selected index
                score: 0,
                timePerQuestion: timePerQuestion,
                showTimer: showTimer,
                currentQuestionStartTime: Date.now(),
                savedQuizData: null // To store data for review
            };
            
            quizActiveTitle.textContent = `${subjectName} Quiz`;
            quizReviewSection.classList.add('hidden'); // Hide review from previous quiz
            renderActiveQuizQuestion();
            _navigateToPage('page-quiz-active'); // Use internal nav function
            
            if (showTimer && timePerQuestion > 0) {
                startQuizTimer(timePerQuestion);
            } else {
                quizTimerDisplay.classList.add('hidden');
            }
        });
        
        function startQuizTimer(seconds) {
            clearInterval(quizTimerInterval);
            let remainingTime = seconds;
            quizTimerDisplay.classList.remove('hidden');
            
            function tick() {
                quizTimerTime.textContent = formatTime(remainingTime);
                
                if (remainingTime <= 0) {
                    clearInterval(quizTimerInterval);
                    showToast('Time is up!', 'error');
                    handleQuizNext(true); // Force next, mark as timeout
                } else {
                    remainingTime--;
                }
            }
            tick(); // Run once immediately
            quizTimerInterval = setInterval(tick, 1000);
        }

        function renderActiveQuizQuestion() {
            if (!appState.activeQuiz) return;
            
            const quiz = appState.activeQuiz;
            const q = quiz.questions[quiz.currentIndex];

            quizActiveQuestion.textContent = q.question;
            
            const progress = ((quiz.currentIndex + 1) / quiz.questions.length) * 100;
            quizProgressText.textContent = `Question ${quiz.currentIndex + 1} / ${quiz.questions.length}`;
            quizProgressBar.style.width = `${progress}%`;

            quizOptionsContainer.innerHTML = q.options.map((option, index) => `
                <label class="quiz-option-label block w-full p-4 border border-slate-300 dark:border-slate-600 rounded-lg cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                    <input type="radio" name="quiz-option" value="${index}" class="hidden">
                    <span class="text-base font-medium">${option}</span>
                </label>
            `).join('');

            quizNextButton.classList.add('hidden');
            quizSubmitButton.classList.add('hidden');

            // Start timer for this question
            if (quiz.showTimer && quiz.timePerQuestion > 0) {
                startQuizTimer(quiz.timePerQuestion);
            }
        }
        
        // --- New: Event Delegation for clicking a quiz option ---
        quizOptionsContainer.addEventListener('change', (e) => {
            if (e.target.name === 'quiz-option' && appState.activeQuiz) {
                const quiz = appState.activeQuiz;
                const selectedIndex = parseInt(e.target.value);
                quiz.userAnswers[quiz.currentIndex] = selectedIndex;

                // Stop timer
                clearInterval(quizTimerInterval);

                // Show feedback
                showQuestionFeedback(selectedIndex);
                
                // Show next/submit button
                if (quiz.currentIndex === quiz.questions.length - 1) {
                    quizSubmitButton.classList.remove('hidden');
                } else {
                    quizNextButton.classList.remove('hidden');
                }
            }
        });
        
        function showQuestionFeedback(selectedIndex) {
            const quiz = appState.activeQuiz;
            const correctIndex = quiz.questions[quiz.currentIndex].correctAnswerIndex;
            
            $$('.quiz-option-label').forEach((label, index) => {
                const input = label.querySelector('input');
                input.disabled = true;
                label.classList.add('disabled');
                
                if (index === correctIndex) {
                    label.classList.add('correct');
                } else if (index === selectedIndex) {
                    label.classList.add('incorrect');
                }
            });
        }

        function handleQuizNext(isTimeout = false) {
            if (!appState.activeQuiz) return;
            const quiz = appState.activeQuiz;
            
            // If it was a timeout, and no answer was selected, mark it as null (or -1)
            if (isTimeout && quiz.userAnswers[quiz.currentIndex] === null) {
                quiz.userAnswers[quiz.currentIndex] = -1; // -1 indicates timeout
            }

            if (quiz.currentIndex === quiz.questions.length - 1) {
                finishQuiz();
            } else {
                quiz.currentIndex++;
                renderActiveQuizQuestion();
            }
        }

        async function finishQuiz() {
            if (!appState.activeQuiz) return;
            clearInterval(quizTimerInterval); // Stop any running timers
            
            const quiz = appState.activeQuiz;
            
            let correctAnswers = 0;
            quiz.questions.forEach((q, index) => {
                if (q.correctAnswerIndex === quiz.userAnswers[index]) {
                    correctAnswers++;
                }
            });

            const totalQuestions = quiz.questions.length;
            const finalScore = Math.round((correctAnswers / totalQuestions) * 100);
            quiz.score = finalScore;
            
            // Save full quiz data for review
            quiz.savedQuizData = {
                questions: quiz.questions,
                userAnswers: quiz.userAnswers
            };

            try {
                await addDoc(getHistoryCol(), {
                    subjectId: quiz.subjectId,
                    subjectName: quiz.subjectName,
                    score: finalScore,
                    correct: correctAnswers,
                    total: totalQuestions,
                    timestamp: Timestamp.now()
                });
                console.log("Quiz history saved to Firestore.");
            } catch (error) {
                console.error("Error saving quiz history:", error);
                showToast('Error saving quiz results.', 'error');
            }

            // Render results page
            resultsSubjectName.textContent = `${quiz.subjectName} Quiz`;
            resultsScoreText.textContent = `${finalScore}%`;
            resultsScoreDetails.textContent = `You answered ${correctAnswers} out of ${totalQuestions} questions correctly.`;
            
            // Attach data to review button
            quizReviewButton.dataset.quizData = JSON.stringify(quiz.savedQuizData);

            _navigateToPage('page-quiz-results');
            appState.activeQuiz = null;
        }
        
        // --- New: Review Answers Button ---
        quizReviewButton.addEventListener('click', () => {
            const data = JSON.parse(quizReviewButton.dataset.quizData);
            renderQuizReview(data.questions, data.userAnswers);
            quizReviewSection.classList.remove('hidden');
        });
        
        // --- New: Render Quiz Review ---
        function renderQuizReview(questions, userAnswers) {
            quizReviewContainer.innerHTML = questions.map((q, index) => {
                const userAnswerIndex = userAnswers[index];
                const correctIndex = q.correctAnswerIndex;
                
                const optionsHtml = q.options.map((option, i) => {
                    let classes = 'p-3 rounded-md border';
                    if (i === correctIndex) {
                        classes += ' bg-emerald-100 border-emerald-300 dark:bg-emerald-900 dark:border-emerald-700';
                    } else if (i === userAnswerIndex) {
                        classes += ' bg-red-100 border-red-300 dark:bg-red-900 dark:border-red-700';
                    } else {
                        classes += ' bg-slate-100 border-slate-200 dark:bg-slate-700 dark:border-slate-600';
                    }
                    
                    return `<li class="${classes}">${option}</li>`;
                }).join('');
                
                let answerFeedback = '';
                if (userAnswerIndex === correctIndex) {
                    answerFeedback = '<p class="text-sm font-medium text-emerald-600 dark:text-emerald-400">You answered correctly.</p>';
                } else if (userAnswerIndex === -1) {
                    answerFeedback = '<p class="text-sm font-medium text-yellow-600 dark:text-yellow-400">You ran out of time.</p>';
                } else {
                     answerFeedback = '<p class="text-sm font-medium text-red-600 dark:text-red-400">You answered incorrectly.</p>';
                }

                return `
                    <div class="border-b border-slate-200 dark:border-slate-700 pb-4">
                        <p class="font-semibold mb-2">${index + 1}. ${q.question}</p>
                        <ul class="space-y-2 mb-3">${optionsHtml}</ul>
                        ${answerFeedback}
                    </div>
                `;
            }).join('');
        }

        function abandonQuiz() {
            clearInterval(quizTimerInterval);
            appState.activeQuiz = null;
            console.log("Quiz abandoned.");
        }

        quizExitButtonIcon.addEventListener('click', () => {
            showConfirmModal(
                'Exit Quiz?',
                'Are you sure you want to exit? Your progress for this attempt will be lost.',
                () => {
                    abandonQuiz();
                    _navigateToPage('page-take-quiz');
                }
            );
        });

        // 
        // =================================================================
        // === "SETTINGS & DATA" LOGIC =====================================
        // =================================================================
        // 
        
        function downloadJSON(data, filename) {
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('Data exported successfully!', 'success');
        }
        
        function setImportStatus(message, isError = false) {
             importStatus.textContent = message;
             importStatus.classList.toggle('text-red-500', isError);
             importStatus.classList.toggle('text-emerald-500', !isError);
             if (isError) {
                showToast(message, 'error');
             } else {
                showToast(message, 'success');
             }
             setTimeout(() => importStatus.textContent = '', 4000);
        }
        
        exportSubjectButton.addEventListener('click', () => {
            if (!currentUserId) { showModal('auth-modal'); return; }
            const subjectId = exportSubjectSelect.value;
            if (!subjectId) {
                showToast('Please select a subject to export.', 'error');
                return;
            }
            
            const subject = appState.subjects.find(s => s.id === subjectId);
            const questions = appState.questions
                .filter(q => q.subjectId === subjectId)
                .map(({id, subjectId, ...q}) => q); 
                
            const dataToExport = {
                subjectName: subject.name,
                questions: questions
            };
            
            downloadJSON(dataToExport, `studyhelper_subject_${subject.name}.json`);
        });

        exportFullButton.addEventListener('click', () => {
            if (!currentUserId) { showModal('auth-modal'); return; }
            const dataToExport = {
                subjects: appState.subjects.map(({id, ...s}) => s), 
                questions: appState.questions.map(({id, ...q}) => q), 
                quizHistory: appState.quizHistory.map(({id, ...h}) => ({ 
                    ...h,
                    timestamp: h.timestamp.toDate().toISOString() 
                }))
            };
            downloadJSON(dataToExport, `studyhelper_full_backup_${new Date().toISOString().split('T')[0]}.json`);
        });

        importSubjectForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (!currentUserId) { showModal('auth-modal'); return; }
            const subjectId = importSubjectSelect.value;
            const file = $('#import-subject-file').files[0];
            if (!subjectId || !file) {
                showToast('Please select a subject and a file.', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const importedData = JSON.parse(event.target.result);
                    if (!importedData.questions || !importedData.subjectName) {
                        throw new Error('Invalid subject file format.');
                    }
                    
                    const batch = writeBatch(db);
                    importedData.questions.forEach(question => {
                        const docRef = doc(getQuestionsCol()); 
                        batch.set(docRef, {
                            ...question,
                            subjectId: subjectId 
                        });
                    });
                    
                    await batch.commit();
                    setImportStatus(`Imported ${importedData.questions.length} questions to ${appState.subjects.find(s=>s.id === subjectId).name}.`);
                    importSubjectForm.reset();
                } catch (error) {
                    setImportStatus(`Error: ${error.message}`, true);
                }
            };
            reader.readAsText(file);
        });
        
        importFullForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (!currentUserId) { showModal('auth-modal'); return; }
            const file = $('#import-full-file').files[0];
            if (!file) {
                showToast('Please select a file.', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const importedData = JSON.parse(event.target.result);
                    if (!importedData.subjects || !importedData.questions || !importedData.quizHistory) {
                        throw new Error('Invalid backup file format.');
                    }
                    
                    showConfirmModal(
                        'Import Full Backup?',
                        'This will add all data from the file. It may create duplicates. Are you sure?',
                        async () => {
                            try {
                                const batch = writeBatch(db);
                                importedData.subjects.forEach(s => batch.set(doc(getSubjectsCol()), s));
                                importedData.questions.forEach(q => batch.set(doc(getQuestionsCol()), q));
                                importedData.quizHistory.forEach(h => {
                                    batch.set(doc(getHistoryCol()), {
                                        ...h,
                                        timestamp: Timestamp.fromDate(new Date(h.timestamp))
                                    });
                                });
                                await batch.commit();
                                setImportStatus('Full backup imported successfully!');
                                importFullForm.reset();
                            } catch (error) {
                                setImportStatus(`Error importing: ${error.message}`, true);
                            }
                        },
                        'Import',
                        'bg-sky-600'
                    );
                } catch (error) {
                    setImportStatus(`Error: ${error.message}`, true);
                }
            };
            reader.readAsText(file);
        });

        
        deleteAllDataButton.addEventListener('click', () => {
            if (!currentUserId) { showModal('auth-modal'); return; }
            showConfirmModal(
                'DELETE ALL DATA?',
                'This is your final warning. All your subjects, questions, and quiz history will be permanently erased. This cannot be undone.',
                async () => {
                    try {
                        const batch = writeBatch(db);
                        const collections = [getSubjectsCol(), getQuestionsCol(), getHistoryCol()];
                        for (const colRef of collections) {
                             const snapshot = await getDocs(colRef);
                             snapshot.forEach(doc => batch.delete(doc.ref));
                        }
                        await batch.commit();
                        showToast('All your data has been deleted.', 'success');
                    } catch (error) {
                        console.error('Error deleting all data:', error);
                        showToast('Error deleting data.', 'error');
                    }
                }
            );
        });

        // 
        // =================================================================
        // === APP-WIDE EVENT LISTENERS ====================================
        // =================================================================
        // 

        sidebarToggleBtn.addEventListener('click', () => {
            appState.isSidebarOpen = !appState.isSidebarOpen;
            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('sidebar-collapsed');
            
            const icon = appState.isSidebarOpen ? 'panel-left-close' : 'panel-left-open';
            sidebarToggleBtn.innerHTML = `<i data-lucide="${icon}" class="w-6 h-6"></i>`;
            lucide.createIcons();
            
            localStorage.setItem('studyhelper-sidebar', appState.isSidebarOpen);
        });
        
        if (localStorage.getItem('studyhelper-sidebar') === 'false') {
            appState.isSidebarOpen = false;
            sidebar.classList.add('collapsed');
            mainContent.classList.add('sidebar-collapsed');
            sidebarToggleBtn.innerHTML = `<i data-lucide="panel-left-open" class="w-6 h-6"></i>`;
        }

        $$('.sidebar-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const pageId = link.dataset.page;
                showPage(pageId);
            });
        });

        document.addEventListener('click', (e) => {
            const navButton = e.target.closest('.nav-button');
            if (navButton) {
                e.preventDefault();
                const pageId = navButton.dataset.page;
                showPage(pageId);
            }
        });

        const darkModeSwitch = $('#dark-mode-switch');
        $('#dark-mode-toggle').addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.setItem('studyhelper-darkmode', isDark);
            if (isDark) {
                darkModeSwitch.classList.add('dark:translate-x-5');
            } else {
                darkModeSwitch.classList.remove('dark:translate-x-5');
            }
        });
        
        if (localStorage.getItem('studyhelper-darkmode') === 'true' || 
           (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches && !localStorage.getItem('studyhelper-darkmode'))) 
        {
             document.documentElement.classList.add('dark');
             darkModeSwitch.classList.add('dark:translate-x-5');
        }

        // --- Final Initialization ---
        lucide.createIcons(); 
        initializeAuth(); 
        
    </script>
</body>
</html>