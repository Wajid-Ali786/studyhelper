<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Helper Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <!-- Script to apply dark mode immediately -->
    <script>
        (function() {
            const globalSettings = localStorage.getItem('studyHelperSettings_global');
            if (globalSettings) {
                try {
                    const settings = JSON.parse(globalSettings);
                    if (settings.darkMode) {
                        document.documentElement.classList.add('dark');
                    }
                } catch (e) {
                    console.error("Error parsing global settings:", e);
                }
            }
        })();
    </script>
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .dark ::-webkit-scrollbar-track {
            background: #1e293b;
        }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        /* Page transition */
        .page {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        .page.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Sidebar transition */
        #sidebar {
            transition: margin-left 0.3s ease-in-out;
        }
        #main-content {
            transition: margin-left 0.3s ease-in-out;
        }

        /* Toast notification */
        #toast {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 100;
            left: 50%;
            bottom: 30px;
            font-size: 17px;
            opacity: 0;
            transition: visibility 0.5s, opacity 0.5s linear;
        }
        #toast.dark-toast { /* Specific class for dark mode toast */
             background-color: #e2e8f0; /* slate-200 */
             color: #1e293b; /* slate-800 */
        }
        #toast.show {
            visibility: visible;
            opacity: 1;
        }

        /* Modal transitions */
        .modal-backdrop {
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }

        /* Correct/Incorrect feedback */
        .option-btn.correct {
            animation: flash-correct 0.5s;
            background-color: #10B981 !important; /* Emerald-500 */
            color: white !important;
            border-color: #059669 !important;
        }
        .option-btn.incorrect {
            animation: flash-incorrect 0.5s;
            background-color: #EF4444 !important; /* Red-500 */
            color: white !important;
            border-color: #DC2626 !important;
        }
        @keyframes flash-correct {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        @keyframes flash-incorrect {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
        }

        /* AI Button Spin */
        .ai-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-900 dark:text-slate-100 font-sans antialiased">

    <!-- App Wrapper -->
    <div id="app-wrapper"> <!-- Removed hidden class -->
        <!-- Sidebar -->
        <div id="sidebar" class="fixed top-0 left-0 z-40 w-64 h-screen bg-white dark:bg-slate-800 shadow-lg -ml-64 md:ml-0">
            <div class="flex flex-col h-full">
                <!-- Logo/Title -->
                <div class="flex items-center justify-between h-16 px-6 border-b border-slate-200 dark:border-slate-700">
                    <h1 class="text-2xl font-bold text-indigo-600 dark:text-indigo-400">
                        <i data-lucide="brain-circuit" class="inline-block mr-2"></i>
                        Study Helper
                    </h1>
                    <button id="sidebar-close-btn" class="md:hidden text-slate-500 hover:text-indigo-600 dark:text-slate-400 dark:hover:text-indigo-400">
                        <i data-lucide="x"></i>
                    </button>
                </div>

                <!-- Navigation -->
                <nav class="flex-1 px-4 py-6 space-y-2 overflow-y-auto">
                    <a href="#home" class="nav-link flex items-center px-4 py-3 text-slate-700 dark:text-slate-300 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700">
                        <i data-lucide="home" class="mr-3"></i>
                        Home
                    </a>
                    <a href="#manage" class="nav-link flex items-center px-4 py-3 text-slate-700 dark:text-slate-300 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700">
                        <i data-lucide="library" class="mr-3"></i>
                        Manage Bank
                    </a>
                    <a href="#quiz-select" class="nav-link flex items-center px-4 py-3 text-slate-700 dark:text-slate-300 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700">
                        <i data-lucide="puzzle" class="mr-3"></i>
                        Take Quiz
                    </a>
                    <a href="#history" class="nav-link flex items-center px-4 py-3 text-slate-700 dark:text-slate-300 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700">
                        <i data-lucide="bar-chart-3" class="mr-3"></i>
                        Quiz History
                    </a>
                    <a href="#settings" class="nav-link flex items-center px-4 py-3 text-slate-700 dark:text-slate-300 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700">
                        <i data-lucide="settings" class="mr-3"></i>
                        Settings & Data
                    </a>
                </nav>

                <!-- Footer / Controls -->
                <div class="px-4 py-4 border-t border-slate-200 dark:border-slate-700">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-slate-600 dark:text-slate-400">Dark Mode</span>
                        <button id="dark-mode-toggle" class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors bg-slate-300 dark:bg-indigo-600">
                            <span class="inline-block w-4 h-4 transform transition-transform bg-white rounded-full translate-x-1 dark:translate-x-6"></span>
                        </button>
                    </div>
                     <!-- Removed Login/Logout -->
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div id="main-content" class="md:ml-64 p-4 md:p-8">
            <!-- Header Bar -->
            <div class="flex items-center justify-between md:justify-end mb-6">
                <button id="sidebar-open-btn" class="md:hidden text-slate-500 hover:text-indigo-600 dark:text-slate-400 dark:hover:text-indigo-400">
                    <i data-lucide="menu"></i>
                </button>
                <div class="flex items-center space-x-4">
                    <span class="font-semibold text-slate-700 dark:text-slate-300 hidden sm:block">Welcome!</span> <!-- Updated Welcome Message -->
                </div>
            </div>

            <!-- Page: Home -->
            <div id="page-home" class="page active">
                <h2 class="text-3xl font-bold mb-6">Home</h2>
                <div id="get-started-prompt" class="hidden p-6 bg-white dark:bg-slate-800 rounded-xl shadow-lg text-center">
                    <i data-lucide="rocket" class="w-16 h-16 mx-auto text-indigo-500 mb-4"></i>
                    <h3 class="text-2xl font-semibold mb-2">Welcome to Study Helper!</h3>
                    <p class="text-slate-600 dark:text-slate-400 mb-6">It looks like you don't have any subjects yet. Get started by creating your first one.</p>
                    <button id="home-add-first-subject-btn" class="inline-flex items-center px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors">
                        <i data-lucide="plus" class="mr-2"></i>
                        Add Your First Subject
                    </button>
                </div>

                <div id="home-dashboard" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Quick Start Card -->
                    <div class="p-6 bg-white dark:bg-slate-800 rounded-xl shadow-lg">
                        <h3 class="text-xl font-semibold mb-4">Quick Start</h3>
                        <p class="text-slate-600 dark:text-slate-400 mb-6">Ready to study? Jump right into a quiz.</p>
                        <button id="home-take-quiz-btn" class="w-full px-4 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors">
                            <i data-lucide="puzzle" class="inline-block mr-2"></i>
                            Take a Quiz
                        </button>
                    </div>
                    <!-- Manage Bank Card -->
                    <div class="p-6 bg-white dark:bg-slate-800 rounded-xl shadow-lg">
                        <h3 class="text-xl font-semibold mb-4">Question Bank</h3>
                        <p class="text-slate-600 dark:text-slate-400 mb-6">Add, edit, or delete your subjects and questions.</p>
                        <button id="home-manage-bank-btn" class="w-full px-4 py-3 bg-slate-600 text-white font-semibold rounded-lg shadow-md hover:bg-slate-700 transition-colors">
                            <i data-lucide="library" class="inline-block mr-2"></i>
                            Manage Bank
                        </button>
                    </div>
                    <!-- History Card -->
                    <div class="p-6 bg-white dark:bg-slate-800 rounded-xl shadow-lg">
                        <h3 class="text-xl font-semibold mb-4">Your Progress</h3>
                        <p class="text-slate-600 dark:text-slate-400 mb-6">Review your past quiz scores and track your improvement.</p>
                        <button id="home-view-history-btn" class="w-full px-4 py-3 bg-slate-600 text-white font-semibold rounded-lg shadow-md hover:bg-slate-700 transition-colors">
                            <i data-lucide="bar-chart-3" class="inline-block mr-2"></i>
                            View History
                        </button>
                    </div>
                </div>
            </div>

            <!-- Page: Manage Bank -->
            <div id="page-manage" class="page">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-3xl font-bold">Manage Question Bank</h2>
                    <button id="add-subject-btn" class="flex items-center px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors">
                        <i data-lucide="plus" class="mr-2 h-5 w-5"></i>
                        New Subject
                    </button>
                </div>
                <div id="subject-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Subject cards will be injected here -->
                </div>
            </div>
            
            <!-- Page: Manage Subject Questions -->
            <div id="page-manage-questions" class="page">
                <button id="back-to-subjects-btn" class="flex items-center text-sm text-indigo-600 dark:text-indigo-400 font-medium mb-4 hover:underline">
                    <i data-lucide="arrow-left" class="mr-2 h-4 w-4"></i>
                    Back to All Subjects
                </button>
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-3xl font-bold">Manage: <span id="manage-subject-title"></span></h2>
                    <button id="add-question-btn" class="flex items-center px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors">
                        <i data-lucide="plus" class="mr-2 h-5 w-5"></i>
                        New Question
                    </button>
                </div>
                <div class="bg-white dark:bg-slate-800 rounded-xl shadow-lg overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full min-w-[600px]">
                            <thead class="bg-slate-50 dark:bg-slate-700">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Question</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Correct Answer</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="question-table-body" class="divide-y divide-slate-200 dark:divide-slate-700">
                                <!-- Question rows will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Page: Quiz Select -->
            <div id="page-quiz-select" class="page">
                <h2 class="text-3xl font-bold mb-6">Take a Quiz</h2>
                <div class="max-w-2xl mx-auto bg-white dark:bg-slate-800 rounded-xl shadow-lg p-8">
                    <div class="mb-6">
                        <label for="quiz-subject-select" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Select Subject</label>
                        <select id="quiz-subject-select" class="w-full px-4 py-3 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <!-- Options will be populated by JS -->
                        </select>
                    </div>

                    <div class="mb-6">
                        <label for="quiz-num-questions" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Number of Questions (Max: <span id="max-questions-label">0</span>)</label>
                        <input type="number" id="quiz-num-questions" min="1" value="10" class="w-full px-4 py-3 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>

                    <div class="mb-6">
                        <label for="quiz-time-limit" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Time per Question (seconds)</label>
                        <select id="quiz-time-limit" class="w-full px-4 py-3 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="10">10 seconds</option>
                            <option value="20">20 seconds</option>
                            <option value="30">30 seconds</option>
                            <option value="0" selected>Unlimited</option>
                        </select>
                    </div>
                    
                    <div class="mb-8">
                         <label for="quiz-time-limit-custom" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Or Custom Time (seconds)</label>
                        <input type="number" id="quiz-time-limit-custom" min="0" placeholder="e.g., 45" class="w-full px-4 py-3 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                         <p class="text-xs text-slate-500 mt-1">Leave blank to use the dropdown. '0' means unlimited.</p>
                    </div>

                    <div class="flex items-center justify-between mb-6">
                        <span class="text-sm font-medium text-slate-700 dark:text-slate-300">Show Timer</span>
                        <button id="quiz-show-timer-toggle" class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors bg-indigo-600">
                            <span class="inline-block w-4 h-4 transform transition-transform bg-white rounded-full translate-x-6"></span>
                        </button>
                    </div>

                    <button id="start-quiz-btn" class="w-full flex items-center justify-center px-6 py-4 bg-indigo-600 text-white text-lg font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors">
                        <i data-lucide="play" class="mr-2"></i>
                        Start Quiz
                    </button>
                    <button id="start-random-quiz-btn" class="w-full flex items-center justify-center mt-4 px-6 py-4 bg-slate-600 text-white text-lg font-semibold rounded-lg shadow-md hover:bg-slate-700 transition-colors">
                        <i data-lucide="shuffle" class="mr-2"></i>
                        Start Random Quiz
                    </button>
                </div>
            </div>

            <!-- Page: Quiz Active -->
            <div id="page-quiz" class="page">
                <div class="max-w-3xl mx-auto">
                    <!-- Quiz Header -->
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-4">
                            <div class="text-sm font-medium text-slate-600 dark:text-slate-400">
                                Question <span id="question-current-num">1</span> of <span id="question-total-num">10</span>
                            </div>
                            <div class="text-sm font-medium text-indigo-600 dark:text-indigo-400">
                                Score: <span id="quiz-score">0</span>
                            </div>
                        </div>
                        <div id="quiz-timer-display" class="text-2xl font-bold text-slate-700 dark:text-slate-300"> <!-- Removed class_ -->
                            00:00
                        </div>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2.5 mb-6">
                        <div id="quiz-progress-bar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 10%"></div>
                    </div>

                    <!-- Question Card -->
                    <div class="bg-white dark:bg-slate-800 rounded-xl shadow-lg p-8">
                        <h3 id="question-text" class="text-2xl font-semibold mb-8 min-h-[6rem]">
                            Question text goes here...
                        </h3>
                        <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Options will be injected here -->
                        </div>
                    </div>

                    <button id="next-question-btn" class="w-full mt-6 px-6 py-4 bg-indigo-600 text-white text-lg font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors hidden">
                        Next Question
                        <i data-lucide="arrow-right" class="inline-block ml-2"></i>
                    </button>
                </div>
            </div>

            <!-- Page: Quiz Results -->
            <div id="page-results" class="page">
                <div class="max-w-3xl mx-auto text-center">
                    <i data-lucide="award" class="w-24 h-24 mx-auto text-indigo-500 mb-6"></i>
                    <h2 class="text-4xl font-bold mb-4">Quiz Complete!</h2>
                    <p class="text-2xl text-slate-600 dark:text-slate-400 mb-8">
                        You scored <span id="results-score" class="font-bold text-indigo-600 dark:text-indigo-400">8</span> out of <span id="results-total" class="font-bold text-indigo-600 dark:text-indigo-400">10</span>
                    </p> <!-- Fixed closing tag -->
                    <p id="results-percentage" class="text-5xl font-bold mb-10">80%</p>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-10">
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                            <h4 class="text-sm font-medium text-slate-500 uppercase tracking-wider mb-2">Subject</h4>
                            <p id="results-subject" class="text-2xl font-semibold">JavaScript Basics</p>
                        </div>
                         <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                            <h4 class="text-sm font-medium text-slate-500 uppercase tracking-wider mb-2">Time Taken</h4>
                            <p id="results-time" class="text-2xl font-semibold">02:30</p>
                        </div>
                    </div>
                    
                    <!-- Performance Feedback -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg text-left mb-10">
                        <h3 class="text-xl font-semibold mb-4">Performance Insights</h3>
                        <ul class="space-y-3 text-slate-600 dark:text-slate-300">
                            <li id="feedback-fastest" class="flex items-center"><i data-lucide="zap" class="w-5 h-5 mr-3 text-yellow-500"></i>Fastest Answer: <span></span></li>
                            <li id="feedback-slowest" class="flex items-center"><i data-lucide="snail" class="w-5 h-5 mr-3 text-blue-500"></i>Slowest Answer: <span></span></li>
                            <li id="feedback-accuracy" class="flex items-center"><i data-lucide="pie-chart" class="w-5 h-5 mr-3 text-green-500"></i>Average Accuracy (This Subject): <span></span></li>
                            <li id="feedback-strongest" class="flex items-center"><i data-lucide="trending-up" class="w-5 h-5 mr-3 text-indigo-500"></i>Strongest Subject: <span></span></li>
                        </ul>
                    </div>

                    <!-- Review Answers -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg text-left mb-10">
                        <h3 class="text-xl font-semibold mb-4">Review Your Answers</h3>
                        <div id="results-review-container" class="space-y-4">
                            <!-- Review items will be injected here -->
                        </div>
                    </div>

                    <div class="flex items-center justify-center space-x-4">
                        <button id="results-another-quiz-btn" class="flex items-center px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors">
                            <i data-lucide="puzzle" class="mr-2"></i>
                            Take Another Quiz
                        </button>
                        <button id="results-back-home-btn" class="flex items-center px-6 py-3 bg-slate-600 text-white font-semibold rounded-lg shadow-md hover:bg-slate-700 transition-colors">
                            <i data-lucide="home" class="mr-2"></i>
                            Back to Home
                        </button>
                    </div>
                </div>
            </div>

            <!-- Page: History -->
            <div id="page-history" class="page">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-3xl font-bold">Quiz History</h2>
                    <button id="clear-history-btn" class="flex items-center px-4 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition-colors">
                        <i data-lucide="trash-2" class="mr-2 h-5 w-5"></i>
                        Clear History
                    </button>
                </div>
                
                <!-- Stats Overview -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                        <h4 class="text-sm font-medium text-slate-500 uppercase tracking-wider mb-2">Total Quizzes Taken</h4>
                        <p id="stats-total-quizzes" class="text-3xl font-semibold">0</p>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                        <h4 class="text-sm font-medium text-slate-500 uppercase tracking-wider mb-2">Overall Average Score</h4>
                        <p id="stats-avg-score" class="text-3xl font-semibold">0%</p>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                        <h4 class="text-sm font-medium text-slate-500 uppercase tracking-wider mb-2">Best Subject</h4>
                        <p id="stats-best-subject" class="text-3xl font-semibold">-</p>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-slate-800 rounded-xl shadow-lg overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full min-w-[700px]">
                            <thead class="bg-slate-50 dark:bg-slate-700">
                                <tr>
                                    <th class="history-sort-btn px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-600" data-sort="date">
                                        Date <span class="sort-icon"></span>
                                    </th>
                                    <th class="history-sort-btn px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-600" data-sort="subject">
                                        Subject <span class="sort-icon"></span>
                                    </th>
                                    <th class="history-sort-btn px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-600" data-sort="score">
                                        Score <span class="sort-icon"></span>
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Percentage</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body" class="divide-y divide-slate-200 dark:divide-slate-700">
                                <!-- History rows will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Page: Settings & Data -->
            <div id="page-settings" class="page">
                <h2 class="text-3xl font-bold mb-6">Settings & Data</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Data Import -->
                    <div class="bg-white dark:bg-slate-800 rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-semibold mb-4">Import Data</h3>
                        
                        <div class="mb-4">
                            <label for="import-subject-file" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Import Subject (.json)</label>
                            <input type="file" id="import-subject-file" accept=".json" class="block w-full text-sm text-slate-500
                                file:mr-4 file:py-2 file:px-4
                                file:rounded-full file:border-0
                                file:text-sm file:font-semibold
                                file:bg-indigo-50 dark:file:bg-indigo-900
                                file:text-indigo-700 dark:file:text-indigo-300
                                hover:file:bg-indigo-100 dark:hover:file:bg-indigo-800 cursor-pointer
                            ">
                            <button id="import-subject-btn" class="mt-3 w-full px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors">Import Subject</button>
                        </div>

                        <div>
                            <label for="import-backup-file" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Import Full Backup (.json)</label>
                            <input type="file" id="import-backup-file" accept=".json" class="block w-full text-sm text-slate-500
                                file:mr-4 file:py-2 file:px-4
                                file:rounded-full file:border-0
                                file:text-sm file:font-semibold
                                file:bg-indigo-50 dark:file:bg-indigo-900
                                file:text-indigo-700 dark:file:text-indigo-300
                                hover:file:bg-indigo-100 dark:hover:file:bg-indigo-800 cursor-pointer
                            ">
                            <button id="import-backup-btn" class="mt-3 w-full px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors">Import Full Backup</button>
                        </div>
                    </div>
                    
                    <!-- Data Export -->
                    <div class="bg-white dark:bg-slate-800 rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-semibold mb-4">Export Data</h3>
                        
                        <div class="mb-4">
                            <label for="export-subject-select" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Export Subject</label> <!-- Fixed closing tag -->
                            <select id="export-subject-select" class="w-full px-4 py-3 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <!-- Options will be populated by JS -->
                            </select>
                            <button id="export-subject-btn" class="mt-3 w-full px-4 py-2 bg-slate-600 text-white font-semibold rounded-lg shadow-md hover:bg-slate-700 transition-colors">Export Subject as .json</button>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Export Full Backup</label>
                            <button id="export-backup-btn" class="mt-3 w-full px-4 py-2 bg-slate-600 text-white font-semibold rounded-lg shadow-md hover:bg-slate-700 transition-colors">Export All Data as .json</button>
                        </div>
                    </div>
                    
                    <!-- Danger Zone -->
                    <div class="bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-900 rounded-xl shadow-lg p-6 md:col-span-2"> <!-- Adjusted dark bg -->
                        <h3 class="text-xl font-semibold text-red-700 dark:text-red-400 mb-4">Danger Zone</h3>
                        <p class="text-red-600 dark:text-red-300 mb-6">These actions are permanent and cannot be undone. Be careful!</p>
                        <button id="delete-all-data-btn" class="w-full sm:w-auto px-6 py-3 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition-colors">
                            Delete All My Data
                        </button>
                    </div>
                </div>
            </div>

        </div> <!-- End Main Content -->
    </div> <!-- End App Wrapper -->

    <!-- Removed Auth Screen -->


    <!-- Modals -->

    <!-- Add/Edit Subject Modal -->
    <div id="subject-modal" class="modal-backdrop fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4 hidden opacity-0">
        <div class="modal-content bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-md opacity-0 translate-y-4">
            <form id="subject-form">
                <div class="flex items-center justify-between p-6 border-b border-slate-200 dark:border-slate-700">
                    <h3 id="subject-modal-title" class="text-2xl font-semibold">Add New Subject</h3>
                    <button type="button" class="close-modal-btn text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
                        <i data-lucide="x"></i>
                    </button>
                </div>
                <div class="p-6">
                    <input type="hidden" id="subject-id">
                    <label for="subject-name" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Subject Name</label>
                    <input type="text" id="subject-name" class="w-full px-4 py-3 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <div class="flex justify-end p-6 bg-slate-50 dark:bg-slate-900/50 rounded-b-xl"> <!-- Adjusted dark bg -->
                    <button type="button" class="modal-cancel-btn px-4 py-2 mr-3 text-slate-700 dark:text-slate-300 font-medium rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">Cancel</button>
                    <button type="submit" class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors">Save Subject</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Question Modal -->
    <div id="question-modal" class="modal-backdrop fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4 hidden opacity-0">
        <div class="modal-content bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-2xl opacity-0 translate-y-4">
            <form id="question-form">
                <div class="flex items-center justify-between p-6 border-b border-slate-200 dark:border-slate-700">
                    <h3 id="question-modal-title" class="text-2xl font-semibold">Add New Question</h3>
                    <button type="button" class="close-modal-btn text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
                        <i data-lucide="x"></i>
                    </button>
                </div>
                <div class="p-6 max-h-[60vh] overflow-y-auto">
                    <input type="hidden" id="question-id">
                    <input type="hidden" id="question-subject-id">
                    
                    <button type="button" id="ai-generate-question-btn" class="w-full flex items-center justify-center mb-6 px-4 py-3 bg-gradient-to-r from-purple-500 to-indigo-600 text-white font-semibold rounded-lg shadow-md hover:opacity-90 transition-opacity">
                        <i data-lucide="sparkles" class="mr-2 h-5 w-5"></i>
                        âœ¨ Generate with AI
                    </button>
                    
                    <div class="mb-4">
                        <label for="question-text-input" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Question</label>
                        <textarea id="question-text-input" rows="3" class="w-full px-4 py-3 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" required></textarea>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="mb-4">
                            <label for="question-option-1" class="block text-sm font-medium text-green-600 dark:text-green-400 mb-2">Correct Answer (Option 1)</label>
                            <input type="text" id="question-option-1" class="w-full px-4 py-3 bg-white dark:bg-slate-700 border border-green-300 dark:border-green-600 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500" required>
                        </div>
                        <div class="mb-4">
                            <label for="question-option-2" class="block text-sm font-medium text-red-600 dark:text-red-400 mb-2">Incorrect Answer 1 (Option 2)</label>
                            <input type="text" id="question-option-2" class="w-full px-4 py-3 bg-white dark:bg-slate-700 border border-red-300 dark:border-red-600 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-red-500" required>
                        </div>
                        <div class="mb-4">
                            <label for="question-option-3" class="block text-sm font-medium text-red-600 dark:text-red-400 mb-2">Incorrect Answer 2 (Option 3)</label>
                            <input type="text" id="question-option-3" class="w-full px-4 py-3 bg-white dark:bg-slate-700 border border-red-300 dark:border-red-600 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-red-500" required>
                        </div>
                        <div class="mb-4">
                            <label for="question-option-4" class="block text-sm font-medium text-red-600 dark:text-red-400 mb-2">Incorrect Answer 3 (Option 4)</label>
                            <input type="text" id="question-option-4" class="w-full px-4 py-3 bg-white dark:bg-slate-700 border border-red-300 dark:border-red-600 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-red-500" required>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end p-6 bg-slate-50 dark:bg-slate-900/50 rounded-b-xl"> <!-- Adjusted dark bg -->
                    <button type="button" class="modal-cancel-btn px-4 py-2 mr-3 text-slate-700 dark:text-slate-300 font-medium rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">Cancel</button>
                    <button type="submit" class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors">Save Question</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- AI Answer Explanation Modal -->
    <div id="ai-explanation-modal" class="modal-backdrop fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4 hidden opacity-0">
        <div class="modal-content bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-xl opacity-0 translate-y-4">
            <div class="flex items-center justify-between p-6 border-b border-slate-200 dark:border-slate-700">
                <h3 class="text-2xl font-semibold flex items-center">
                    <i data-lucide="sparkles" class="mr-3 text-indigo-500"></i>
                    AI Explanation
                </h3>
                <button type="button" class="close-modal-btn text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="p-6 max-h-[60vh] overflow-y-auto">
                <div id="ai-explanation-loading" class="text-center py-8">
                    <i data-lucide="brain-circuit" class="w-12 h-12 mx-auto text-indigo-500 ai-spin mb-4"></i>
                    <p class="text-slate-600 dark:text-slate-400">Generating explanation, please wait...</p>
                </div>
                <div id="ai-explanation-content" class="hidden prose dark:prose-invert max-w-none">
                   <!-- AI content will be injected here -->
                </div>
            </div>
            <div class="flex justify-end p-6 bg-slate-50 dark:bg-slate-900/50 rounded-b-xl"> <!-- Adjusted dark bg -->
                <button type="button" class="close-modal-btn px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors">Close</button> <!-- Removed closing tag typo -->
            </div>
        </div>
    </div>


    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="modal-backdrop fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4 hidden opacity-0">
        <div class="modal-content bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-md opacity-0 translate-y-4">
            <div class="p-6 text-center">
                <i data-lucide="alert-triangle" class="w-16 h-16 mx-auto text-red-500 mb-6"></i>
                <h3 id="confirmation-title" class="text-2xl font-semibold mb-4">Are you sure?</h3>
                <p id="confirmation-message" class="text-slate-600 dark:text-slate-400 mb-8">This action cannot be undone.</p>
                <div class="flex justify-center space-x-4">
                    <button id="confirmation-cancel-btn" class="px-6 py-3 text-slate-700 dark:text-slate-300 font-medium rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
                        Cancel
                    </button>
                    <button id="confirmation-confirm-btn" class="px-6 py-3 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition-colors">
                        Confirm
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast">
        <i data-lucide="check-circle" class="mr-2 inline-block"></i>
        <span id="toast-message">Success!</span>
    </div>


    <!-- JavaScript -->
    <script type="module">
        // --- Globals ---
        let subjects = [];
        let quizHistory = [];
        let currentSettings = {
            darkMode: false,
            showTimer: true,
            lastSort: { key: 'date', order: 'desc' }
        };
        
        // Removed Auth Globals

        // --- Quiz Globals ---
        let currentQuiz = {
            questions: [],
            score: 0,
            currentQuestionIndex: 0,
            subject: '',
            timer: null,
            timerInterval: null,
            timePerQuestion: 0,
            showTimer: true,
            startTime: null,
            questionTimings: []
        };
        let questionReview = [];
        let currentModalCallback = null;
        let isAnswered = false;

        // --- Gemini API Key (Leave empty string) ---
        const API_KEY = ""; // This will be populated by the runtime environment
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
        

        // --- Database (localStorage) Keys ---
        // Simplified for single user
        const STORAGE_PREFIX = 'studyHelper_'; 
        const getStorageKey = (key) => `${STORAGE_PREFIX}${key}`;

        // --- DOM Elements ---
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        const appWrapper = $('#app-wrapper');
        // Removed Auth Screen Elements


        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            // Directly initialize the app UI
            initAppUI();
            addAppEventListeners(); // Moved event listener attachment here
        });
        
        // --- Removed Auth Functions ---

        // --- App UI & Data Init ---
        function initAppUI() {
            loadSettings(); // Load dark mode status first
            loadSubjects();
            loadHistory();
            
            // Determine initial page based on hash or default to home
            const initialPageId = 'page-' + (window.location.hash.slice(1) || 'home');
            showPage(initialPageId); 
            
            updateHomeDashboard();
            updateQuizSelectOptions();
            updateExportSelectOptions();
            updateActiveNavLink(); // Ensure nav link highlights correctly on load
        }

        // --- Data Persistence (localStorage) ---
        
        function loadSubjects() {
            const data = localStorage.getItem(getStorageKey('subjects')); // Use simplified key
            try {
                subjects = data ? JSON.parse(data) : [];
                if (!Array.isArray(subjects)) subjects = []; // Ensure it's an array
            } catch (e) {
                console.error("Error loading subjects:", e);
                subjects = []; // Reset on error
            }
            renderSubjectList();
        }

        function saveSubjects() {
             try {
                localStorage.setItem(getStorageKey('subjects'), JSON.stringify(subjects)); // Use simplified key
             } catch (e) {
                 console.error("Error saving subjects:", e);
                 showToast("Error saving subjects. Storage might be full.", true);
             }
            renderSubjectList();
            updateQuizSelectOptions();
            updateExportSelectOptions();
            updateHomeDashboard();
        }

        function loadHistory() {
            const data = localStorage.getItem(getStorageKey('history')); // Use simplified key
             try {
                quizHistory = data ? JSON.parse(data) : [];
                if (!Array.isArray(quizHistory)) quizHistory = []; // Ensure it's an array
             } catch (e) {
                 console.error("Error loading history:", e);
                 quizHistory = []; // Reset on error
             }
            renderHistoryTable();
        }

        function saveHistory() {
             try {
                localStorage.setItem(getStorageKey('history'), JSON.stringify(quizHistory)); // Use simplified key
             } catch (e) {
                 console.error("Error saving history:", e);
                 showToast("Error saving history. Storage might be full.", true);
             }
            renderHistoryTable();
        }
        
        function loadSettings() {
            // Dark mode is global
            const globalSettings = localStorage.getItem('studyHelperSettings_global');
            if (globalSettings) {
                 try {
                    const settings = JSON.parse(globalSettings);
                    currentSettings.darkMode = settings.darkMode || false;
                 } catch (e) {
                     console.error("Error parsing global settings:", e);
                     currentSettings.darkMode = false;
                 }
            }
            // Apply dark mode immediately based on loaded setting
            applyDarkMode(false); // Don't save again yet
            
            // Other settings are now also global for single user
            const userSettingsData = localStorage.getItem(getStorageKey('settings')); // Use simplified key
            if (userSettingsData) {
                 try {
                    const userSettings = JSON.parse(userSettingsData);
                    // Merge loaded settings, keeping darkMode from global
                    currentSettings = { ...currentSettings, ...userSettings, darkMode: currentSettings.darkMode };
                 } catch (e) {
                     console.error("Error parsing user settings:", e);
                 }
            }
            
            // Update UI elements based on loaded settings
             const timerToggle = $('#quiz-show-timer-toggle');
             const timerSpan = timerToggle?.querySelector('span'); // Add null check
             if (timerToggle && timerSpan) {
                 timerToggle.classList.toggle('bg-indigo-600', currentSettings.showTimer);
                 timerToggle.classList.toggle('bg-slate-300', !currentSettings.showTimer);
                 timerSpan.classList.toggle('translate-x-6', currentSettings.showTimer);
                 timerSpan.classList.toggle('translate-x-1', !currentSettings.showTimer);
             }
        }

        function saveSettings() {
            // Save dark mode globally
            localStorage.setItem('studyHelperSettings_global', JSON.stringify({ darkMode: currentSettings.darkMode }));
            
            // Save other settings (now global for single user)
            const userSettings = {
                showTimer: currentSettings.showTimer,
                lastSort: currentSettings.lastSort
            };
            try {
                localStorage.setItem(getStorageKey('settings'), JSON.stringify(userSettings)); // Use simplified key
            } catch (e) {
                console.error("Error saving settings:", e);
                showToast("Error saving settings. Storage might be full.", true);
            }
        }

        // --- Page Navigation ---
        function showPage(pageId) {
            // If pageId doesn't start with 'page-', prepend it. Handles onclick calls.
            if (!pageId.startsWith('page-')) {
                pageId = 'page-' + pageId;
            }

            const targetPage = $('#' + pageId);
            if (!targetPage) {
                console.warn(`Page with ID "${pageId}" not found. Defaulting to home.`);
                pageId = 'page-home'; // Fallback to home if ID is invalid
            }

            $$('.page').forEach(page => page.classList.remove('active'));
            $('#' + pageId).classList.add('active');
            
             // Update URL hash
            const hash = '#' + pageId.replace('page-', '');
            if (window.location.hash !== hash) {
                 // Use replaceState to avoid adding duplicate entries for the same page
                 history.replaceState(null, '', hash);
            }

            // Handle sidebar for mobile
            $('#sidebar').classList.add('-ml-64');
            $('#main-content').classList.remove('ml-0'); // Ensure main content moves back
            $('#main-content').classList.add('md:ml-64');
            
            updateActiveNavLink();
            
            // Specific page actions
            if (pageId === 'page-home') updateHomeDashboard();
            if (pageId === 'page-manage') renderSubjectList();
            if (pageId === 'page-history') renderHistoryTable();
            if (pageId === 'page-quiz-select') updateQuizSelectOptions();
            if (pageId === 'page-settings') updateExportSelectOptions();
        }

        function updateActiveNavLink() {
            const hash = window.location.hash || '#home';
            $$('.nav-link').forEach(link => {
                if (link.getAttribute('href') === hash) {
                    link.classList.add('bg-slate-200', 'dark:bg-slate-700', 'font-semibold');
                } else {
                    link.classList.remove('bg-slate-200', 'dark:bg-slate-700', 'font-semibold');
                }
            });
        }

        window.addEventListener('hashchange', () => {
            const pageId = 'page-' + (window.location.hash.slice(1) || 'home');
            showPage(pageId);
        });
        
        // Removed window.onload handler, covered by DOMContentLoaded

        // --- UI Renders ---
        
        function updateHomeDashboard() {
             const getStarted = $('#get-started-prompt');
             const dashboard = $('#home-dashboard');
             if (getStarted && dashboard) { // Add null checks
                 if (subjects.length === 0) {
                     getStarted.classList.remove('hidden');
                     dashboard.classList.add('hidden');
                 } else {
                     getStarted.classList.add('hidden');
                     dashboard.classList.remove('hidden');
                 }
             }
        }

        function renderSubjectList() {
            const list = $('#subject-list');
             if (!list) return; // Add null check
            list.innerHTML = '';
            if (subjects.length === 0) {
                list.innerHTML = `<p class="text-slate-500 dark:text-slate-400 md:col-span-2 lg:col-span-3">No subjects created yet. Click "New Subject" to add one!</p>`;
                return;
            }
            
            subjects.forEach(subject => {
                 if (!subject || !subject.id) return; // Add check for valid subject
                const card = document.createElement('div');
                card.className = 'bg-white dark:bg-slate-800 rounded-xl shadow-lg p-6 flex flex-col justify-between';
                card.innerHTML = `
                    <div>
                        <h3 class="text-xl font-semibold mb-2 cursor-pointer hover:text-indigo-600 dark:hover:text-indigo-400">${subject.name || 'Unnamed Subject'}</h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">${Array.isArray(subject.questions) ? subject.questions.length : 0} question(s)</p>
                    </div>
                    <div class="space-y-3">
                         <button class="start-quiz-from-card-btn w-full flex items-center justify-center px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors" data-id="${subject.id}">
                            <i data-lucide="play" class="mr-2 h-4 w-4"></i>
                            Start Quiz
                        </button>
                        <div class="flex space-x-3">
                            <button class="manage-subject-questions-btn w-full flex items-center justify-center px-4 py-2 bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-medium rounded-lg hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors" data-id="${subject.id}">
                                <i data-lucide="settings-2" class="mr-2 h-4 w-4"></i>
                                Manage
                            </button>
                            <button class="delete-subject-from-card-btn flex items-center justify-center px-4 py-2 bg-red-100 dark:bg-red-900/50 text-red-600 dark:text-red-300 font-medium rounded-lg hover:bg-red-200 dark:hover:bg-red-800 transition-colors" data-id="${subject.id}">
                                <i data-lucide="trash-2" class="h-4 w-4"></i>
                            </button>
                        </div>
                    </div>
                `;
                // Add event listeners using specific classes
                card.querySelector('.start-quiz-from-card-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const subjectId = e.currentTarget.dataset.id;
                    const selectElement = $('#quiz-subject-select');
                    if (selectElement) {
                         selectElement.value = subjectId;
                         updateQuizNumQuestions(); // Update max questions
                         showPage('page-quiz-select');
                    } else {
                        console.error("Quiz subject select dropdown not found");
                    }
                });
                card.querySelector('.manage-subject-questions-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const subjectId = e.currentTarget.dataset.id;
                    openManageQuestionsPage(subjectId);
                });
                 card.querySelector('.delete-subject-from-card-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const subjectId = e.currentTarget.dataset.id;
                    const subjectToDelete = subjects.find(s => s.id === subjectId);
                    if (subjectToDelete) {
                        showConfirmationModal(
                            'Delete Subject?',
                            `Are you sure you want to delete "${subjectToDelete.name}"? This will delete all ${subjectToDelete.questions?.length || 0} questions associated with it.`,
                            () => deleteSubject(subjectId)
                        );
                    }
                });
                
                card.querySelector('h3').addEventListener('click', (e) => {
                     e.stopPropagation();
                     const subjectId = card.querySelector('.start-quiz-from-card-btn').dataset.id; // Get id from button
                     openSubjectModal(subjectId);
                });
                
                list.appendChild(card);
            });
            lucide.createIcons(); // Ensure icons are rendered after adding elements
        }
        
        function openManageQuestionsPage(subjectId) {
            const subject = subjects.find(s => s.id === subjectId);
            if (!subject) {
                console.error(`Subject with ID ${subjectId} not found.`);
                showPage('page-manage'); // Go back if subject doesn't exist
                return;
            }
            
            $('#manage-subject-title').textContent = subject.name;
            $('#add-question-btn').dataset.subjectId = subject.id; // Ensure subjectId is set for adding new questions
            
            const tbody = $('#question-table-body');
             if (!tbody) return; // Add null check
            tbody.innerHTML = ''; // Clear previous questions
            
            if (!subject.questions || subject.questions.length === 0) {
                tbody.innerHTML = `<tr><td colspan="3" class="px-6 py-4 text-center text-slate-500 dark:text-slate-400">No questions added yet.</td></tr>`;
            } else {
                 subject.questions.forEach(q => {
                     if (!q || !q.id) return; // Add check for valid question
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-slate-50 dark:hover:bg-slate-700/50';
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-slate-900 dark:text-slate-200 truncate" style="max-width: 300px;" title="${q.question}">${q.question || 'No question text'}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-slate-600 dark:text-slate-300 truncate" style="max-width: 200px;" title="${q.options?.[0]}">${q.options?.[0] || 'No answer'}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                            <button class="edit-question-btn text-indigo-600 hover:text-indigo-900 dark:text-indigo-400 dark:hover:text-indigo-300" data-subject-id="${subject.id}" data-question-id="${q.id}">
                                Edit
                            </button>
                            <button class="delete-question-btn text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300" data-subject-id="${subject.id}" data-question-id="${q.id}">
                                Delete
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
            
            // Re-add event listeners AFTER updating innerHTML
            addQuestionTableEventListeners(subjectId);
            
            showPage('page-manage-questions');
        }

         function addQuestionTableEventListeners(subjectId) {
            $$('#question-table-body .edit-question-btn').forEach(btn => {
                 // Remove existing listener before adding a new one to prevent duplicates
                 btn.replaceWith(btn.cloneNode(true));
                 btn = $(`#question-table-body button[data-question-id="${btn.dataset.questionId}"].edit-question-btn`); // Re-select the cloned button
                btn.addEventListener('click', (e) => {
                    const { subjectId, questionId } = e.currentTarget.dataset;
                    openQuestionModal(subjectId, questionId);
                });
            });
            
             $$('#question-table-body .delete-question-btn').forEach(btn => {
                  // Remove existing listener
                  btn.replaceWith(btn.cloneNode(true));
                  btn = $(`#question-table-body button[data-question-id="${btn.dataset.questionId}"].delete-question-btn`); // Re-select the cloned button
                btn.addEventListener('click', (e) => {
                    const { subjectId, questionId } = e.currentTarget.dataset;
                    showConfirmationModal(
                        'Delete Question?',
                        'Are you sure you want to delete this question?',
                        () => deleteQuestion(subjectId, questionId)
                    );
                });
            });
         }


        function updateQuizSelectOptions() {
            const select = $('#quiz-subject-select');
             if (!select) return; // Add null check
            select.innerHTML = '';
            if (subjects.length === 0) {
                select.innerHTML = '<option disabled selected value="">Please add a subject first</option>';
                 $('#start-quiz-btn').disabled = true; // Disable start if no subjects
                 $('#start-random-quiz-btn').disabled = true; // Disable random if no subjects
            } else {
                 $('#start-quiz-btn').disabled = false;
                 $('#start-random-quiz-btn').disabled = subjects.flatMap(s => s.questions || []).length === 0; // Disable random if no questions at all

                subjects.forEach(subject => {
                     if (!subject || !subject.id) return;
                    const option = document.createElement('option');
                    option.value = subject.id;
                    option.textContent = `${subject.name || 'Unnamed Subject'} (${Array.isArray(subject.questions) ? subject.questions.length : 0} Qs)`;
                    select.appendChild(option);
                });
                 updateQuizNumQuestions(); // Update max questions for the initially selected subject
            }
        }
        
        function updateQuizNumQuestions() {
            const subjectId = $('#quiz-subject-select')?.value; // Add null check
             const maxLabel = $('#max-questions-label');
             const numInput = $('#quiz-num-questions');
             
             if (!subjectId || !maxLabel || !numInput) return; // Exit if elements not found

            const subject = subjects.find(s => s.id === subjectId);
            const max = (subject && Array.isArray(subject.questions)) ? subject.questions.length : 0;
            
            maxLabel.textContent = max;
            numInput.max = max;
            
            // Adjust current value if it exceeds new max or is invalid
            let currentValue = parseInt(numInput.value);
            if (isNaN(currentValue) || currentValue > max) {
                 numInput.value = max > 0 ? Math.min(10, max) : 0; // Default to 10 or max if less
            }
            if (currentValue < 1 && max > 0) {
                 numInput.value = 1;
            } else if (max === 0) {
                 numInput.value = 0;
            }
            // Disable start button if max questions is 0 for the selected subject
            $('#start-quiz-btn').disabled = (max === 0);
        }
        
        function updateExportSelectOptions() {
            const select = $('#export-subject-select');
             if (!select) return; // Add null check
            select.innerHTML = '';
             if (subjects.length === 0) {
                select.innerHTML = '<option disabled selected value="">No subjects to export</option>';
                 $('#export-subject-btn').disabled = true; // Disable button if no subjects
            } else {
                 $('#export-subject-btn').disabled = false;
                 subjects.forEach(subject => {
                     if (!subject || !subject.id) return;
                    const option = document.createElement('option');
                    option.value = subject.id;
                    option.textContent = subject.name || 'Unnamed Subject';
                    select.appendChild(option);
                });
            }
             // Disable full backup if no data
             $('#export-backup-btn').disabled = (subjects.length === 0 && quizHistory.length === 0);
        }
        
        function renderHistoryTable() {
            const tbody = $('#history-table-body');
             if (!tbody) return; // Add null check

            updateHistoryStats(); // Update stats regardless of rendering table
            
            tbody.innerHTML = ''; // Clear previous content
            
            if (quizHistory.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center text-slate-500 dark:text-slate-400">No quizzes taken yet.</td></tr>`;
                $$('.history-sort-btn .sort-icon').forEach(icon => icon.innerHTML = ''); // Clear sort icons
                return;
            }
            
            // Sort history
            const { key, order } = currentSettings.lastSort;
            if (!key) { // Default sort if not set
                currentSettings.lastSort = { key: 'date', order: 'desc' };
            }
            
            // Validate sort key
            const validSortKeys = ['date', 'subject', 'score'];
            const sortKey = validSortKeys.includes(key) ? key : 'date';
            const sortOrder = (order === 'asc' || order === 'desc') ? order : 'desc';

            const sortedHistory = [...quizHistory].sort((a, b) => {
                let valA = a[sortKey];
                let valB = b[sortKey];
                
                if (sortKey === 'score') {
                    // Handle potential division by zero
                    valA = (a.total && a.total > 0) ? (a.score / a.total) : 0;
                    valB = (b.total && b.total > 0) ? (b.score / b.total) : 0;
                } else if (sortKey === 'date') {
                     // Sort dates correctly
                     valA = new Date(a.date).getTime();
                     valB = new Date(b.date).getTime();
                }
                
                 // Handle potential undefined values during comparison
                 valA = valA ?? (typeof valA === 'string' ? '' : 0);
                 valB = valB ?? (typeof valB === 'string' ? '' : 0);

                if (valA < valB) return sortOrder === 'asc' ? -1 : 1;
                if (valA > valB) return sortOrder === 'asc' ? 1 : -1;
                return 0;
            });
            
            // Update sort icons
            $$('.history-sort-btn').forEach(btn => {
                const icon = btn.querySelector('.sort-icon');
                 if (!icon) return;
                if (btn.dataset.sort === sortKey) {
                    icon.innerHTML = sortOrder === 'asc' ? ' &uarr;' : ' &darr;';
                } else {
                    icon.innerHTML = '';
                }
            });
            
            sortedHistory.forEach(item => {
                 if (!item || !item.id) return; // Skip invalid items
                const tr = document.createElement('tr');
                 // Calculate percentage safely
                const percentage = (item.total && item.total > 0) ? (item.score / item.total * 100).toFixed(0) : 0;
                const date = item.date ? new Date(item.date).toLocaleString() : 'Invalid Date';
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600 dark:text-slate-300">${date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900 dark:text-slate-200">${item.subject || 'Unknown Subject'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600 dark:text-slate-300">${item.score ?? 0} / ${item.total ?? 0}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${percentage >= 80 ? 'text-green-600 dark:text-green-400' : percentage >= 50 ? 'text-yellow-600 dark:text-yellow-400' : 'text-red-600 dark:text-red-400'}">${percentage}%</td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function updateHistoryStats() {
             const totalQuizzesEl = $('#stats-total-quizzes');
             const avgScoreEl = $('#stats-avg-score');
             const bestSubjectEl = $('#stats-best-subject');

             if (!totalQuizzesEl || !avgScoreEl || !bestSubjectEl) return; // Add null checks

            totalQuizzesEl.textContent = quizHistory.length;
            
            if (quizHistory.length === 0) {
                 avgScoreEl.textContent = '0%';
                 bestSubjectEl.textContent = '-';
                 return;
            }
            
            let totalScoreSum = 0;
            let totalQuestionsSum = 0;
            quizHistory.forEach(item => {
                if (item && typeof item.score === 'number' && typeof item.total === 'number' && item.total > 0) {
                    totalScoreSum += item.score;
                    totalQuestionsSum += item.total;
                }
            });
            
            const avgScore = totalQuestionsSum > 0 ? (totalScoreSum / totalQuestionsSum * 100).toFixed(0) : 0;
            avgScoreEl.textContent = `${avgScore}%`;
            
            // Calculate best subject based on average percentage
            const subjectStats = {};
            quizHistory.forEach(item => {
                 if (!item || !item.subject || typeof item.score !== 'number' || typeof item.total !== 'number' || item.total <= 0) return;
                if (!subjectStats[item.subject]) {
                    subjectStats[item.subject] = { scoreSum: 0, totalSum: 0, count: 0 };
                }
                subjectStats[item.subject].scoreSum += item.score;
                subjectStats[item.subject].totalSum += item.total;
                subjectStats[item.subject].count++;
            });
            
            let bestSubject = '-';
            let bestAvg = -1;
            
            for (const subjectName in subjectStats) {
                const stats = subjectStats[subjectName];
                 if (stats.totalSum > 0) {
                    const avg = stats.scoreSum / stats.totalSum;
                    if (avg > bestAvg) {
                        bestAvg = avg;
                        bestSubject = subjectName;
                    }
                 }
            }
            bestSubjectEl.textContent = bestSubject;
        }

        // --- Subject CRUD ---
        function openSubjectModal(subjectId = null) {
            const form = $('#subject-form');
             if (!form) return;
            form.reset();
             // Reset hidden ID field
             $('#subject-id').value = ''; 
            if (subjectId) {
                const subject = subjects.find(s => s.id === subjectId);
                if (!subject) return;
                $('#subject-modal-title').textContent = 'Edit Subject';
                $('#subject-id').value = subject.id;
                $('#subject-name').value = subject.name || ''; // Handle potential undefined name
            } else {
                $('#subject-modal-title').textContent = 'Add New Subject';
            }
            openModal('subject-modal');
        }

        function handleSubjectFormSubmit(e) {
            e.preventDefault();
            const id = $('#subject-id').value;
            const name = $('#subject-name').value.trim();
            if (!name) {
                 showToast('Subject name cannot be empty.', true);
                 return;
            }

            if (id) {
                // Edit
                const subjectIndex = subjects.findIndex(s => s.id === id);
                if (subjectIndex > -1) {
                    subjects[subjectIndex].name = name;
                    showToast(`Subject "${name}" updated!`);
                     saveSubjects(); // Save after successful update
                     closeModal('subject-modal');
                } else {
                     showToast(`Error: Subject with ID ${id} not found.`, true);
                }
            } else {
                // Add
                const newSubject = {
                    id: `sub_${Date.now()}_${Math.random().toString(36).substring(2, 7)}`, // More robust ID
                    name: name,
                    questions: []
                };
                subjects.push(newSubject);
                showToast(`Subject "${name}" added!`);
                 saveSubjects(); // Save after successful add
                 closeModal('subject-modal');
            }
        }
        
        function deleteSubject(subjectId) {
             const subjectIndex = subjects.findIndex(s => s.id === subjectId);
             if (subjectIndex > -1) {
                const subjectName = subjects[subjectIndex].name || 'Subject';
                subjects.splice(subjectIndex, 1); // Use splice for efficiency
                saveSubjects();
                showToast(`Subject "${subjectName}" deleted!`);
                 // If the deleted subject was selected for quiz/export, update the selects
                 if ($('#quiz-subject-select')?.value === subjectId) updateQuizSelectOptions();
                 if ($('#export-subject-select')?.value === subjectId) updateExportSelectOptions();
             } else {
                 showToast(`Error: Subject with ID ${subjectId} not found.`, true);
             }
        }
        
        // --- Question CRUD ---
        function openQuestionModal(subjectId, questionId = null) {
            const form = $('#question-form');
             if (!form) return;
            form.reset();
             $('#question-subject-id').value = subjectId;
             // Reset hidden ID field
             $('#question-id').value = ''; 

             const subject = subjects.find(s => s.id === subjectId);
             if (!subject) {
                 showToast(`Error: Cannot find subject to add question to.`, true);
                 return;
             }
            
            if (questionId) {
                // Edit
                const question = subject.questions?.find(q => q.id === questionId); // Add null check for questions array
                if (!question) {
                     showToast(`Error: Question with ID ${questionId} not found.`, true);
                     return;
                }
                
                $('#question-modal-title').textContent = 'Edit Question';
                $('#question-id').value = question.id;
                $('#question-text-input').value = question.question || '';
                // Ensure options array exists and has 4 elements before accessing
                 const options = question.options || [];
                 $('#question-option-1').value = options[0] || ''; // Correct
                 $('#question-option-2').value = options[1] || ''; // Incorrect
                 $('#question-option-3').value = options[2] || ''; // Incorrect
                 $('#question-option-4').value = options[3] || ''; // Incorrect
            } else {
                // Add
                $('#question-modal-title').textContent = 'Add New Question';
            }
            openModal('question-modal');
        }
        
        function handleQuestionFormSubmit(e) {
            e.preventDefault();
            const subjectId = $('#question-subject-id').value;
            const questionId = $('#question-id').value;
            const subjectIndex = subjects.findIndex(s => s.id === subjectId); // Find index for easier modification
            
            if (subjectIndex === -1) {
                 showToast(`Error: Subject not found. Cannot save question.`, true);
                 return;
            }
            
            // Ensure questions array exists
             if (!Array.isArray(subjects[subjectIndex].questions)) {
                 subjects[subjectIndex].questions = [];
             }

            const questionData = {
                id: questionId || `q_${Date.now()}_${Math.random().toString(36).substring(2, 7)}`, // More robust ID
                question: $('#question-text-input').value.trim(),
                options: [
                    $('#question-option-1').value.trim(), // Correct answer is always index 0
                    $('#question-option-2').value.trim(),
                    $('#question-option-3').value.trim(),
                    $('#question-option-4').value.trim()
                ]
            };
            
            // Basic Validation
            if (!questionData.question || questionData.options.some(opt => !opt)) {
                 showToast('Please fill out the question and all four answer options.', true);
                return;
            }
            
            if (questionId) {
                // Edit existing question
                const questionIndex = subjects[subjectIndex].questions.findIndex(q => q.id === questionId);
                if (questionIndex > -1) {
                    subjects[subjectIndex].questions[questionIndex] = questionData;
                    showToast('Question updated!');
                } else {
                     showToast(`Error: Question with ID ${questionId} not found for editing.`, true);
                     return; // Don't proceed if question wasn't found
                }
            } else {
                // Add new question
                subjects[subjectIndex].questions.push(questionData);
                showToast('Question added!');
            }
            
            saveSubjects();
            // Refresh the question list ONLY if the manage questions page is active
             if ($('#page-manage-questions').classList.contains('active')) {
                openManageQuestionsPage(subjectId); 
             }
            closeModal('question-modal');
        }
        
        function deleteQuestion(subjectId, questionId) {
            const subjectIndex = subjects.findIndex(s => s.id === subjectId);
            if (subjectIndex === -1 || !Array.isArray(subjects[subjectIndex].questions)) {
                 showToast(`Error: Subject or questions not found.`, true);
                 return;
            }
            
             const initialLength = subjects[subjectIndex].questions.length;
            subjects[subjectIndex].questions = subjects[subjectIndex].questions.filter(q => q.id !== questionId);
            
             if (subjects[subjectIndex].questions.length < initialLength) {
                saveSubjects();
                 // Refresh the question list ONLY if the manage questions page is active
                 if ($('#page-manage-questions').classList.contains('active')) {
                    openManageQuestionsPage(subjectId);
                 }
                showToast('Question deleted!');
             } else {
                  showToast(`Error: Question with ID ${questionId} not found for deletion.`, true);
             }
        }
        
        
        // --- Quiz Logic ---
        
        function startQuiz(isRandom = false) {
            const subjectSelect = $('#quiz-subject-select');
            const subjectId = subjectSelect?.value;
            let numQuestionsInput = $('#quiz-num-questions');
            let numQuestions = parseInt(numQuestionsInput?.value);
            const customTimeInput = $('#quiz-time-limit-custom');
            const customTime = parseInt(customTimeInput?.value);
            const timeLimitSelect = $('#quiz-time-limit');
            
            // Input validation
            if (!numQuestionsInput || !customTimeInput || !timeLimitSelect || !subjectSelect) {
                 showToast('Quiz setup elements not found.', true);
                 return;
            }
            
            let timeLimit = isNaN(customTime) || customTime === "" ? parseInt(timeLimitSelect.value) : customTime;
            if (isNaN(timeLimit) || timeLimit < 0) timeLimit = 0; // Default to unlimited if invalid
            
            let questionsToAsk = [];
            let subjectName = "Random Quiz";
            
            if (isRandom) {
                const allQuestions = subjects.flatMap(s => (s.questions || []).map(q => ({...q, subjectName: s.name}))); // Handle subjects without questions
                if (allQuestions.length === 0) {
                    showToast('No questions available in any subject!', true);
                    return;
                }
                // For random quiz, ensure numQuestions doesn't exceed available questions
                numQuestions = Math.max(1, Math.min(allQuestions.length, isNaN(numQuestions) ? 10 : numQuestions)); // Default 10 or max available
                questionsToAsk = shuffleArray(allQuestions).slice(0, numQuestions);
                
            } else {
                 if (!subjectId) {
                     showToast('Please select a subject.', true);
                     return;
                 }
                const subject = subjects.find(s => s.id === subjectId);
                if (!subject || !Array.isArray(subject.questions) || subject.questions.length === 0) {
                    showToast('This subject has no questions or is invalid!', true);
                    return;
                }
                
                subjectName = subject.name || 'Unnamed Subject';
                 // Validate numQuestions against the subject's actual question count
                 if (isNaN(numQuestions) || numQuestions <= 0) {
                    numQuestions = Math.min(10, subject.questions.length); // Default to 10 or max available
                    numQuestionsInput.value = numQuestions; // Update input field
                 } else {
                     numQuestions = Math.min(numQuestions, subject.questions.length);
                 }
                 
                 if (numQuestions <= 0) { // Final check if subject had 0 questions initially
                     showToast('Selected subject has no questions.', true);
                     return;
                 }
                
                questionsToAsk = shuffleArray([...subject.questions]).slice(0, numQuestions);
            }
            
            // Ensure we have questions before proceeding
             if (questionsToAsk.length === 0) {
                 showToast('Could not select any questions for the quiz.', true);
                 return;
             }
            
            currentQuiz = {
                questions: questionsToAsk,
                score: 0,
                currentQuestionIndex: 0,
                subject: subjectName,
                timer: 0, // Initialize timer value
                timerInterval: null,
                timePerQuestion: timeLimit,
                showTimer: currentSettings.showTimer,
                startTime: new Date(),
                questionTimings: []
            };
            
            questionReview = [];
            isAnswered = false;
            
            // Update UI elements safely
            const scoreEl = $('#quiz-score');
            const totalNumEl = $('#question-total-num');
            const timerDisplayEl = $('#quiz-timer-display');
            
            if (scoreEl) scoreEl.textContent = 0;
            if (totalNumEl) totalNumEl.textContent = questionsToAsk.length;
            if (timerDisplayEl) timerDisplayEl.classList.toggle('hidden', !currentSettings.showTimer && timeLimit === 0); // Hide only if disabled AND unlimited
            
            showPage('page-quiz');
            showQuestion();
        }

        function showQuestion() {
            if (currentQuiz.currentQuestionIndex >= currentQuiz.questions.length) {
                endQuiz();
                return;
            }
            
            isAnswered = false;
            const question = currentQuiz.questions[currentQuiz.currentQuestionIndex];
            
             // Validate question structure
             if (!question || !question.question || !Array.isArray(question.options) || question.options.length < 4) {
                 console.error("Invalid question data:", question);
                 showToast("Error: Invalid question data encountered. Skipping.", true);
                 nextQuestion(); // Skip this invalid question
                 return;
             }
            
            // Update counts and progress safely
            const currentNumEl = $('#question-current-num');
            const progressBarEl = $('#quiz-progress-bar');
            if (currentNumEl) currentNumEl.textContent = currentQuiz.currentQuestionIndex + 1;
            if (progressBarEl) {
                const progress = ((currentQuiz.currentQuestionIndex + 1) / currentQuiz.questions.length) * 100;
                progressBarEl.style.width = `${progress}%`;
            }
            
            // Display question safely
            const questionTextEl = $('#question-text');
            if (questionTextEl) questionTextEl.textContent = question.question;
            
            // Shuffle valid options
            const validOptions = question.options.filter(opt => typeof opt === 'string' && opt.trim() !== '');
            // Need at least 2 options to shuffle reasonably, though we expect 4
            const optionsToShow = validOptions.length >= 2 ? shuffleArray([...validOptions]) : validOptions; 
            
            const optionsContainer = $('#options-container');
             if (!optionsContainer) return;
            optionsContainer.innerHTML = ''; // Clear previous options
            
            optionsToShow.forEach(option => {
                const isCorrect = (option === question.options[0]); // Correct answer is always the first in original array
                const button = document.createElement('button');
                button.className = 'option-btn w-full p-4 border-2 border-slate-300 dark:border-slate-600 rounded-lg text-left text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500';
                button.textContent = option;
                button.dataset.correct = isCorrect;
                button.addEventListener('click', handleOptionClick);
                optionsContainer.appendChild(button);
            });
            
            // Hide next button
             const nextBtn = $('#next-question-btn');
             if (nextBtn) nextBtn.classList.add('hidden');
            
            startTimer();
        }
        
        function handleOptionClick(e) {
            if (isAnswered) return;
            isAnswered = true;
            
            stopTimer(); // Stop timer immediately
            const selectedButton = e.currentTarget;
            const isCorrect = selectedButton.dataset.correct === 'true';
             const currentQuestionData = currentQuiz.questions[currentQuiz.currentQuestionIndex];

            // Record timing
            let timeTaken = 0;
            if (currentQuiz.timePerQuestion > 0) {
                 timeTaken = currentQuiz.timePerQuestion - (currentQuiz.timer || 0); // Use timer value if exists
            } else if (currentQuiz.questionStartTime) {
                 timeTaken = (new Date() - currentQuiz.questionStartTime) / 1000;
            }
            // Ensure timeTaken is a non-negative number
            timeTaken = Math.max(0, timeTaken); 

            currentQuiz.questionTimings.push({
                question: currentQuestionData.question,
                time: timeTaken,
                correct: isCorrect
            });

            
            // Store for review
            questionReview.push({
                question: currentQuestionData,
                selected: selectedButton.textContent,
                correct: isCorrect
            });
            
            if (isCorrect) {
                currentQuiz.score++;
                 const scoreEl = $('#quiz-score');
                 if (scoreEl) scoreEl.textContent = currentQuiz.score;
                selectedButton.classList.add('correct');
            } else {
                selectedButton.classList.add('incorrect');
                // Highlight correct answer only if it exists
                const correctButton = optionsContainer.querySelector(`button[data-correct="true"]`);
                if (correctButton) {
                    correctButton.classList.add('correct');
                }
            }
            
            // Disable all options
            optionsContainer.querySelectorAll('.option-btn').forEach(btn => {
                btn.disabled = true;
                btn.classList.add('opacity-70', 'cursor-not-allowed'); // Add cursor style
            });
            
            // Show next button
             const nextBtn = $('#next-question-btn');
             if (nextBtn) nextBtn.classList.remove('hidden');
        }
        
        function nextQuestion() {
            currentQuiz.currentQuestionIndex++;
            showQuestion(); // This will handle calling endQuiz if index is out of bounds
        }

        function startTimer() {
            stopTimer(); // Clear any existing timer before starting a new one
            currentQuiz.questionStartTime = new Date(); // Record start time for unlimited or fallback timing
            
            if (currentQuiz.timePerQuestion > 0) {
                currentQuiz.timer = currentQuiz.timePerQuestion; // Reset timer value
                const timerDisplay = $('#quiz-timer-display');
                 if (!timerDisplay) return; // Exit if display element not found

                const updateDisplay = () => {
                      if (currentQuiz.timer === null) return; // Stop updates if timer was cleared
                     const minutes = Math.floor(currentQuiz.timer / 60);
                     const seconds = currentQuiz.timer % 60;
                     timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                     
                     // Visual cue for low time
                     timerDisplay.classList.toggle('text-red-500', currentQuiz.timer <= 10);
                };
                
                updateDisplay(); // Initial display
                
                currentQuiz.timerInterval = setInterval(() => {
                    if (currentQuiz.timer !== null && currentQuiz.timer > 0) {
                        currentQuiz.timer--;
                        updateDisplay();
                    }
                    
                    if (currentQuiz.timer !== null && currentQuiz.timer <= 0) {
                        // Time's up
                        stopTimer(); // Clear interval
                        if (!isAnswered) { // Only call timeUp if user hasn't answered
                             timeUp();
                        }
                    }
                }, 1000);
            } else {
                 // Unlimited time
                 const timerDisplay = $('#quiz-timer-display');
                 if (timerDisplay) timerDisplay.textContent = '--:--'; 
            }
        }
        
        function stopTimer() {
            if (currentQuiz.timerInterval) {
                clearInterval(currentQuiz.timerInterval);
                currentQuiz.timerInterval = null;
                 // Set timer value to null to indicate it stopped, important for updateDisplay check
                 currentQuiz.timer = null; 
            }
        }
        
        function timeUp() {
            // This function is called only when the timer runs out *before* the user clicks
            if (isAnswered) return; // Should not happen if called correctly, but double-check
            isAnswered = true;
            
             const currentQuestionData = currentQuiz.questions[currentQuiz.currentQuestionIndex];

            // Record timing (max time allowed)
            currentQuiz.questionTimings.push({
                question: currentQuestionData.question,
                time: currentQuiz.timePerQuestion, // Record the full allowed time
                correct: false
            });
            
            // Store for review
             questionReview.push({
                question: currentQuestionData,
                selected: 'Time up!', // Indicate time ran out
                correct: false
            });
            
            // Highlight correct answer
            const correctButton = optionsContainer.querySelector(`button[data-correct="true"]`);
            if (correctButton) {
                correctButton.classList.add('correct');
                // Optionally add a visual cue that this was the correct one, but time ran out
            }
            
             // Disable all options
             const optionsContainer = $('#options-container');
             if (optionsContainer) {
                 optionsContainer.querySelectorAll('.option-btn').forEach(btn => {
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed'); // Make it clearer time ran out
                });
             }
            
             // Show next button
             const nextBtn = $('#next-question-btn');
             if (nextBtn) nextBtn.classList.remove('hidden');
        }

        function endQuiz() {
            stopTimer(); // Ensure timer is stopped
            
            const total = currentQuiz.questions.length;
            const score = currentQuiz.score;
            // Calculate percentage safely
            const percentage = (total > 0) ? ((score / total) * 100).toFixed(0) : 0; 
            // Calculate time taken safely
            const timeTaken = currentQuiz.startTime ? Math.floor((new Date() - currentQuiz.startTime) / 1000) : 0;
            
            // Save to history only if it was a valid quiz
            if (total > 0) {
                const historyItem = {
                    id: `hist_${Date.now()}_${Math.random().toString(36).substring(2, 7)}`,
                    date: new Date().toISOString(),
                    subject: currentQuiz.subject || 'Unknown Subject',
                    score: score,
                    total: total
                };
                quizHistory.push(historyItem);
                saveHistory();
            }
            
            // Update Results Page UI Elements Safely
            const resultsScoreEl = $('#results-score');
            const resultsTotalEl = $('#results-total');
            const resultsPercentageEl = $('#results-percentage');
            const resultsSubjectEl = $('#results-subject');
            const resultsTimeEl = $('#results-time');
            
            if (resultsScoreEl) resultsScoreEl.textContent = score;
            if (resultsTotalEl) resultsTotalEl.textContent = total;
            if (resultsPercentageEl) resultsPercentageEl.textContent = `${percentage}%`;
            if (resultsSubjectEl) resultsSubjectEl.textContent = currentQuiz.subject || 'Unknown Subject';
            if (resultsTimeEl) resultsTimeEl.textContent = `${String(Math.floor(timeTaken / 60)).padStart(2, '0')}:${String(timeTaken % 60).padStart(2, '0')}`;
            
            // Display review
            const reviewContainer = $('#results-review-container');
            if (reviewContainer) {
                 reviewContainer.innerHTML = ''; // Clear previous review
                 if (questionReview.length > 0) {
                    questionReview.forEach((item, index) => {
                         if (!item || !item.question) return; // Skip invalid review items
                        const div = document.createElement('div');
                        div.className = `p-4 rounded-lg ${item.correct ? 'bg-green-50 dark:bg-green-900/50 border border-green-200 dark:border-green-800' : 'bg-red-50 dark:bg-red-900/50 border border-red-200 dark:border-red-800'}`;
                        
                         // Safely access question properties
                         const questionText = item.question.question || 'Question text missing';
                         const correctAnswer = item.question.options?.[0] || 'Correct answer missing';
                         const selectedAnswer = item.selected || 'No answer selected';

                        div.innerHTML = `
                            <p class="font-semibold mb-2">${index + 1}. ${questionText}</p>
                            <p class="text-sm">Your answer: <span class="font-medium">${selectedAnswer}</span></p>
                            ${!item.correct ? `<p class="text-sm">Correct answer: <span class="font-medium">${correctAnswer}</span></p>` : ''}
                            ${!item.correct ? `<button class="ai-explain-btn text-sm mt-2 flex items-center text-indigo-600 dark:text-indigo-400 font-medium hover:underline"
                                        data-question="${encodeURIComponent(questionText)}"
                                        data-correct-answer="${encodeURIComponent(correctAnswer)}"
                                        data-user-answer="${encodeURIComponent(selectedAnswer)}">
                                        <i data-lucide="sparkles" class="w-4 h-4 mr-1"></i>
                                        âœ¨ Explain
                                   </button>` : ''}
                        `;
                        reviewContainer.appendChild(div);
                    });
                     // Add listeners for explain buttons AFTER appending all elements
                     $$('#results-review-container .ai-explain-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const { question, correctAnswer, userAnswer } = e.currentTarget.dataset;
                             // Check if data attributes exist before decoding
                             if (question && correctAnswer && userAnswer) {
                                openAiExplanationModal(decodeURIComponent(question), decodeURIComponent(correctAnswer), decodeURIComponent(userAnswer));
                             } else {
                                 console.error("Missing data attributes for AI explanation.");
                             }
                        });
                    });
                     lucide.createIcons(); // Render icons in the review section
                 } else {
                     reviewContainer.innerHTML = '<p class="text-slate-500 dark:text-slate-400">No answers to review for this quiz.</p>';
                 }
            }
            
            // Display feedback
            displayPerformanceFeedback();
            
            showPage('page-results');
        }
        
        function displayPerformanceFeedback() {
             const fastestEl = $('#feedback-fastest > span');
             const slowestEl = $('#feedback-slowest > span');
             const accuracyEl = $('#feedback-accuracy > span');
             const strongestEl = $('#feedback-strongest > span');

             if (!fastestEl || !slowestEl || !accuracyEl || !strongestEl) return; // Add null checks


            // 1. Timings from current quiz
             let fastestTime = null;
             let slowestTime = null;
            if (currentQuiz.questionTimings && currentQuiz.questionTimings.length > 0) {
                 fastestTime = currentQuiz.questionTimings.reduce((min, q) => (!isNaN(q.time) && q.time < min ? q.time : min), currentQuiz.questionTimings[0].time);
                 slowestTime = currentQuiz.questionTimings.reduce((max, q) => (!isNaN(q.time) && q.time > max ? q.time : max), currentQuiz.questionTimings[0].time);
            }
            fastestEl.textContent = fastestTime !== null ? `${fastestTime.toFixed(1)}s` : 'N/A';
            slowestEl.textContent = slowestTime !== null ? `${slowestTime.toFixed(1)}s` : 'N/A';
            
            // 2. Accuracy for this specific subject (using all history)
            if (currentQuiz.subject && currentQuiz.subject !== 'Random Quiz') {
                 const subjectHistory = quizHistory.filter(h => h && h.subject === currentQuiz.subject);
                 let totalScore = 0;
                 let totalQs = 0;
                 subjectHistory.forEach(h => {
                     if (h && typeof h.score === 'number' && typeof h.total === 'number' && h.total > 0) {
                         totalScore += h.score;
                         totalQs += h.total;
                     }
                 });
                 const avgAccuracy = totalQs > 0 ? (totalScore / totalQs * 100).toFixed(0) : '0';
                 accuracyEl.textContent = `${avgAccuracy}% (${subjectHistory.length} attempt${subjectHistory.length !== 1 ? 's' : ''})`;
            } else {
                 accuracyEl.textContent = 'N/A (Random Quiz)';
            }
            
            // 3. Strongest Subject (using all history)
             // Reuse calculation from updateHistoryStats - ensure it's calculated correctly there
             const bestSubjectStat = $('#stats-best-subject')?.textContent; // Read from already calculated stat
             strongestEl.textContent = bestSubjectStat || 'N/A';
        }


        // --- Event Listeners ---
        function addAppEventListeners() {
            // Sidebar Toggle
             const sidebarOpenBtn = $('#sidebar-open-btn');
             const sidebarCloseBtn = $('#sidebar-close-btn');
             const sidebar = $('#sidebar');
             const mainContent = $('#main-content');

             if (sidebarOpenBtn && sidebar && mainContent) {
                 sidebarOpenBtn.addEventListener('click', () => {
                     sidebar.classList.remove('-ml-64');
                     sidebar.classList.add('ml-0');
                     mainContent.classList.remove('md:ml-64'); // Adjust main content immediately on mobile
                     mainContent.classList.add('ml-64', 'md:ml-0'); // Push content right
                 });
             }
             if (sidebarCloseBtn && sidebar && mainContent) {
                 sidebarCloseBtn.addEventListener('click', () => {
                     sidebar.classList.add('-ml-64');
                     sidebar.classList.remove('ml-0');
                     mainContent.classList.remove('ml-64', 'md:ml-0'); // Pull content back
                     mainContent.classList.add('md:ml-64');
                 });
             }
             // Close sidebar when clicking main content on mobile
             if (mainContent) {
                 mainContent.addEventListener('click', () => {
                     if (window.innerWidth < 768 && sidebar && !sidebar.classList.contains('-ml-64')) { // Only if sidebar is open on mobile
                         sidebar.classList.add('-ml-64');
                         sidebar.classList.remove('ml-0');
                         mainContent.classList.remove('ml-64', 'md:ml-0');
                         mainContent.classList.add('md:ml-64');
                     }
                 });
             }

            
            // Removed Logout Listener
            
            // Dark Mode Toggle
             const darkModeToggle = $('#dark-mode-toggle');
             if (darkModeToggle) {
                 darkModeToggle.addEventListener('click', () => {
                    currentSettings.darkMode = !currentSettings.darkMode;
                    applyDarkMode(true); // Apply and save
                 });
             }
            
            // Nav Links (Ensure correct page showing)
            $$('.nav-link').forEach(link => {
                 link.addEventListener('click', (e) => {
                     // Don't prevent default, allow hash change
                     const pageId = 'page-' + (e.currentTarget.hash.slice(1) || 'home');
                     // showPage is now called by hashchange listener, just ensure sidebar closes on mobile
                     if (window.innerWidth < 768 && sidebar && !sidebar.classList.contains('-ml-64')) {
                         sidebar.classList.add('-ml-64');
                         sidebar.classList.remove('ml-0');
                         mainContent.classList.remove('ml-64', 'md:ml-0');
                         mainContent.classList.add('md:ml-64');
                     }
                 });
            });

            // Home Page Buttons (using IDs and event listeners)
             const homeAddSubjectBtn = $('#home-add-first-subject-btn');
             const homeTakeQuizBtn = $('#home-take-quiz-btn');
             const homeManageBankBtn = $('#home-manage-bank-btn');
             const homeViewHistoryBtn = $('#home-view-history-btn');
             
             if (homeAddSubjectBtn) homeAddSubjectBtn.addEventListener('click', () => showPage('page-manage'));
             if (homeTakeQuizBtn) homeTakeQuizBtn.addEventListener('click', () => showPage('page-quiz-select'));
             if (homeManageBankBtn) homeManageBankBtn.addEventListener('click', () => showPage('page-manage'));
             if (homeViewHistoryBtn) homeViewHistoryBtn.addEventListener('click', () => showPage('page-history'));
             
             // Back to Subjects Button
             const backToSubjectsBtn = $('#back-to-subjects-btn');
             if (backToSubjectsBtn) backToSubjectsBtn.addEventListener('click', () => showPage('page-manage'));

             // Results Page Buttons
             const resultsAnotherQuizBtn = $('#results-another-quiz-btn');
             const resultsBackHomeBtn = $('#results-back-home-btn');
             if (resultsAnotherQuizBtn) resultsAnotherQuizBtn.addEventListener('click', () => showPage('page-quiz-select'));
             if (resultsBackHomeBtn) resultsBackHomeBtn.addEventListener('click', () => showPage('page-home'));


            // Modals Close/Cancel Buttons
            $$('.close-modal-btn, .modal-cancel-btn').forEach(btn => {
                 btn.addEventListener('click', (e) => {
                     const modal = e.currentTarget.closest('.modal-backdrop');
                     if (modal) {
                         closeModal(modal.id);
                     }
                 });
            });
            // Close modal on backdrop click
             $$('.modal-backdrop').forEach(backdrop => {
                 backdrop.addEventListener('click', (e) => {
                     if (e.target === backdrop) { // Only close if clicking the backdrop itself
                         closeModal(backdrop.id);
                     }
                 });
             });
            
            // Manage Bank Page
             const addSubjectBtn = $('#add-subject-btn');
             const subjectForm = $('#subject-form');
             if (addSubjectBtn) addSubjectBtn.addEventListener('click', () => openSubjectModal());
             if (subjectForm) subjectForm.addEventListener('submit', handleSubjectFormSubmit);
            
            // Manage Questions Page
             const addQuestionBtn = $('#add-question-btn');
             const questionForm = $('#question-form');
             if (addQuestionBtn) {
                 addQuestionBtn.addEventListener('click', (e) => {
                    const subjectId = e.currentTarget.dataset.subjectId;
                    if (subjectId) {
                         openQuestionModal(subjectId);
                    } else {
                         showToast('Cannot determine subject context.', true);
                    }
                 });
             }
             if (questionForm) questionForm.addEventListener('submit', handleQuestionFormSubmit);
            
            // Quiz Select Page
             const quizSubjectSelect = $('#quiz-subject-select');
             const startQuizBtn = $('#start-quiz-btn');
             const startRandomQuizBtn = $('#start-random-quiz-btn');
             const quizShowTimerToggle = $('#quiz-show-timer-toggle');

             if (quizSubjectSelect) quizSubjectSelect.addEventListener('change', updateQuizNumQuestions);
             if (startQuizBtn) startQuizBtn.addEventListener('click', () => startQuiz(false));
             if (startRandomQuizBtn) startRandomQuizBtn.addEventListener('click', () => startQuiz(true));
             if (quizShowTimerToggle) {
                 quizShowTimerToggle.addEventListener('click', (e) => {
                    currentSettings.showTimer = !currentSettings.showTimer;
                    const button = e.currentTarget;
                    const span = button.querySelector('span');
                    if (span) {
                         button.classList.toggle('bg-indigo-600', currentSettings.showTimer);
                         button.classList.toggle('bg-slate-300', !currentSettings.showTimer);
                         span.classList.toggle('translate-x-6', currentSettings.showTimer);
                         span.classList.toggle('translate-x-1', !currentSettings.showTimer);
                    }
                    saveSettings(); // Save the setting
                 });
             }
             
            // Quiz Active Page
             const nextQuestionBtn = $('#next-question-btn');
             if (nextQuestionBtn) nextQuestionBtn.addEventListener('click', nextQuestion);
            
            // History Page
             const clearHistoryBtn = $('#clear-history-btn');
             if (clearHistoryBtn) {
                 clearHistoryBtn.addEventListener('click', () => {
                    showConfirmationModal(
                        'Clear History?',
                        'Are you sure you want to delete all quiz history? This cannot be undone.',
                        () => {
                            quizHistory = [];
                            saveHistory(); // Save the empty array
                            showToast('Quiz history cleared!');
                            renderHistoryTable(); // Re-render the table immediately
                        }
                    );
                 });
             }
            
             $$('.history-sort-btn').forEach(btn => {
                 btn.addEventListener('click', (e) => {
                     const key = e.currentTarget.dataset.sort;
                     if (!key) return; // Exit if no sort key
                     let order = 'desc';
                     // Check current sort state safely
                     if (currentSettings.lastSort?.key === key && currentSettings.lastSort?.order === 'desc') {
                         order = 'asc';
                     }
                     currentSettings.lastSort = { key, order };
                     saveSettings(); // Save the new sort preference
                     renderHistoryTable(); // Re-render table with new sort
                 });
             });
            
            // Settings & Data Page
             const importSubjectBtn = $('#import-subject-btn');
             const importBackupBtn = $('#import-backup-btn');
             const exportSubjectBtn = $('#export-subject-btn');
             const exportBackupBtn = $('#export-backup-btn');
             const deleteAllDataBtn = $('#delete-all-data-btn');

             if (importSubjectBtn) importSubjectBtn.addEventListener('click', handleImportSubject);
             if (importBackupBtn) importBackupBtn.addEventListener('click', handleImportBackup);
             if (exportSubjectBtn) exportSubjectBtn.addEventListener('click', handleExportSubject);
             if (exportBackupBtn) exportBackupBtn.addEventListener('click', handleExportBackup);
             if (deleteAllDataBtn) {
                 deleteAllDataBtn.addEventListener('click', () => {
                     showConfirmationModal(
                        'DELETE ALL DATA?',
                        `Are you sure you want to delete all subjects, questions, and history? This is permanent.`, // Removed user reference
                        () => {
                            subjects = [];
                            quizHistory = [];
                            // Keep settings
                            saveSubjects(); // Save empty arrays
                            saveHistory();
                            initAppUI(); // Reinitialize UI to reflect cleared data
                            showPage('page-home'); // Go to home page
                            showToast('All your data has been deleted!', true);
                        }
                    );
                 });
             }
            
            // AI Buttons
             const aiGenerateBtn = $('#ai-generate-question-btn');
             if (aiGenerateBtn) aiGenerateBtn.addEventListener('click', handleAiGenerateQuestion);
            
            // Confirmation Modal Buttons
             const confirmCancelBtn = $('#confirmation-cancel-btn');
             const confirmConfirmBtn = $('#confirmation-confirm-btn');
             if (confirmCancelBtn) confirmCancelBtn.addEventListener('click', closeConfirmationModal);
             if (confirmConfirmBtn) {
                 confirmConfirmBtn.addEventListener('click', () => {
                    if (typeof currentModalCallback === 'function') {
                        try {
                             currentModalCallback();
                        } catch (e) {
                             console.error("Error executing confirmation callback:", e);
                             showToast("An error occurred.", true);
                        }
                    }
                    closeConfirmationModal(); // Always close after attempt
                 });
             }
        }
        
        // --- Gemini API Call (with exponential backoff) ---
        async function callGeminiApi(prompt, maxRetries = 3, isJson = false) {
             // Basic check if fetch is available
             if (typeof fetch === 'undefined') {
                 console.error("Fetch API is not available.");
                 showToast("Cannot connect to AI service.", true);
                 return Promise.reject("Fetch API unavailable");
             }

            let attempt = 0;
            const apiKey = API_KEY; // Remains empty, handled by environment
            // Ensure API_URL is correctly formed even if API_KEY is empty initially
             const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
            };
            
            if (isJson) {
                payload.generationConfig = {
                    responseMimeType: "application/json",
                    // Simple robust schema expecting the structure we need
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "question": { "type": "STRING", description: "The generated quiz question text." },
                            "correct_answer": { "type": "STRING", description: "The single correct answer." },
                            "incorrect_answers": {
                                "type": "ARRAY",
                                description: "Exactly three distinct incorrect answer options.",
                                "items": { "type": "STRING" },
                                "minItems": 3,
                                "maxItems": 3
                            }
                        },
                        required: ["question", "correct_answer", "incorrect_answers"]
                    }
                };
            }

            while (attempt < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    // Handle non-OK responses
                    if (!response.ok) {
                         let errorBody = 'Could not read error response.';
                         try {
                             errorBody = await response.text();
                         } catch (e) { /* Ignore parsing error */ }
                         console.error(`API Error Response (Attempt ${attempt + 1}):`, errorBody);
                        throw new Error(`API Error: ${response.status} ${response.statusText}`);
                    }

                    const result = await response.json();
                    
                    // Validate response structure before accessing parts
                    if (!result || !result.candidates || !Array.isArray(result.candidates) || result.candidates.length === 0 ||
                        !result.candidates[0].content || !result.candidates[0].content.parts || !Array.isArray(result.candidates[0].content.parts) ||
                        result.candidates[0].content.parts.length === 0 || !result.candidates[0].content.parts[0].text)
                    {
                         console.error("Invalid API response structure:", result);
                         throw new Error("Invalid API response structure.");
                    }
                    
                    const text = result.candidates[0].content.parts[0].text;
                    return text; // Success

                } catch (error) {
                    // Log specific error type if possible
                    console.error(`Gemini API call failed (attempt ${attempt + 1}):`, error.message || error);
                    attempt++;
                    if (attempt >= maxRetries) {
                         showToast(`AI service failed after ${maxRetries} attempts.`, true);
                        throw error; // Give up and re-throw
                    }
                    // Exponential backoff: 1s, 2s, 4s...
                    const delay = Math.pow(2, attempt -1) * 1000;
                    // console.log(`Retrying API call in ${delay / 1000}s...`); // Optional: Log retry delay
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            // Should not be reached if maxRetries > 0, but added for safety
             throw new Error("Gemini API call failed after multiple retries.");
        }
        
        // --- AI Features ---
        
        async function handleAiGenerateQuestion() {
            const subjectId = $('#question-subject-id')?.value; // Add null check
            if (!subjectId) {
                showToast('Cannot identify the subject for AI generation.', true);
                return;
            }
            const subject = subjects.find(s => s.id === subjectId);
            if (!subject) {
                showToast('Selected subject not found.', true);
                return;
            }
            
            const btn = $('#ai-generate-question-btn');
             if (!btn) return; // Add null check
            
            // Store original content and disable
            const originalHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<i data-lucide="brain-circuit" class="mr-2 h-5 w-5 ai-spin"></i> Generating...`;
            lucide.createIcons(); // Render the spinner icon

            const prompt = `Generate one new multiple-choice question suitable for a student quiz on the subject "${subject.name || 'this topic'}".
                The question should be clear and unambiguous.
                Provide the question text, one clearly correct answer, and exactly three distinct and plausible incorrect answers.`;

            try {
                const responseJsonString = await callGeminiApi(prompt, 3, true); // Request JSON
                const data = JSON.parse(responseJsonString); // Parse the JSON string response

                // Validate the parsed JSON structure
                if (data && typeof data.question === 'string' && typeof data.correct_answer === 'string' &&
                    Array.isArray(data.incorrect_answers) && data.incorrect_answers.length === 3 &&
                    data.incorrect_answers.every(item => typeof item === 'string'))
                {
                    // Populate form fields safely
                     const qTextInput = $('#question-text-input');
                     const opt1Input = $('#question-option-1');
                     const opt2Input = $('#question-option-2');
                     const opt3Input = $('#question-option-3');
                     const opt4Input = $('#question-option-4');

                     if (qTextInput) qTextInput.value = data.question;
                     if (opt1Input) opt1Input.value = data.correct_answer;
                     if (opt2Input) opt2Input.value = data.incorrect_answers[0];
                     if (opt3Input) opt3Input.value = data.incorrect_answers[1];
                     if (opt4Input) opt4Input.value = data.incorrect_answers[2];
                     
                    showToast('AI question generated!');
                } else {
                     console.error("Invalid JSON structure received from AI:", data);
                    throw new Error('Invalid JSON structure from AI.');
                }

            } catch (error) {
                console.error('Failed to generate AI question:', error);
                showToast('Error generating question. Please try again.', true);
            } finally {
                 // Restore button state
                btn.disabled = false;
                btn.innerHTML = originalHtml; // Restore original HTML (includes icon)
                lucide.createIcons(); // Re-render original icon
            }
        }
        
        async function openAiExplanationModal(question, correctAnswer, userAnswer) {
             const modal = $('#ai-explanation-modal');
             const loadingEl = $('#ai-explanation-loading');
             const contentEl = $('#ai-explanation-content');

             if (!modal || !loadingEl || !contentEl) return; // Ensure elements exist

            openModal('ai-explanation-modal');
            contentEl.classList.add('hidden'); // Hide content area
            loadingEl.classList.remove('hidden'); // Show loading spinner
            contentEl.innerHTML = ''; // Clear previous content

            // Construct a clear prompt for explanation
            const prompt = `Explain simply why "${userAnswer}" is the incorrect answer and "${correctAnswer}" is the correct answer for the following quiz question:
                
                Question: "${question}"
                
                Keep the explanation concise and easy for a student to understand (around 2-4 sentences). Focus on the core reason.`;

            try {
                const explanation = await callGeminiApi(prompt); // Call API for text explanation
                
                 // Basic Markdown to HTML conversion (Bold, Italic, Newlines)
                const htmlExplanation = explanation
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')     // Italic
                    .replace(/`([^`]+)`/g, '<code>$1</code>')   // Inline code
                    .replace(/\n/g, '<br>');                   // Newlines
                
                contentEl.innerHTML = `<p>${htmlExplanation}</p>`; // Set content
            } catch (error) {
                console.error('Failed to get AI explanation:', error);
                contentEl.innerHTML = `<p class="text-red-500 dark:text-red-400">Sorry, an error occurred while generating the explanation. Please try again later.</p>`; // User-friendly error
            } finally {
                // Ensure UI updates correctly regardless of success/failure
                loadingEl.classList.add('hidden'); // Hide loading
                contentEl.classList.remove('hidden'); // Show content (either explanation or error)
            }
        }


        // --- Data Import/Export ---
        
        function handleImportSubject() {
            const fileInput = $('#import-subject-file');
             if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                showToast('Please select a .json file first.', true);
                return;
            }
            const file = fileInput.files[0];
             // Validate file type (basic)
             if (!file.type || file.type !== 'application/json') {
                 showToast('Please select a valid .json file.', true);
                 fileInput.value = ''; // Reset input
                 return;
             }

            const reader = new FileReader();
            
            reader.onload = (e) => {
                try {
                    const subject = JSON.parse(e.target.result);
                    // More robust validation
                    if (subject && typeof subject.id === 'string' && typeof subject.name === 'string' && Array.isArray(subject.questions) &&
                        subject.questions.every(q => q && typeof q.id === 'string' && typeof q.question === 'string' && Array.isArray(q.options) && q.options.length === 4)) 
                    {
                        // Check for duplicate subject ID - If found, assign a new unique ID
                        if (subjects.some(s => s.id === subject.id)) {
                             const originalName = subject.name;
                             subject.id = `sub_${Date.now()}_${Math.random().toString(36).substring(2, 7)}`; 
                             showToast(`Imported subject had duplicate ID. Assigned new ID for "${originalName}".`);
                        }
                        subjects.push(subject);
                        saveSubjects(); // Save updated subjects list
                        showToast(`Subject "${subject.name}" imported successfully!`, false); // Indicate success
                        fileInput.value = ''; // Reset file input
                    } else {
                        throw new Error('Invalid or incomplete subject file format.');
                    }
                } catch (err) {
                     showToast(`Error importing file: ${err.message || 'Invalid JSON format.'}`, true);
                    console.error("Import Error:", err);
                     fileInput.value = ''; // Reset input on error
                }
            };
             reader.onerror = (err) => {
                 showToast('Error reading the selected file.', true);
                 console.error("File Reading Error:", err);
                 fileInput.value = ''; // Reset input on error
             };
            reader.readAsText(file);
        }
        
        function handleImportBackup() {
            const fileInput = $('#import-backup-file');
             if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                showToast('Please select a .json backup file first.', true);
                return;
            }
            const file = fileInput.files[0];
            // Validate file type (basic)
             if (!file.type || file.type !== 'application/json') {
                 showToast('Please select a valid .json file.', true);
                 fileInput.value = ''; // Reset input
                 return;
             }

            const reader = new FileReader();
            
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    // More robust validation for backup structure
                    if (data && Array.isArray(data.subjects) && Array.isArray(data.history) && data.settings &&
                        typeof data.settings.showTimer === 'boolean' && typeof data.settings.lastSort === 'object') 
                    {
                        // Confirmation before overwriting
                        showConfirmationModal(
                            'Import Full Backup?',
                            'This will overwrite all current subjects, quiz history, and settings. Are you sure you want to proceed?',
                            () => {
                                try {
                                    subjects = data.subjects;
                                    quizHistory = data.history;
                                    // Apply imported settings (keep current dark mode)
                                    currentSettings.showTimer = data.settings.showTimer;
                                    currentSettings.lastSort = data.settings.lastSort;
                                    
                                    saveSubjects();
                                    saveHistory();
                                    saveSettings(); // Save the newly imported settings
                                    initAppUI(); // Reload UI completely
                                    showPage('page-home'); // Navigate to home
                                    showToast('Backup imported successfully!');
                                    fileInput.value = ''; // Reset file input
                                } catch (saveError) {
                                     console.error("Error saving imported data:", saveError);
                                     showToast("Error saving imported data. Storage might be full.", true);
                                }
                            }
                        );
                    } else {
                        throw new Error('Invalid backup file format or missing data.');
                    }
                } catch (err) {
                    showToast(`Error importing backup: ${err.message || 'Invalid JSON format.'}`, true);
                    console.error("Backup Import Error:", err);
                    fileInput.value = ''; // Reset input on error
                }
            };
             reader.onerror = (err) => {
                 showToast('Error reading the selected backup file.', true);
                 console.error("File Reading Error:", err);
                 fileInput.value = ''; // Reset input on error
             };
            reader.readAsText(file);
        }
        
        function handleExportSubject() {
             const subjectSelect = $('#export-subject-select');
             if (!subjectSelect) return;
            const subjectId = subjectSelect.value;
             // Check if a subject is actually selected
             if (!subjectId) {
                 showToast('Please select a subject to export.', true);
                 return;
             }
            const subject = subjects.find(s => s.id === subjectId);
            if (!subject) {
                showToast('Selected subject not found.', true); // Should not happen if select is updated
                return;
            }
            
            try {
                const dataStr = JSON.stringify(subject, null, 2); // Pretty print JSON
                const dataBlob = new Blob([dataStr], {type: "application/json;charset=utf-8"});
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                 // Sanitize filename
                 const fileName = (subject.name || 'subject').toLowerCase().replace(/[^a-z0-9]+/g, '_');
                link.download = `${fileName}_subject.json`;
                
                 // Trigger download
                document.body.appendChild(link); // Required for Firefox
                link.click();
                document.body.removeChild(link); // Clean up
                
                URL.revokeObjectURL(url); // Release object URL
                showToast(`Exporting "${subject.name}"...`);
             } catch (e) {
                 console.error("Error during export:", e);
                 showToast("Failed to export subject.", true);
             }
        }
        
        function handleExportBackup() {
             // Check if there is any data to back up
             if (subjects.length === 0 && quizHistory.length === 0) {
                 showToast('No data to export.', true);
                 return;
             }

            const backupData = {
                subjects: subjects,
                history: quizHistory,
                settings: { // Only include relevant settings
                    showTimer: currentSettings.showTimer,
                    lastSort: currentSettings.lastSort
                },
                exportDate: new Date().toISOString(),
                 version: "1.1" // Add a version number for future compatibility
            };
            
            try {
                const dataStr = JSON.stringify(backupData, null, 2);
                const dataBlob = new Blob([dataStr], {type: "application/json;charset=utf-8"});
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                const timestamp = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
                link.download = `study_helper_backup_${timestamp}.json`; // Simplified filename

                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                URL.revokeObjectURL(url);
                showToast('Exporting full backup...');
             } catch (e) {
                 console.error("Error during backup export:", e);
                 showToast("Failed to export backup.", true);
             }
        }


        // --- UI Utilities ---
        
        function applyDarkMode(save = true) {
             const htmlElement = document.documentElement;
             const toggleButton = $('#dark-mode-toggle');
             const toggleSpan = toggleButton?.querySelector('span');

            if (currentSettings.darkMode) {
                htmlElement.classList.add('dark');
                 if (toggleButton && toggleSpan) {
                     toggleButton.classList.add('bg-indigo-600');
                     toggleButton.classList.remove('bg-slate-300');
                     toggleSpan.classList.add('translate-x-6');
                     toggleSpan.classList.remove('translate-x-1');
                 }
            } else {
                htmlElement.classList.remove('dark');
                 if (toggleButton && toggleSpan) {
                     toggleButton.classList.remove('bg-indigo-600');
                     toggleButton.classList.add('bg-slate-300');
                     toggleSpan.classList.remove('translate-x-6');
                     toggleSpan.classList.add('translate-x-1');
                 }
            }
             // Update toast style based on mode
             $('#toast')?.classList.toggle('dark-toast', currentSettings.darkMode);

             if (save) {
                saveSettings(); // Save the setting if requested
             }
        }
        
        function openModal(modalId) {
            const modal = $(`#${modalId}`);
            if (!modal) {
                 console.warn(`Modal with ID "${modalId}" not found.`);
                 return;
            }
            modal.classList.remove('hidden');
            // Use requestAnimationFrame for smoother transition start
            requestAnimationFrame(() => {
                 modal.classList.remove('opacity-0');
                 const modalContent = modal.querySelector('.modal-content');
                 if (modalContent) {
                     modalContent.classList.remove('opacity-0', 'translate-y-4');
                 }
            });
        }

        function closeModal(modalId) {
             const modal = $(`#${modalId}`);
            if (!modal || modal.classList.contains('hidden')) return; // Exit if not found or already hidden
            
            modal.classList.add('opacity-0');
            const modalContent = modal.querySelector('.modal-content');
            if (modalContent) {
                modalContent.classList.add('opacity-0', 'translate-y-4');
            }
            // Wait for transition to finish before hiding
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300); // Match transition duration
        }
        
        function showConfirmationModal(title, message, onConfirm) {
             const titleEl = $('#confirmation-title');
             const messageEl = $('#confirmation-message');
             
             if (titleEl) titleEl.textContent = title || 'Are you sure?'; // Provide default title
             if (messageEl) messageEl.textContent = message || 'This action cannot be undone.'; // Default message
             
            currentModalCallback = typeof onConfirm === 'function' ? onConfirm : null; // Ensure it's a function
            openModal('confirmation-modal');
        }
        
        function closeConfirmationModal() {
            closeModal('confirmation-modal');
            currentModalCallback = null; // Clear callback when closing
        }

        function showToast(message, isError = false) {
            const toast = $('#toast');
             if (!toast) return; // Exit if toast element not found

            const icon = toast.querySelector('i');
            const messageSpan = $('#toast-message');
            
             if (messageSpan) messageSpan.textContent = message || (isError ? 'An error occurred.' : 'Success!');
            
            toast.classList.remove('bg-red-600', 'dark:bg-red-700', 'bg-slate-700', 'dark:bg-slate-200', 'dark-toast'); // Clear previous styles

            if (isError) {
                toast.classList.add('bg-red-600', 'dark:bg-red-700', 'text-white'); // Error style
                 if (icon) icon.setAttribute('data-lucide', 'alert-circle');
            } else {
                 // Use different colors for light/dark success toast for better visibility
                 if (currentSettings.darkMode) {
                      toast.classList.add('bg-slate-200', 'text-slate-900', 'dark-toast'); // Light toast on dark bg
                 } else {
                      toast.classList.add('bg-slate-700', 'text-white'); // Dark toast on light bg
                 }
                 if (icon) icon.setAttribute('data-lucide', 'check-circle');
            }
            lucide.createIcons(); // Re-render icon
            
            // Show toast animation
            toast.classList.add('show');
            // Set timeout to hide toast
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // --- Utility Functions ---
        function shuffleArray(array) {
            // Fisher-Yates shuffle algorithm
            let currentIndex = array.length, randomIndex;
            while (currentIndex !== 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

    </script>
</body>
</html>

